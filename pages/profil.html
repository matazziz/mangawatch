<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MangaWatch - Profil</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Garamond:wght@400;500;600;700&family=Times+New+Roman:wght@400;700&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/header-unified-new.css">
    <link rel="stylesheet" href="/css/profile.css">
    <link rel="stylesheet" href="/css/footer-unified.css">
    <link rel="stylesheet" href="/css/anime-card.css">
    <link rel="stylesheet" href="/css/messaging.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Import Firebase Service pour les bannières -->
    <script type="module">
        import { bannerService, profileSettingsService, profileAccountService } from '/js/firebase-service.js';
        window.bannerService = bannerService;
        window.profileSettingsService = profileSettingsService;
        window.profileAccountService = profileAccountService;
    </script>
    
    <!-- Script pour charger l'avatar immédiatement et éviter le flash -->
    <script>
        (function() {
            // Charger l'avatar avant que la page ne s'affiche
            try {
                const user = JSON.parse(localStorage.getItem('user') || 'null');
                if (user && user.email) {
                    const avatarKey = 'avatar_' + user.email;
                    let avatarUrl = null;
                    
                    // Prioriser l'avatar personnalisé (le plus récent)
                    if (user.customAvatar) {
                        avatarUrl = user.customAvatar;
                    } else if (user.avatar) {
                        avatarUrl = user.avatar;
                    } else if (user.originalAvatar) {
                        avatarUrl = user.originalAvatar;
                    } else if (user.picture) {
                        avatarUrl = user.picture;
                    } else {
                        // En dernier recours, vérifier le localStorage
                        const storedAvatar = localStorage.getItem(avatarKey);
                        if (storedAvatar) {
                            avatarUrl = storedAvatar;
                        }
                    }
                    
                    // Si on a trouvé un avatar, le précharger et mettre à jour le src par défaut
                    if (avatarUrl && avatarUrl !== '') {
                        // Précharger l'image
                        const img = new Image();
                        img.src = avatarUrl;
                        
                        // Mettre à jour le src de l'image dans le DOM dès qu'il est disponible
                        function updateAvatarSrc() {
                            const avatarElement = document.getElementById('user-avatar');
                            if (avatarElement) {
                                avatarElement.src = avatarUrl;
                            } else {
                                // Si l'élément n'existe pas encore, réessayer
                                setTimeout(updateAvatarSrc, 10);
                            }
                        }
                        
                        // Démarrer la mise à jour immédiatement
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', updateAvatarSrc);
                        } else {
                            updateAvatarSrc();
                        }
                    }
                }
            } catch (e) {
                console.error('Erreur lors du préchargement de l\'avatar:', e);
            }
        })();
    </script>
    
    <script src="/js/localization.js"></script>
    <style>
        body {
            background-color: #181a20;
            color: #f5f6fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }
        
        .profile-container {
            max-width: 2000px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #23262f;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .banner-edit-menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(35, 38, 47, 0.98);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(0, 184, 148, 0.3);
            border-radius: 16px;
            padding: 2rem;
            display: none;
            flex-direction: column;
            gap: 1rem;
            min-width: 350px;
            max-width: 90vw;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 10000;
        }
        
        .banner-edit-menu.active {
            display: flex;
        }
        
        .banner-edit-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            z-index: 9999;
        }
        
        .banner-edit-menu-overlay.active {
            display: block;
        }
        
        .banner-edit-menu h3 {
            margin: 0 0 1rem 0;
            color: #f5f6fa;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .banner-edit-menu h3::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #00b894 0%, #00d4aa 100%);
            border-radius: 2px;
        }
        
        .banner-edit-option {
            background: rgba(0, 184, 148, 0.1);
            border: 1px solid rgba(0, 184, 148, 0.3);
            color: #f5f6fa;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .banner-edit-option:hover {
            background: rgba(0, 184, 148, 0.2);
            border-color: #00b894;
            transform: translateX(4px);
        }
        
        .banner-edit-option i {
            color: #00b894;
            font-size: 1.1rem;
        }
        
        .banner-file-input {
            position: absolute;
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            z-index: -1;
        }
        
        .banner-volume-control {
            margin: 0.5rem 0;
            padding: 0;
            width: 100%;
        }
        
        .banner-volume-control .volume-control-compact {
            width: 100%;
        }
        
        .banner-remove-btn {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }
        
        .banner-remove-btn:hover {
            background: rgba(255, 107, 107, 0.2);
            border-color: #ff6b6b;
        }
        
        .banner-remove-btn i {
            color: #ff6b6b;
        }
        
        /* Contrôle de volume compact et classe */
        .volume-control-compact {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            margin-top: 0.5rem;
            padding: 0.25rem 0.3rem;
            background: linear-gradient(135deg, rgba(0, 184, 148, 0.1) 0%, rgba(0, 212, 170, 0.08) 100%);
            border: 1.5px solid rgba(0, 184, 148, 0.25);
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: visible;
        }
        
        .volume-value-compact {
            margin-left: 0.5rem;
        }
        
        .volume-control-compact::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(180deg, #00b894 0%, #00d4aa 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .volume-control-compact:hover {
            background: linear-gradient(135deg, rgba(0, 184, 148, 0.15) 0%, rgba(0, 212, 170, 0.12) 100%);
            border-color: rgba(0, 184, 148, 0.4);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 184, 148, 0.2);
        }
        
        .volume-control-compact:hover::before {
            opacity: 1;
        }
        
        .volume-icon-btn {
            background: transparent;
            border: none;
            color: #00b894;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s ease;
            width: 26px;
            height: 26px;
            flex-shrink: 0;
            font-size: 0.8rem;
        }
        
        .volume-icon-btn:hover {
            background: rgba(0, 184, 148, 0.2);
            transform: scale(1.15);
            color: #00d4aa;
        }
        
        .volume-icon-btn:active {
            transform: scale(0.9);
        }
        
        .volume-slider-compact {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.08);
            outline: none;
            cursor: pointer;
            accent-color: #00b894;
            transition: all 0.3s ease;
            margin: 0;
            padding: 0;
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
        }
        
        .volume-slider-compact:hover {
            accent-color: #00d4aa;
        }
        
        .volume-slider-compact::-webkit-slider-thumb {
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00b894 0%, #00d4aa 100%);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 184, 148, 0.5);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.3);
            margin-top: -4px;
            position: relative;
        }
        
        .volume-slider-compact::-webkit-slider-thumb:hover {
            background: linear-gradient(135deg, #00d4aa 0%, #00e6c4 100%);
            transform: scale(1.3);
            box-shadow: 0 3px 10px rgba(0, 184, 148, 0.7);
        }
        
        .volume-slider-compact::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00b894 0%, #00d4aa 100%);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 6px rgba(0, 184, 148, 0.5);
            transition: all 0.3s ease;
        }
        
        .volume-slider-compact::-moz-range-thumb:hover {
            background: linear-gradient(135deg, #00d4aa 0%, #00e6c4 100%);
            transform: scale(1.3);
            box-shadow: 0 3px 10px rgba(0, 184, 148, 0.7);
        }
        
        .volume-slider-compact::-webkit-slider-runnable-track {
            height: 4px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 2px;
            width: 100%;
        }
        
        .volume-slider-compact::-moz-range-track {
            height: 4px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 2px;
            width: 100%;
        }
        
        .volume-slider-compact::-moz-range-progress {
            height: 4px;
            background: linear-gradient(90deg, #00b894 0%, #00d4aa 100%);
            border-radius: 2px;
        }
        
        .volume-value-compact {
            color: #00b894;
            font-weight: 700;
            font-size: 0.75rem;
            min-width: 30px;
            text-align: right;
            flex-shrink: 0;
            letter-spacing: 0.2px;
        }
        
        .profile-header {
            position: relative;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 2rem;
            margin-top: 0.75rem;
            margin-bottom: 2rem;
            padding: 2rem;
            border-radius: 12px;
            overflow: hidden;
            min-height: 410px;
            border-bottom: 1px solid #2f3542;
        }
        
        .profile-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1a1d29 0%, #2a2d3a 100%);
            z-index: 0;
        }
        
        .profile-header-banner {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            object-fit: cover;
            width: 100%;
            height: 100%;
            display: none;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: high-quality;
        }
        
        .profile-header-banner img,
        .profile-header-banner video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: high-quality;
        }
        
        .profile-header-banner.active {
            display: block;
        }
        
        .profile-header-banner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.3) 0%, rgba(0, 0, 0, 0.6) 100%);
            z-index: 2;
        }
        
        .profile-header-content {
            position: relative;
            z-index: 3;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 2rem;
            width: 100%;
        }
        
        .profile-follow-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 1rem;
            margin-left: auto;
        }
        
        .profile-avatar-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .profile-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #00b894;
            transition: transform 0.3s;
            position: relative;
            z-index: 4;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            display: block;
        }
        
        .profile-avatar:hover {
            transform: scale(1.05);
        }
        
        .profile-info {
            position: relative;
            z-index: 4;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .profile-info h1 {
            margin: 0;
            color: #f5f6fa;
            font-size: 3rem;
            font-weight: 700;
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            letter-spacing: 0.5px;
            text-shadow: 2px 2px 12px rgba(0, 0, 0, 0.9), 0 0 20px rgba(0, 184, 148, 0.3);
            margin-bottom: 0.75rem;
            line-height: 1.2;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
        }
        
        .profile-info h1 #user-name-text {
            line-height: 1;
        }
        
        /* Badge certifié - même couleur que la barre de recherche (vert du site) */
        .verified-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.8rem;
            height: 1.8rem;
            background: linear-gradient(135deg, #00a84d 0%, #00c45d 100%);
            border-radius: 50%;
            color: #ffffff;
            font-size: 0.9rem;
            font-weight: 900;
            box-shadow: 0 2px 10px rgba(0, 168, 77, 0.5), 
                        0 0 20px rgba(0, 168, 77, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            position: relative;
            z-index: 5;
            margin-left: 0;
            align-self: center;
            transform: translateY(0.22em);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .verified-badge::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .verified-badge:hover {
            transform: scale(1.12) translateY(0.22em);
            box-shadow: 0 4px 16px rgba(0, 168, 77, 0.7), 
                        0 0 30px rgba(0, 168, 77, 0.5),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }
        
        .verified-badge:hover::before {
            opacity: 1;
        }
        
        .verified-badge i {
            font-size: 0.85rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
        }
        
        /* Badge du pays dans la bannière */
        .profile-continent-badge, .profile-country-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.9rem;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 20px;
            color: #f5f6fa;
            font-size: 0.85rem;
            font-weight: 500;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.6);
            transition: all 0.3s ease;
            width: fit-content;
        }
        
        .profile-continent-badge:hover, .profile-country-badge:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.35);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .profile-continent-badge i, .profile-country-badge i {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        /* Bloc pays (paramètres) : barre de recherche + menu déroulant — style classe */
        .country-picker-profile {
            width: 100%;
            margin-bottom: 0.75rem;
        }
        .country-picker-profile .country-search-input {
            width: 100%;
            margin-bottom: 10px;
            padding: 12px 16px 12px 42px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.06);
            color: #f5f6fa;
            font-size: 14px;
            font-weight: 500;
            box-sizing: border-box;
            transition: all 0.25s ease;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.12);
            letter-spacing: 0.2px;
        }
        .country-picker-profile .country-search-input::placeholder {
            color: rgba(255,255,255,0.45);
        }
        .country-picker-profile .country-search-input:focus {
            outline: none;
            border-color: rgba(0, 224, 109, 0.5);
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.15), 0 0 0 2px rgba(0, 196, 93, 0.15);
            background: rgba(255,255,255,0.08);
        }
        .country-picker-profile #country-select-edit {
            width: 100%;
            padding: 12px 42px 12px 16px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.06);
            color: #f5f6fa;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            box-sizing: border-box;
            transition: all 0.25s ease;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.12);
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300e06d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 16px;
        }
        .country-picker-profile #country-select-edit:focus {
            outline: none;
            border-color: rgba(0, 224, 109, 0.5);
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.15), 0 0 0 2px rgba(0, 196, 93, 0.15);
            background-color: rgba(255,255,255,0.08);
        }
        .country-picker-profile #country-select-edit option {
            background: #1e1e1e;
            color: #f5f6fa;
            padding: 10px 14px;
        }
        .country-search-wrap-profile {
            position: relative;
            margin-bottom: 10px;
        }
        .country-search-wrap-profile::before {
            content: "\f002";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(0, 224, 109, 0.7);
            font-size: 13px;
            pointer-events: none;
        }
        
        /* Système d'abonnements */
        .profile-follow-stats {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .follow-stat-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .follow-stat-item:hover {
            transform: translateY(-2px);
        }
        
        .follow-stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f5f6fa;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
            line-height: 1.2;
        }
        
        .follow-stat-label {
            font-size: 0.85rem;
            color: rgba(245, 246, 250, 0.8);
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.6);
            font-weight: 500;
            margin-top: 0.2rem;
        }
        
        .profile-follow-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.5rem;
            background: linear-gradient(135deg, #00b894 0%, #00d4aa 100%);
            border: none;
            border-radius: 25px;
            color: #fff;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            margin-top: 0.5rem;
        }
        
        .profile-follow-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 184, 148, 0.5);
            background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
        }
        
        .profile-follow-btn:active {
            transform: translateY(0);
        }
        
        .profile-follow-btn.following {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #f5f6fa;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .profile-follow-btn.following:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .profile-follow-btn i {
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .profile-follow-section {
                width: 100%;
                align-items: flex-start;
            }
            
            .profile-follow-stats {
                gap: 1rem;
            }
            
            .follow-stat-number {
                font-size: 1.3rem;
            }
            
            .follow-stat-label {
                font-size: 0.8rem;
            }
            
            .profile-follow-btn {
                padding: 0.5rem 1.2rem;
                font-size: 0.9rem;
            }
        }
        
        /* Popup modal pour les abonnés/abonnements */
        .follow-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            z-index: 10000;
        }
        
        .follow-modal-overlay.active {
            display: block;
        }
        
        .follow-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #23262f;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            display: none;
            flex-direction: column;
            z-index: 10001;
            border: 2px solid rgba(0, 184, 148, 0.3);
        }
        
        .follow-modal.active {
            display: flex;
        }
        
        .follow-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .follow-modal-header h3 {
            margin: 0;
            color: #f5f6fa;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .follow-modal-close {
            background: transparent;
            border: none;
            color: #f5f6fa;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.2s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .follow-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .follow-modal-content {
            padding: 1.5rem;
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            max-height: calc(85vh - 80px);
        }
        
        .follow-modal-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .follow-modal-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .follow-modal-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #00b894 0%, #00d4aa 100%);
            border-radius: 10px;
        }
        
        .follow-modal-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
        }
        
        .follow-list-item {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            padding: 1.25rem;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 1rem;
            transition: all 0.2s;
        }
        
        .follow-list-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .follow-list-item-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #00b894;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 2px 8px rgba(0, 184, 148, 0.3);
        }
        
        .follow-list-item-avatar:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 12px rgba(0, 184, 148, 0.5);
        }
        
        .follow-list-item-info {
            flex: 1;
            min-width: 0;
            cursor: pointer;
            padding-left: 0.5rem;
        }
        
        .follow-list-item-name {
            color: #f5f6fa;
            font-weight: 600;
            font-size: 1.15rem;
            margin-bottom: 0.35rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .follow-list-item-email {
            color: rgba(245, 246, 250, 0.6);
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .follow-list-item-action {
            flex-shrink: 0;
        }
        
        .follow-list-item-btn {
            padding: 0.65rem 1.25rem;
            border: none;
            border-radius: 22px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            min-width: 120px;
        }
        
        .follow-list-item-btn.follow {
            background: linear-gradient(135deg, #00b894 0%, #00d4aa 100%);
            color: #fff;
        }
        
        .follow-list-item-btn.follow:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 184, 148, 0.4);
        }
        
        .follow-list-item-btn.following {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #f5f6fa;
        }
        
        .follow-list-item-btn.following:hover {
            background: rgba(255, 0, 0, 0.2);
            border-color: rgba(255, 0, 0, 0.4);
            color: #ff6b6b;
        }
        
        .follow-list-empty {
            text-align: center;
            padding: 3rem 1rem;
            color: rgba(245, 246, 250, 0.6);
        }
        
        .follow-list-empty i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Description du profil dans la bannière */
        .profile-description-wrapper {
            position: absolute;
            bottom: 1.5rem;
            left: 2rem;
            width: calc(100% - 4rem);
            max-width: 600px;
            z-index: 4;
            pointer-events: none;
        }
        
        .profile-description-wrapper > * {
            pointer-events: auto;
        }
        
        @media (max-width: 768px) {
            .profile-description-wrapper {
                left: 1rem;
                right: 1rem;
                bottom: 1rem;
            }
        }
        
        .profile-description {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #f5f6fa;
            font-size: 0.9rem;
            font-weight: 400;
            font-style: italic;
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            letter-spacing: 0.2px;
            line-height: 1.5;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.5);
            transition: none;
            min-height: 50px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .profile-description.empty {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            opacity: 0.5;
        }
        
        .profile-description.empty:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
            opacity: 0.7;
        }
        
        .profile-description.empty #profile-description-text {
            opacity: 0.6;
            font-style: italic;
        }
        
        .profile-description:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.25);
        }
        
        .profile-description #profile-description-text {
            flex: 1;
            word-wrap: break-word;
            white-space: pre-wrap;
            font-style: italic;
        }
        
        .profile-description-edit-btn {
            background: transparent;
            border: none;
            color: #00b894;
            cursor: pointer;
            padding: 0.3rem 0.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            opacity: 0.85;
            flex-shrink: 0;
        }
        
        .profile-description-edit-btn:hover {
            opacity: 1;
            background: rgba(0, 184, 148, 0.2);
            transform: scale(1.1);
        }
        
        .profile-description-edit {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .profile-description-edit textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: #f5f6fa;
            font-size: 0.9rem;
            font-weight: 400;
            font-style: italic;
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            letter-spacing: 0.2px;
            line-height: 1.5;
            resize: vertical;
            outline: none;
            transition: none;
            box-sizing: border-box;
        }
        
        .profile-description-edit textarea:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(0, 184, 148, 0.5);
            box-shadow: 0 0 0 3px rgba(0, 184, 148, 0.1);
        }
        
        .profile-description-edit textarea::placeholder {
            color: rgba(245, 246, 250, 0.5);
        }
        
        .profile-description-char-count {
            font-size: 0.75rem;
            color: rgba(245, 246, 250, 0.7);
            text-align: right;
            margin-top: -0.5rem;
        }
        
        .profile-description-char-count.warning {
            color: #ffa502;
        }
        
        .profile-description-char-count.error {
            color: #ff6b6b;
        }
        
        .profile-description-edit-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        
        .profile-description-save-btn,
        .profile-description-cancel-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .profile-description-save-btn {
            background: linear-gradient(135deg, #00b894 0%, #00d4aa 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
        }
        
        .profile-description-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 184, 148, 0.4);
        }
        
        .profile-description-cancel-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #f5f6fa;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .profile-description-cancel-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        

        
        .profile-actions {
            margin-left: auto;
            display: flex;
            gap: 1rem;
        }
        
        .edit-btn, .logout-btn {
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }
        
        .edit-btn {
            background-color: #00b894;
            color: white;
        }
        
        .logout-btn {
            background-color: transparent;
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }
        
        .edit-btn:hover {
            background-color: #00a884;
            transform: translateY(-2px);
        }
        
        .logout-btn:hover {
            background-color: rgba(255, 107, 107, 0.1);
            transform: translateY(-2px);
        }
        
        .profile-tabs {
            display: flex;
            border-bottom: 1px solid #2f3542;
            margin-bottom: 2rem;
        }
        
        .profile-tab {
            padding: 1rem 2rem;
            cursor: pointer;
            color: #a5b1c2;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .profile-tab.active {
            color: #00b894;
            border-bottom-color: #00b894;
            font-weight: 600;
        }
        
        .profile-tab:hover:not(.active) {
            color: #f5f6fa;
        }
        
        .profile-section {
            display: none;
            animation: fadeIn 0.3s ease;
            min-height: 600px;
            padding: 2rem 0;
            width: 100%;
            max-width: 100%;
        }
        
        .profile-section.active {
            display: block;
        }
        
        #reviews-section,
        #tierlist-section {
            width: 100%;
            max-width: 100%;
        }
        
        #settings-section {
            width: 100%;
            max-width: 100%;
        }
        
        .profile-container.settings-active {
            max-width: 1075px;
            width: 100%;
            margin: 2rem auto;
            padding: 2rem 1.5rem;
        }
        
        /* Styles modernes pour la section Paramètres */
        #settings-section h2 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #f5f6fa;
            margin-bottom: 2.5rem;
            background: linear-gradient(135deg, #00b894 0%, #00d4aa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .profile-item {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border-radius: 20px;
            padding: 2.5rem;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .profile-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #00b894 0%, #00d4aa 100%);
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }
        
        .profile-item:hover::before {
            transform: scaleX(1);
        }
        
        .profile-item:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 48px rgba(0, 184, 148, 0.2);
            border-color: rgba(0, 184, 148, 0.3);
        }
        
        .profile-item h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #f5f6fa;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .profile-item h3::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #00b894 0%, #00d4aa 100%);
            border-radius: 2px;
        }
        
        .setting-item {
            margin-bottom: 2rem;
        }
        
        .setting-item:last-child {
            margin-bottom: 0;
        }
        
        .setting-item label {
            display: block;
            color: #a5b1c2;
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .setting-item select,
        .setting-item input {
            width: 100%;
            padding: 1rem 1.25rem;
            background: rgba(255,255,255,0.08);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: #f5f6fa;
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
        }
        
        .setting-item select:focus,
        .setting-item input:focus {
            border-color: #00b894;
            background: rgba(255,255,255,0.12);
            box-shadow: 0 0 0 4px rgba(0, 184, 148, 0.1);
        }
        
        .setting-item select:hover {
            border-color: rgba(0, 184, 148, 0.5);
        }
        
        /* Toggle switch pour la confidentialité */
        .privacy-toggle-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
            margin-top: 0.75rem;
            padding: 1rem 1.25rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .privacy-toggle-wrapper:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(0, 184, 148, 0.3);
        }
        
        .privacy-toggle-description {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .privacy-toggle-description > span:first-child {
            color: #f5f6fa;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .privacy-toggle-hint {
            color: rgba(245, 246, 250, 0.6);
            font-size: 0.85rem;
            font-weight: normal;
        }
        
        .privacy-toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 32px;
            flex-shrink: 0;
        }
        
        .privacy-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .privacy-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: 0.3s;
            border-radius: 32px;
        }
        
        .privacy-toggle-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 4px;
            bottom: 4px;
            background-color: #f5f6fa;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .privacy-toggle-switch input:checked + .privacy-toggle-slider {
            background: linear-gradient(135deg, #00b894 0%, #00d4aa 100%);
        }
        
        .privacy-toggle-switch input:checked + .privacy-toggle-slider:before {
            transform: translateX(28px);
        }
        
        .privacy-toggle-switch input:focus + .privacy-toggle-slider {
            box-shadow: 0 0 0 4px rgba(0, 184, 148, 0.2);
        }
        
        @media (max-width: 768px) {
            .privacy-toggle-wrapper {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .privacy-toggle-switch {
                align-self: flex-end;
            }
        }
        
        .settings-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border-radius: 20px;
            padding: 2.5rem;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            margin-top: 2rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        .settings-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0, 184, 148, 0.15);
        }
        
        .settings-card h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #f5f6fa;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .settings-card h3::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #00b894 0%, #00d4aa 100%);
            border-radius: 2px;
        }
        
        .settings-card input[readonly] {
            background: rgba(255,255,255,0.06);
            border: 2px solid rgba(255,255,255,0.1);
            cursor: not-allowed;
            color: #a5b1c2;
        }
        
        .settings-card label {
            color: #a5b1c2;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .account-actions {
            display: flex;
            gap: 1.25rem;
            flex-wrap: wrap;
        }
        
        .account-actions .edit-btn,
        .account-actions .logout-btn {
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .account-actions .edit-btn {
            background: linear-gradient(135deg, #00b894 0%, #00d4aa 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
        }
        
        .account-actions .edit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 184, 148, 0.4);
        }
        
        .account-actions .edit-btn:active {
            transform: translateY(-1px);
        }
        
        .setting-item .edit-btn {
            justify-content: center;
            padding: 0.9rem 6rem;
            font-size: 1.15rem;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: none;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #00b894 0%, #00d4aa 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 184, 148, 0.25);
            border-radius: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .setting-item .edit-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .setting-item .edit-btn:hover::before {
            left: 100%;
        }
        
        .setting-item .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 184, 148, 0.35);
            background: linear-gradient(135deg, #00d4aa 0%, #00e6c4 100%);
        }
        
        .setting-item .edit-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 184, 148, 0.3);
        }
        
        .setting-item .edit-btn i {
            margin-right: 0.5rem;
            font-size: 1rem;
        }
        
        .account-actions .logout-btn {
            background: transparent;
            color: #ff6b6b;
            border: 2px solid #ff6b6b;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.2);
        }
        
        .account-actions .logout-btn:hover {
            background: rgba(255, 107, 107, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }
        
        .account-actions .logout-btn:active {
            transform: translateY(-1px);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .info-item {
            background: linear-gradient(135deg, rgba(0, 184, 148, 0.08) 0%, rgba(0, 184, 148, 0.03) 100%);
            border: 1.5px solid rgba(0, 184, 148, 0.15);
            border-radius: 16px;
            padding: 1.25rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            min-width: 0;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .info-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #00b894 0%, #00d4aa 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .info-item:hover {
            transform: translateY(-2px);
            border-color: rgba(0, 184, 148, 0.3);
            box-shadow: 0 8px 24px rgba(0, 184, 148, 0.15);
        }
        
        .info-item:hover::before {
            opacity: 1;
        }
        
        .info-item label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #00b894;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        
        .info-item label i {
            font-size: 1rem;
            color: #00d4aa;
        }
        
        .info-item input {
            width: 100%;
            max-width: 100%;
            padding: 0.9rem 1.2rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            color: #f5f6fa;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            outline: none;
            box-sizing: border-box;
        }
        
        .info-item input[readonly] {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(255, 255, 255, 0.08);
            cursor: default;
            color: #e0e6ed;
        }
        
        .info-item input:focus {
            border-color: rgba(0, 184, 148, 0.4);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(0, 184, 148, 0.1);
        }
        
        .password-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .password-wrapper input {
            flex: 1;
            min-width: 0;
            max-width: 100%;
            padding-right: 3.5rem;
            box-sizing: border-box;
        }
        
        .password-toggle-btn {
            position: absolute;
            right: 0.75rem;
            background: transparent;
            border: none;
            color: #00b894;
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border-radius: 8px;
            width: 36px;
            height: 36px;
        }
        
        .password-toggle-btn:hover {
            background: rgba(0, 184, 148, 0.15);
            color: #00d4aa;
            transform: scale(1.1);
        }
        
        .password-toggle-btn:active {
            transform: scale(0.95);
        }
        
        .email-wrapper {
            position: relative;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .email-wrapper input {
            width: 100%;
            max-width: 100%;
            padding-right: 3.5rem;
            box-sizing: border-box;
        }
        
        .email-masked {
            filter: blur(3px);
            user-select: none;
            letter-spacing: 0.1em;
        }
        
        .email-reveal-btn {
            position: absolute;
            right: 3rem;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #00b894;
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            font-size: 0.9rem;
            z-index: 2;
        }
        
        .email-reveal-btn:hover {
            background: rgba(0, 184, 148, 0.15);
            color: #00d4aa;
            transform: translateY(-50%) scale(1.1);
        }
        
        .email-reveal-btn:active {
            transform: translateY(-50%) scale(0.95);
        }
        
        .info-edit-wrapper .email-reveal-btn {
            right: 3rem;
        }
        
        .info-edit-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .info-edit-btn {
            position: absolute;
            right: 0.75rem;
            background: transparent;
            border: none;
            color: #00b894;
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border-radius: 8px;
            width: 36px;
            height: 36px;
            font-size: 0.9rem;
            z-index: 2;
        }
        
        .info-edit-btn:hover {
            background: rgba(0, 184, 148, 0.15);
            color: #00d4aa;
            transform: scale(1.1);
        }
        
        .info-edit-btn:active {
            transform: scale(0.95);
        }
        
        .info-edit-wrapper input[readonly] {
            padding-right: 7rem;
        }
        
        .info-edit-wrapper input:not([readonly]) {
            padding-right: 1.2rem;
        }
        
        .info-edit-wrapper .email-reveal-btn {
            right: 3rem;
        }
        
        .info-edit-wrapper .info-edit-btn {
            right: 0.75rem;
        }
        
        .info-save-btn,
        .info-cancel-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        
        .info-save-btn {
            background: linear-gradient(135deg, #00b894 0%, #00d4aa 100%);
            color: white;
        }
        
        .info-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 184, 148, 0.3);
        }
        
        .info-cancel-btn {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }
        
        .info-cancel-btn:hover {
            background: rgba(255, 107, 107, 0.3);
        }
        
        /* Boutons pays : Enregistrer / Annuler très compacts */
        #country-edit-actions .info-save-btn,
        #country-edit-actions .info-cancel-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            margin-top: 0.35rem;
        }
        
        .info-edit-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .info-item select {
            width: 100%;
            max-width: 100%;
            padding: 0.9rem 1.2rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            color: #f5f6fa;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            outline: none;
            box-sizing: border-box;
            cursor: pointer;
        }
        
        .info-item select:focus {
            border-color: rgba(0, 184, 148, 0.4);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(0, 184, 148, 0.1);
        }
        
        .info-item select:hover {
            border-color: rgba(0, 184, 148, 0.3);
        }
        
        /* Système de notifications toast */
        .toast-container {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            pointer-events: none;
        }
        
        .toast {
            background: linear-gradient(135deg, rgba(0, 184, 148, 0.95) 0%, rgba(0, 212, 170, 0.95) 100%);
            color: white;
            padding: 1.25rem 1.75rem;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 184, 148, 0.4);
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 320px;
            max-width: 450px;
            pointer-events: auto;
            animation: toastSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .toast.error {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.95) 0%, rgba(255, 82, 82, 0.95) 100%);
            box-shadow: 0 8px 32px rgba(255, 107, 107, 0.4);
        }
        
        .toast-icon {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .toast-title {
            font-weight: 600;
            font-size: 1rem;
            margin: 0;
        }
        
        .toast-message {
            font-size: 0.9rem;
            opacity: 0.95;
            margin: 0;
        }
        
        .toast-close {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
            opacity: 0.8;
            flex-shrink: 0;
        }
        
        .toast-close:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.2);
        }
        
        @keyframes toastSlideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes toastSlideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        .toast.slide-out {
            animation: toastSlideOut 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        @media (max-width: 768px) {
            .toast-container {
                top: 1rem;
                right: 1rem;
                left: 1rem;
            }
            
            .toast {
                min-width: auto;
                max-width: 100%;
            }
        }
        
        .username-info-tooltip {
            color: #00b894;
            margin-left: 0.5rem;
            cursor: help;
            font-size: 0.9rem;
            position: relative;
        }
        
        .username-info-tooltip:hover {
            color: #00d4aa;
        }
        
        .username-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .info-item .username-input {
            flex: 1;
            padding: 0.9rem 1.2rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            color: #f5f6fa;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .info-item .username-input:not([readonly]) {
            border-color: rgba(0, 184, 148, 0.4);
            background: rgba(255, 255, 255, 0.08);
        }
        
        .info-item .username-input:focus {
            border-color: rgba(0, 184, 148, 0.6);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 0 0 3px rgba(0, 184, 148, 0.15);
        }
        
        .username-edit-btn,
        .username-cancel-btn {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .username-edit-btn {
            background: linear-gradient(135deg, #00b894 0%, #00d4aa 100%);
            color: white;
        }
        
        .username-edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 184, 148, 0.3);
        }
        
        .username-cancel-btn {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }
        
        .username-cancel-btn:hover {
            background: rgba(255, 107, 107, 0.3);
        }
        
        .username-status {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            min-height: 1.2rem;
        }
        
        .username-status.success {
            color: #00b894;
        }
        
        .username-status.error {
            color: #ff6b6b;
        }
        
        .username-cooldown {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #a5b1c2;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .username-cooldown.active {
            color: #ffa500;
        }
        
        .username-cooldown i {
            font-size: 0.9rem;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-actions {
                margin: 1rem 0 0;
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .profile-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .profile-tab {
                padding: 1rem;
                white-space: nowrap;
            }
        }

        .star-pagination button {
            background: #181a20;
            color: #fff;
            border: 2px solid #23262f;
            border-radius: 8px;
            margin: 0 2px;
            padding: 8px 18px;
            font-size: 1.18em;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, border 0.2s;
            outline: none;
        }
        .star-pagination button.active,
        .star-pagination button.selected,
        .star-pagination button:focus {
            background: #232f3e;
            color: #39ff14;
            border: 2px solid #39ff14;
        }
        .star-pagination button:hover {
            background: #23262f;
            color: #39ff14;
            border: 2px solid #39ff14;
        }
        .star-pagination .ellipsis {
            color: #aaa;
            font-size: 1.18em;
            padding: 0 8px;
            user-select: none;
            pointer-events: none;
            background: transparent;
            border: none;
        }

        .star-page-btn {
            background: #181a20;
            color: #fff;
            border: 2px solid #23262f;
            border-radius: 8px;
            margin: 0 2px;
            padding: 8px 18px;
            font-size: 1.18em;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, border 0.2s;
            outline: none;
        }
        .star-page-btn:focus,
        .star-page-btn.active {
            background: #232f3e;
            color: #39ff14;
            border: 2px solid #39ff14;
        }
        .star-page-btn:hover {
            background: #23262f;
            color: #39ff14;
            border: 2px solid #39ff14;
        }

        .card-list {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 2rem;
            margin-top: 1.5rem;
            justify-content: flex-start;
        }
        .catalogue-card {
            flex: 0 0 calc(20% - 1.6rem);
            max-width: calc(20% - 1.6rem);
            min-width: 180px;
            box-sizing: border-box;
            margin: 0 0 2rem 0;
        }

        /* Responsive: 3 cards per row on medium screens, 1 per row on small screens */
        @media (max-width: 1100px) {
            .catalogue-card {
                flex: 0 0 calc(33.333% - 1.6rem);
                max-width: calc(33.333% - 1.6rem);
            }
        }
        @media (max-width: 700px) {
            .catalogue-card {
                flex: 0 0 100%;
                max-width: 100%;
            }
            .card-list {
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
  <!-- En-tête unifié -->
  <header class="main-header">
    <a href="acceuil.html" class="logo-link">
      <img src="/images/kame_house.png" alt="Logo MangaWatch" class="logo-image">
      <span>MangaWatch</span>
    </a>
    
    <div class="search-wrapper">
      <form class="search-bar" id="searchForm">
        <select id="searchType" class="search-type-selector">
          <option value="manga" selected data-i18n="search.type.manga">Manga</option>
          <option value="anime" data-i18n="search.type.anime">Anime</option>
          <option value="movie" data-i18n="search.type.movie">Film</option>
          <option value="user" data-i18n="search.type.user">Utilisateur</option>
        </select>
        <input type="text" id="searchInput" data-i18n-placeholder="search.placeholder.manga" placeholder="" autocomplete="new-password" name="profile-search" spellcheck="false">
        <button type="submit" aria-label="" data-i18n-aria-label="profile.search_aria" id="search-submit-btn">
          <i class="fas fa-search"></i>
        </button>
      </form>
      <!-- Résultats de recherche -->
      <div id="search-results" class="search-results-dropdown"></div>
    </div>
    
    <!-- Navigation desktop (visible sur grand écran) -->
            <nav class="nav-links">
            <a href="acceuil.html" data-i18n="nav.home">Accueil</a>
            <a href="manga-database.html" data-i18n="nav.manga_anime">Mangas & Anime</a>
            <a href="list.html" data-i18n="nav.collection">Collection</a>
            <a href="profil.html" class="active" data-i18n="nav.profile">Profil</a>
        </nav>
    
    <!-- Conteneur pour les éléments de droite -->
    <div class="header-right">
      <!-- Bouton hamburger pour mobile -->
      <button class="hamburger-btn" aria-label="" data-i18n-aria-label="profile.menu_aria">
        <span></span>
        <span></span>
        <span></span>
      </button>
      
      <!-- Avatar utilisateur -->
      <a href="profil.html" class="avatar-link">
        <img id="user-avatar" src="" alt="" class="user-avatar" data-i18n-alt="profile.avatar_alt" onerror="this.onerror=null; this.src='/images/logo.png';">
      </a>
    </div>
  </header>

  <!-- Menu mobile -->
  <div class="mobile-menu">
    <nav class="nav-links">
      <a href="acceuil.html">
        <i class="fas fa-home"></i>
        <span data-i18n="nav.home">Accueil</span>
      </a>
      <a href="manga-database.html">
        <i class="fas fa-tv"></i>
        <span data-i18n="nav.manga_anime">Mangas & Anime</span>
      </a>
      <a href="list.html">
        <i class="fas fa-bookmark"></i>
        <span data-i18n="nav.collection">Collection</span>
      </a>
      <a href="profil.html" class="active">
        <i class="fas fa-user"></i>
        <span data-i18n="nav.profile">Profil</span>
      </a>
    </nav>
  </div>

    <!-- Container pour les notifications toast -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Popup pour afficher les abonnés/abonnements -->
    <div class="follow-modal-overlay" id="follow-modal-overlay"></div>
    <div class="follow-modal" id="follow-modal">
        <div class="follow-modal-header">
            <h3 id="follow-modal-title" data-i18n="profile.followers_modal_title">Abonnés</h3>
            <button class="follow-modal-close" id="follow-modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="follow-modal-content" id="follow-modal-content">
            <!-- Le contenu sera rempli dynamiquement -->
        </div>
    </div>
    
    <!-- Menu d'édition de la bannière (modal) -->
    <div class="banner-edit-menu-overlay" id="banner-edit-overlay"></div>
    <div class="banner-edit-menu" id="banner-edit-menu">
        <h3><i class="fas fa-image"></i> <span data-i18n="profile.edit_banner">Modifier la bannière</span></h3>
        <label class="banner-edit-option" for="banner-image-input">
            <i class="fas fa-image"></i>
            <span data-i18n="profile.choose_image">Choisir une image</span>
        </label>
        <input type="file" id="banner-image-input" class="banner-file-input" accept="image/*">
        <label class="banner-edit-option" for="banner-video-input">
            <i class="fas fa-video"></i>
            <span data-i18n="profile.choose_video">Choisir une vidéo</span>
        </label>
        <input type="file" id="banner-video-input" class="banner-file-input" accept="video/*">
        
        <!-- Contrôle de volume pour vidéo -->
        <div class="banner-volume-control" id="banner-volume-control" style="display: none;">
            <div class="volume-control-compact" style="margin-top: 0; padding: 0.5rem 0.75rem;">
<button type="button" class="volume-icon-btn" id="banner-volume-mute-btn" title="" data-i18n-title="profile.mute_sound">
                                    <i class="fas fa-volume-mute"></i>
                                </button>
                <input type="range" id="banner-volume-slider" min="0" max="100" value="0" class="volume-slider-compact" style="flex: 1; min-width: 0;">
                <span id="banner-volume-value" class="volume-value-compact">0%</span>
            </div>
        </div>
        
        <button class="banner-edit-option banner-remove-btn" id="banner-remove-btn">
            <i class="fas fa-trash"></i>
            <span data-i18n="profile.remove_banner">Supprimer la bannière</span>
        </button>
        <button class="banner-edit-option" id="banner-close-btn" style="background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.2); margin-top: 0.5rem;">
            <i class="fas fa-times"></i>
            <span data-i18n="profile.close">Fermer</span>
        </button>
    </div>

    <main class="profile-container">
        <div class="profile-header" id="profile-header">
            <!-- Bannière en arrière-plan -->
            <img id="banner-image" class="profile-header-banner" alt="" data-i18n-alt="profile.banner_alt" loading="eager">
            <video id="banner-video" class="profile-header-banner" autoplay loop playsinline preload="auto" muted></video>
            <div class="profile-header-banner-overlay"></div>
            
            <!-- Contenu du header (avatar et pseudo) -->
            <div class="profile-header-content">
                <div class="profile-avatar-wrapper" id="profile-avatar-wrapper">
                    <img src="" alt="" id="profile-avatar" class="profile-avatar" data-i18n-alt="profile.avatar_alt" onerror="this.onerror=null; this.src='/images/logo.png';">
                </div>
                <div class="profile-info">
                    <h1 id="user-name">
                        <span id="user-name-text"></span>
                        <span id="verified-badge" class="verified-badge" style="display: none;" title="" data-i18n-title="profile.certified_account">
                            <i class="fas fa-check"></i>
                        </span>
                    </h1>
                    <div class="profile-country-badge" id="profile-country-badge">
                        <i class="fas fa-globe"></i>
                        <span id="profile-country-text">Non renseigné</span>
                    </div>
                </div>
                <!-- Système d'abonnements à droite -->
                <div class="profile-follow-section" id="profile-follow-section">
                    <div class="profile-follow-stats" id="profile-follow-stats">
                        <div class="follow-stat-item" id="followers-stat">
                            <span class="follow-stat-number" id="followers-count">0</span>
                            <span class="follow-stat-label" data-i18n="profile.followers">Abonnés</span>
                        </div>
                        <div class="follow-stat-item" id="following-stat">
                            <span class="follow-stat-number" id="following-count">0</span>
                            <span class="follow-stat-label" data-i18n="profile.following">Abonnements</span>
                        </div>
                    </div>
                    <button class="profile-follow-btn" id="profile-follow-btn" style="display: none;">
                        <i class="fas fa-user-plus"></i>
                        <span id="follow-btn-text" data-i18n="profile.subscribe">S'abonner</span>
                    </button>
                </div>
            </div>
            
            <!-- Description en bas de la bannière -->
            <div class="profile-description-wrapper" id="profile-description-wrapper" style="display: block;">
                <div class="profile-description" id="profile-description-display">
                    <span id="profile-description-text" data-i18n="profile.description_placeholder">Écrivez votre description ici...</span>
                    <button class="profile-description-edit-btn" id="profile-description-edit-btn" title="" data-i18n-title="profile.edit_description">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <div class="profile-description-edit" id="profile-description-edit" style="display: none;">
                    <textarea id="profile-description-textarea" data-i18n-placeholder="profile.description_placeholder" placeholder="Écrivez votre description ici..." maxlength="80"></textarea>
                    <div class="profile-description-char-count" id="profile-description-char-count">0 / 80</div>
                </div>
            </div>
            </div>
        </div>

        <div class="profile-tabs">
            <div class="profile-tab active" data-tab="reviews" data-i18n="profile.tab_anime_manga">Anime & Manga</div>
            <div class="profile-tab" data-tab="settings" data-i18n="profile.tab_settings">Paramètres</div>
        </div>

        <div class="profile-content">

            <!-- Section Paramètres -->
            <div class="profile-section" id="settings-section" style="display: none;">
                <h2 data-i18n="profile.settings_title">Paramètres</h2>
                <div class="profile-grid">
                    <div class="profile-item">
                        <h3 data-i18n="profile.preferences">Préférences</h3>
                        <div class="setting-item">
                            <label><i class="fas fa-image"></i> <span data-i18n="profile.profile_photo">Photo de profil</span></label>
                            <button class="edit-btn" id="edit-avatar-btn" style="margin-top: 0.5rem;"><i class="fas fa-image"></i> <span data-i18n="profile.modify">Modifier</span></button>
                        </div>
                        <div class="setting-item">
                            <label><i class="fas fa-image"></i> <span data-i18n="profile.banner_label">Bannière du profil</span></label>
                            <button class="edit-btn" id="edit-banner-btn" style="margin-top: 0.5rem;"><i class="fas fa-image"></i> <span data-i18n="profile.modify">Modifier</span></button>
                        </div>
                        <div class="setting-item" id="banner-volume-setting" style="display: none;">
                            <label><i class="fas fa-volume-up"></i> <span data-i18n="profile.banner_video_volume">Volume de la bannière vidéo</span></label>
                            <div class="volume-control-compact">
                                <button class="volume-icon-btn" id="volume-mute-btn" title="" data-i18n-title="profile.mute_sound">
                                    <i class="fas fa-volume-mute"></i>
                                </button>
                                <div style="flex: 1; position: relative; margin: 0 -4px; padding: 0;">
                                    <input type="range" id="banner-volume-setting-slider" min="0" max="100" value="0" class="volume-slider-compact" style="width: calc(100% + 8px); margin: 0; padding: 0;">
                                </div>
                                <span id="banner-volume-setting-value" class="volume-value-compact" style="margin-left: 0.5rem;">0%</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label><i class="fas fa-palette"></i> <span data-i18n="profile.theme">Thème</span></label>
                            <select id="theme-select">
                                <option value="dark" data-i18n="profile.theme_dark">Sombre</option>
                                <option value="light" data-i18n="profile.theme_light">Clair</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label><i class="fas fa-lock"></i> <span data-i18n="profile.privacy_subscriptions">Confidentialité des abonnements</span></label>
                            <div class="privacy-toggle-wrapper">
                                <div class="privacy-toggle-description">
                                    <span data-i18n="profile.hide_subscriptions">Masquer mes abonnements aux autres utilisateurs</span>
                                    <span class="privacy-toggle-hint" data-i18n="profile.privacy_subscriptions_hint">Les autres utilisateurs ne pourront pas voir vos abonnés et abonnements</span>
                                </div>
                                <label class="privacy-toggle-switch">
                                    <input type="checkbox" id="hide-follows-checkbox">
                                    <span class="privacy-toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Section Informations du compte -->
                <div class="settings-card">
                    <h3><i class="fas fa-user-circle"></i> <span data-i18n="profile.account_info">Informations du compte</span></h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>
                                <i class="fas fa-user"></i>
                                <span data-i18n="profile.pseudo">Pseudo</span>
                                <span class="username-info-tooltip" data-i18n-title="profile.username_tooltip" title="">
                                    <i class="fas fa-info-circle" style="color: #00b894; font-size: 0.75rem;"></i>
                                </span>
                            </label>
                            <div class="username-input-wrapper">
                                <input type="text" id="username-display" class="username-input">
                                <button class="username-edit-btn" id="username-edit-btn" style="display: none;">
                                    <i class="fas fa-save"></i>
                                </button>
                                <button class="username-cancel-btn" id="username-cancel-btn" style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="username-status" id="username-status"></div>
                            <div class="username-cooldown" id="username-cooldown"></div>
                        </div>
                        <div class="info-item">
                            <label><i class="fas fa-envelope"></i> <span data-i18n="profile.email">Adresse email</span></label>
                            <div class="info-edit-wrapper">
                                <input type="email" id="email-display" readonly class="email-masked">
<button class="email-reveal-btn" id="email-reveal-btn" title="" data-i18n-title="profile.reveal_email">
                                <i class="fas fa-eye"></i>
                            </button>
                                <button class="info-edit-btn" id="email-edit-btn" title="" data-i18n-title="profile.edit_email">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <div class="info-edit-actions" id="email-edit-actions" style="display: none;">
                                <button class="info-save-btn" id="email-save-btn">
                                    <i class="fas fa-check"></i> <span data-i18n="profile.save">Enregistrer</span>
                                </button>
                                <button class="info-cancel-btn" id="email-cancel-btn">
                                    <i class="fas fa-times"></i> <span data-i18n="profile.cancel">Annuler</span>
                                </button>
                            </div>
                        </div>
                        <div class="info-item">
                            <label><i class="fas fa-lock"></i> <span data-i18n="profile.password_label">Mot de passe</span></label>
                            <div class="password-wrapper">
                                <input type="password" id="password-display" readonly value="••••••••••••">
                                <button class="password-toggle-btn" id="password-toggle-btn" title="" data-i18n-title="profile.show_password">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="info-edit-actions" id="password-edit-actions" style="display: none;">
                                <input type="password" id="password-new-input" data-i18n-placeholder="profile.new_password" placeholder="Nouveau mot de passe" style="width: 100%; margin-bottom: 0.5rem;">
                                <input type="password" id="password-confirm-input" data-i18n-placeholder="profile.confirm_password" placeholder="Confirmer le mot de passe" style="width: 100%; margin-bottom: 0.5rem;">
                                <button class="info-save-btn" id="password-save-btn">
                                    <i class="fas fa-check"></i> <span data-i18n="profile.save">Enregistrer</span>
                                </button>
                                <button class="info-cancel-btn" id="password-cancel-btn">
                                    <i class="fas fa-times"></i> <span data-i18n="profile.cancel">Annuler</span>
                                </button>
                            </div>
                            <button class="info-edit-btn" id="password-edit-btn" style="position: relative; margin-top: 0.75rem; right: auto; width: auto; padding: 0.6rem 1rem;" title="" data-i18n-title="profile.edit_password">
                                <i class="fas fa-edit"></i> <span data-i18n="profile.edit_password">Modifier le mot de passe</span>
                            </button>
                        </div>
                        <div class="info-item">
                            <label><i class="fas fa-language"></i> <span data-i18n="profile.language">Langue</span></label>
                            <div class="info-edit-wrapper">
                                <input type="text" id="language-display" readonly>
                                <button class="info-edit-btn" id="language-edit-btn" title="" data-i18n-title="profile.edit_language">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <div class="info-edit-actions" id="language-edit-actions" style="display: none;">
                                <select id="language-select-edit">
                                    <option value="fr">Français</option>
                                    <option value="en">English</option>
                                    <option value="de">Deutsch</option>
                                    <option value="es">Español</option>
                                    <option value="it">Italiano</option>
                                    <option value="ja">日本語</option>
                                </select>
                                <button class="info-save-btn" id="language-save-btn">
                                    <i class="fas fa-check"></i> <span data-i18n="profile.save">Enregistrer</span>
                                </button>
                                <button class="info-cancel-btn" id="language-cancel-btn">
                                    <i class="fas fa-times"></i> <span data-i18n="profile.cancel">Annuler</span>
                                </button>
                            </div>
                        </div>
                        <div class="info-item">
                            <label><i class="fas fa-globe"></i> <span data-i18n="profile.country">Pays</span></label>
                            <div class="info-edit-wrapper">
                                <input type="text" id="country-display" readonly>
                                <button class="info-edit-btn" id="country-edit-btn" title="" data-i18n-title="profile.edit_country">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <div class="info-edit-actions" id="country-edit-actions" style="display: none;">
                                <div class="country-picker-profile">
                                    <div class="country-search-wrap-profile">
                                        <input type="text" id="country-select-edit-search" class="country-search-input" placeholder="Rechercher un pays..." autocomplete="off">
                                    </div>
                                    <select id="country-select-edit">
                                        <option value="" disabled data-i18n="auth.choose_country">Choisissez votre pays</option>
                                    </select>
                                </div>
                                <button class="info-save-btn" id="country-save-btn">
                                    <i class="fas fa-check"></i> <span data-i18n="profile.save">Enregistrer</span>
                                </button>
                                <button class="info-cancel-btn" id="country-cancel-btn">
                                    <i class="fas fa-times"></i> <span data-i18n="profile.cancel">Annuler</span>
                                </button>
                            </div>
                        </div>
                        <div class="info-item">
                            <label><i class="fas fa-calendar"></i> <span data-i18n="profile.join_date">Date d'inscription</span></label>
                            <input type="text" id="join-date-display" readonly>
                        </div>
                    </div>
                </div>
                
                <!-- Section Utilisateurs bloqués -->
                <div class="settings-card">
                    <h3><i class="fas fa-ban"></i> <span data-i18n="profile.blocked_users">Utilisateurs bloqués</span></h3>
                    <div id="blocked-users-container">
                        <p id="no-blocked-users" style="color: #a5b1c2; text-align: center; padding: 2rem 0;" data-i18n="profile.no_blocked_users">
                            Aucun utilisateur bloqué
                        </p>
                        <div id="blocked-users-list" style="display: none;">
                            <!-- Les utilisateurs bloqués seront affichés ici -->
                        </div>
                    </div>
                </div>
                
                <!-- Section Actions du compte -->
                <div class="settings-card">
                    <h3><i class="fas fa-cog"></i> <span data-i18n="profile.account_actions">Actions du compte</span></h3>
                    <div class="account-actions">
                        <button class="logout-btn"><i class="fas fa-sign-out-alt"></i> <span data-i18n="profile.logout">Déconnexion</span></button>
                    </div>
                </div>
            </div>

            <!-- Section Avis (Anime & Manga : affichée par défaut) -->
            <div class="profile-section active" id="reviews-section">
                <!-- Garder uniquement le séparateur et les boutons de tri -->
                <div style="width:100%;height:12px;background:#23262f;margin:2.5rem 0 2.5rem 0;border-radius:6px;"></div>
                <div style="width:100%;display:flex;justify-content:center;">
                    <div style="background:transparent;border-radius:14px;box-shadow:none;display:flex;flex-direction:row;align-items:center;justify-content:center;min-width:320px;max-width:600px;padding:2.2rem 1.2rem 2rem 1.2rem;gap:1.5rem;">
                    </div>
                </div>
            </div>

            <!-- Section Tier List - Masquée temporairement -->
            <div class="profile-section" id="tierlist-section" style="display: none;">
                <!-- Section désactivée -->
                <p data-i18n="profile.tier_list_create">Créez vos premières tier lists pour classer vos animes et mangas préférés !</p>
            </div>
            </div>
        </div>
    </main>

    <script>
        // Fonction pour afficher les notifications toast
        function showToast(title, message, type = 'success', duration = 3000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'error' : ''}`;
            
            const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            // Auto-suppression après la durée spécifiée
            setTimeout(() => {
                toast.classList.add('slide-out');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, 300);
            }, duration);
        }
        
        // Fonction globale pour gérer le clic sur le bouton de modification de l'avatar
        // Définie AVANT window.onload pour être accessible partout
        window.handleAvatarEditClick = function(e) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            // Fonction pour optimiser l'avatar avec qualité maximale
            function optimizeAvatarQuality(file, maxSize = 2048, quality = 1.0) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            // Calculer les dimensions optimales en gardant le ratio (avatar carré)
                            if (width > maxSize || height > maxSize) {
                                const ratio = Math.min(maxSize / width, maxSize / height);
                                width = Math.round(width * ratio);
                                height = Math.round(height * ratio);
                            }
                            
                            // S'assurer que les dimensions sont des nombres entiers
                            width = Math.round(width);
                            height = Math.round(height);
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d', { 
                                alpha: true,  // Garder alpha pour les avatars (transparence possible)
                                willReadFrequently: false
                            });
                            
                            // Paramètres de qualité maximale pour le rendu
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';
                            
                            // Support cross-browser
                            ctx.webkitImageSmoothingEnabled = true;
                            ctx.mozImageSmoothingEnabled = true;
                            ctx.msImageSmoothingEnabled = true;
                            
                            // Rendre l'image avec la meilleure qualité possible
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Utiliser PNG pour qualité maximale (sans perte)
                            canvas.toBlob((blob) => {
                                if (blob) {
                                    // Créer un nouveau File avec le nom original
                                    const optimizedFile = new File([blob], file.name, {
                                        type: 'image/png',
                                        lastModified: Date.now()
                                    });
                                    resolve(optimizedFile);
                                } else {
                                    reject(new Error('Erreur lors de la conversion en blob'));
                                }
                            }, 'image/png', quality);
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
            
            console.log('📸 Clic sur le bouton Modifier la photo de profil');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    const user = JSON.parse(localStorage.getItem('user') || 'null');
                    if (!user || !user.email) {
                        console.error('❌ Utilisateur non trouvé');
                        return;
                    }
                    
                    try {
                        // Optimiser l'avatar avec qualité maximale (2048x2048, qualité 100%)
                        console.log('🎨 Optimisation de l\'avatar avec qualité maximale...');
                        const optimizedFile = await optimizeAvatarQuality(file, 2048, 1.0);
                        
                        // Afficher l'image optimisée immédiatement pour l'aperçu
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const userAvatar = document.getElementById('user-avatar');
                            const profileAvatar = document.getElementById('profile-avatar');
                            const previewUrl = event.target.result;
                            
                            // Afficher l'aperçu immédiatement
                            if (userAvatar) userAvatar.src = previewUrl;
                            if (profileAvatar) profileAvatar.src = previewUrl;
                        };
                        reader.readAsDataURL(optimizedFile);
                        
                        // Sauvegarder dans Firebase Storage et Firestore avec le fichier optimisé
                        if (window.avatarService && typeof window.avatarService.saveAvatar === 'function') {
                            try {
                                console.log('📤 Upload avatar optimisé vers Firebase Storage...');
                                const avatarUrl = await window.avatarService.saveAvatar(user.email, optimizedFile);
                                console.log('✅ Avatar sauvegardé dans Firebase:', avatarUrl);
                                
                                // Mettre à jour l'affichage avec l'URL Firebase
                                const userAvatar = document.getElementById('user-avatar');
                                const profileAvatar = document.getElementById('profile-avatar');
                                if (userAvatar) userAvatar.src = avatarUrl;
                                if (profileAvatar) profileAvatar.src = avatarUrl;
                                
                                // Mettre à jour l'objet user
                                user.customAvatar = avatarUrl;
                                user.avatar = avatarUrl;
                                localStorage.setItem('user', JSON.stringify(user));
                                
                                // IMPORTANT : Mettre à jour accounts AVANT syncAndLoadUserData pour éviter que l'ancienne photo soit rechargée
                                const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                                const accountIndex = accounts.findIndex(acc => acc.email === user.email);
                                if (accountIndex !== -1) {
                                    accounts[accountIndex] = {
                                        ...accounts[accountIndex],
                                        avatar: avatarUrl,
                                        customAvatar: avatarUrl
                                    };
                                    localStorage.setItem('accounts', JSON.stringify(accounts));
                                }
                                
                                // Mettre à jour aussi la clé dédiée avatar_
                                localStorage.setItem('avatar_' + user.email, avatarUrl);
                                
                                // Mettre à jour profile_
                                const profileKey = 'profile_' + user.email;
                                const existingProfileData = localStorage.getItem(profileKey);
                                let existingProfile = {};
                                if (existingProfileData) {
                                    try {
                                        existingProfile = JSON.parse(existingProfileData);
                                    } catch (e) {
                                        console.error('Erreur parsing profile:', e);
                                    }
                                }
                                const updatedProfile = {
                                    ...existingProfile,
                                    customAvatar: avatarUrl,
                                    avatar: avatarUrl,
                                    email: user.email
                                };
                                localStorage.setItem(profileKey, JSON.stringify(updatedProfile));
                                
                                // Afficher un message de succès
                                if (typeof showToast === 'function') {
                                    showToast('Succès', 'Avatar mis à jour avec succès !', 'success');
                                }
                                
                                // Ne PAS appeler syncAndLoadUserData() car elle pourrait recharger l'ancienne photo
                                // L'affichage est déjà mis à jour ci-dessus
                            } catch (error) {
                                console.error('❌ Erreur lors de la sauvegarde de l\'avatar:', error);
                                const errorMessage = error.message || error.toString() || '';
                                
                                if (error.code === 'storage/unauthorized' || errorMessage.includes('PERMISSION_DENIED')) {
                                    alert('❌ Erreur de permissions Firebase Storage.\n\nVérifiez que :\n1. Les règles Storage sont publiées dans Firebase Console → Storage → Rules\n2. Vous êtes bien connecté avec Firebase Auth\n3. Les règles permettent l\'écriture pour les utilisateurs authentifiés\n\nErreur : ' + errorMessage);
                                } else {
                                    alert('❌ Erreur lors de l\'upload de l\'avatar.\n\nErreur : ' + errorMessage);
                                }
                            }
                        } else {
                            console.error('❌ avatarService non disponible');
                            alert('❌ Firebase Storage n\'est pas disponible. Vérifiez que firebase-service.js est chargé.');
                        }
                    } catch (optimizeError) {
                        console.error('❌ Erreur lors de l\'optimisation de l\'avatar:', optimizeError);
                        alert('❌ Erreur lors de l\'optimisation de l\'avatar. Tentative avec le fichier original...');
                        
                        // Fallback : utiliser le fichier original si l'optimisation échoue
                        if (window.avatarService && typeof window.avatarService.saveAvatar === 'function') {
                            try {
                                const avatarUrl = await window.avatarService.saveAvatar(user.email, file);
                                const userAvatar = document.getElementById('user-avatar');
                                const profileAvatar = document.getElementById('profile-avatar');
                                if (userAvatar) userAvatar.src = avatarUrl;
                                if (profileAvatar) profileAvatar.src = avatarUrl;
                                user.customAvatar = avatarUrl;
                                user.avatar = avatarUrl;
                                localStorage.setItem('user', JSON.stringify(user));
                                localStorage.setItem('avatar_' + user.email, avatarUrl);
                            } catch (error) {
                                console.error('❌ Erreur lors de la sauvegarde avec fichier original:', error);
                            }
                        }
                    }
                }
            };
            input.click();
        };
        
        // Initialisation Google Sign-In
        window.onload = function() {
            // Vérifier si l'utilisateur est connecté
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            if (!user || !user.email) {
                window.location.href = 'acceuil.html';
                return;
            }
            
            // Ajouter la classe pour la largeur de la section Paramètres si elle est active par défaut
            const profileContainer = document.querySelector('.profile-container');
            const settingsSection = document.getElementById('settings-section');
            if (settingsSection && settingsSection.classList.contains('active')) {
                profileContainer.classList.add('settings-active');
            }
            
            // Initialiser Google Sign-In (ne pas bloquer le reste si indisponible)
            try {
                if (window.google && window.google.accounts && window.google.accounts.id) {
                    google.accounts.id.initialize({
                        client_id: "669862191301-acapu82b61jp8tpnt3noet0lbsk6lk30.apps.googleusercontent.com",
                        callback: handleCredentialResponse,
                        auto_select: false
                    });
    
                    google.accounts.id.renderButton(
                        document.getElementById('google-signin'),
                        {
                            type: 'standard',
                            shape: 'rectangular',
                            theme: 'outline',
                            text: 'continue_with',
                            size: 'large',
                            width: '100%'
                        }
                    );
                } else {
                    console.warn('Google Sign-In indisponible, poursuite du chargement du profil.');
                }
            } catch (e) {
                console.warn('Erreur lors de l\'initialisation Google Sign-In, chargement poursuivi.', e);
            }

            // Vérifier si un onglet actif a été sauvegardé
            const savedActiveTab = localStorage.getItem('activeProfileTab');
            if (savedActiveTab) {
                // Activer l'onglet sauvegardé
                const savedTab = document.querySelector(`.profile-tab[data-tab="${savedActiveTab}"]`);
                if (savedTab) {
                    document.querySelectorAll('.profile-tab').forEach(tab => tab.classList.remove('active'));
                    savedTab.classList.add('active');
                    document.querySelectorAll('.profile-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    const savedSection = document.getElementById(`${savedActiveTab}-section`);
                    if (savedSection) {
                        savedSection.style.display = 'block';
                    }
                    
                    // Ajouter/retirer la classe pour la largeur de la section Paramètres
                    const profileContainer = document.querySelector('.profile-container');
                    if (savedActiveTab === 'settings') {
                        profileContainer.classList.add('settings-active');
                    } else {
                        profileContainer.classList.remove('settings-active');
                    }
                    
                    // Afficher les cartes d'animes si on est sur l'onglet reviews
                    if (savedActiveTab === 'reviews' && typeof displayUserAnimeNotes === 'function') {
                        setTimeout(displayUserAnimeNotes, 10);
                    }
                }
                // Nettoyer la valeur sauvegardée après utilisation
                localStorage.removeItem('activeProfileTab');
            } else {
                // Onglet par défaut = Anime & Manga, charger les cartes
                if (typeof displayUserAnimeNotes === 'function') {
                    setTimeout(displayUserAnimeNotes, 10);
                }
            }

            console.log('✅ Vérification onglet sauvegardé terminée, passage à l\'initialisation des onglets...');

            // Gérer les onglets - Attendre un peu pour que le DOM soit complètement chargé
            console.log('🔍 Initialisation des onglets du profil...');
            
            try {
            
            // Fonction pour initialiser les onglets
            function initializeProfileTabs() {
                const profileTabs = document.querySelectorAll('.profile-tab');
                console.log('📌 Onglets trouvés:', profileTabs.length);
                
                if (profileTabs.length > 0) {
                profileTabs.forEach((tab, index) => {
                    console.log(`📌 Onglet ${index}:`, tab.getAttribute('data-tab'), tab.textContent.trim());
                    
                    // Vérifier si le gestionnaire est déjà attaché
                    if (tab.hasAttribute('data-listener-attached')) {
                        console.log(`⚠️ Gestionnaire déjà attaché à l'onglet ${index}, skip...`);
                        return;
                    }
                    
                    // Marquer comme attaché
                    tab.setAttribute('data-listener-attached', 'true');
                    
                    tab.addEventListener('click', function(e) {
                        console.log('🖱️ Clic détecté sur onglet:', this.getAttribute('data-tab'));
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        
                        const targetTabName = this.getAttribute('data-tab');
                        const wasOnReviews = document.querySelector('.profile-tab.active')?.getAttribute('data-tab') === 'reviews';
                        // En quittant Anime & Manga vers un autre onglet (ex. Paramètres), rafraîchir la page pour éviter les bugs
                        if (wasOnReviews && targetTabName !== 'reviews') {
                            localStorage.setItem('activeProfileTab', targetTabName);
                            location.reload();
                            return;
                        }
                        
                        // Retirer la classe active de tous les onglets
                        document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        console.log('✅ Classe active ajoutée à l\'onglet');
                        
                        // Cacher toutes les sections
                        document.querySelectorAll('.profile-section').forEach(section => {
                            section.style.display = 'none';
                            section.classList.remove('active');
                        });
                        console.log('✅ Toutes les sections masquées');
                        
                        // Afficher la section correspondante
                        const tabName = this.getAttribute('data-tab');
                        console.log('📋 Nom de l\'onglet:', tabName);
                        const targetSection = document.getElementById(`${tabName}-section`);
                        console.log('🎯 Section cible trouvée:', !!targetSection);
                        if (targetSection) {
                            targetSection.style.display = 'block';
                            targetSection.classList.add('active');
                            console.log('✅ Section affichée:', tabName);
                        } else {
                            console.error('❌ Section non trouvée:', `${tabName}-section`);
                        }
                        
                        // Ajouter/retirer la classe pour la largeur de la section Paramètres
                        const profileContainer = document.querySelector('.profile-container');
                        if (profileContainer) {
                            if (tabName === 'settings') {
                                profileContainer.classList.add('settings-active');
                            } else {
                                profileContainer.classList.remove('settings-active');
                            }
                        }
                        
                        // Afficher les cartes d'animes quand on clique sur l'onglet reviews
                        if (tabName === 'reviews') {
                            console.log('📚 Onglet Anime & Manga cliqué, chargement des cartes...');
                            
                            // Vérifier que la section reviews existe et est visible
                            const reviewsSection = document.getElementById('reviews-section');
                            console.log('📋 Section reviews trouvée:', !!reviewsSection);
                            console.log('📋 Section reviews visible:', reviewsSection ? reviewsSection.style.display : 'N/A');
                            
                            // S'assurer que la section est visible
                            if (reviewsSection) {
                                reviewsSection.style.display = 'block';
                                reviewsSection.classList.add('active');
                                console.log('✅ Section reviews rendue visible');
                            }
                            
                            // Créer les badges et conteneurs si nécessaire - Attendre que le script soit chargé
                            const tryCreateStarBadges = (attempt = 0, callback) => {
                                console.log(`🔧 Tentative ${attempt + 1} - Création des badges et conteneurs...`);
                                console.log('🔍 Vérification createStarBadges:', typeof createStarBadges, typeof window.createStarBadges);
                                
                                // Vérifier si createStarBadges existe et créer les conteneurs
                                if (typeof createStarBadges === 'function') {
                                    console.log('✅ createStarBadges trouvée, appel...');
                                    try {
                                        const result = createStarBadges();
                                        console.log('✅ createStarBadges appelée avec succès, résultat:', result);
                                        if (callback) callback(true);
                                        return true;
                                    } catch (e) {
                                        console.error('❌ Erreur lors de l\'appel de createStarBadges:', e);
                                        if (callback) callback(false);
                                        return false;
                                    }
                                } else if (typeof window.createStarBadges === 'function') {
                                    console.log('✅ window.createStarBadges trouvée, appel...');
                                    try {
                                        const result = window.createStarBadges();
                                        console.log('✅ window.createStarBadges appelée avec succès, résultat:', result);
                                        if (callback) callback(true);
                                        return true;
                                    } catch (e) {
                                        console.error('❌ Erreur lors de l\'appel de window.createStarBadges:', e);
                                        if (callback) callback(false);
                                        return false;
                                    }
                                } else {
                                    if (attempt < 10) {
                                        console.warn(`⚠️ createStarBadges non disponible (tentative ${attempt + 1}/10), réessai dans 200ms...`);
                                        setTimeout(() => tryCreateStarBadges(attempt + 1, callback), 200);
                                    } else {
                                        console.error('❌ createStarBadges toujours non disponible après 10 tentatives');
                                        if (callback) callback(false);
                                    }
                                    return false;
                                }
                            };
                            
                            // Appeler tryCreateStarBadges et ensuite displayUserAnimeNotes
                            setTimeout(() => {
                                tryCreateStarBadges(0, (success) => {
                                    console.log('📊 Résultat de createStarBadges:', success);
                                    
                                    if (success) {
                                    // Attendre un peu que les conteneurs soient créés
                                    setTimeout(() => {
                                        const tryDisplayNotes = (attempt = 0) => {
                                            if (attempt >= 10) {
                                                console.error('❌ displayUserAnimeNotes toujours non disponible après 10 tentatives');
                                                return;
                                            }
                                            
                                            console.log(`📋 Tentative ${attempt + 1} - Affichage des cartes d'animes...`);
                                            console.log('🔍 Vérification displayUserAnimeNotes:', typeof displayUserAnimeNotes, typeof window.displayUserAnimeNotes);
                                            
                                            // Vérifier que les conteneurs existent maintenant
                                            const containersAfter = document.querySelectorAll('[id^="star-containers"]');
                                            console.log('📦 Containers trouvés avant displayUserAnimeNotes:', containersAfter.length);
                                            
                                            // Afficher les cartes d'animes
                                            if (typeof displayUserAnimeNotes === 'function') {
                                                console.log('✅ displayUserAnimeNotes trouvée, appel...');
                                                try {
                                                    displayUserAnimeNotes();
                                                    console.log('✅ displayUserAnimeNotes appelée avec succès');
                                                    return;
                                                } catch (e) {
                                                    console.error('❌ Erreur lors de l\'appel de displayUserAnimeNotes:', e);
                                                }
                                            } else if (typeof window.displayUserAnimeNotes === 'function') {
                                                console.log('✅ window.displayUserAnimeNotes trouvée, appel...');
                                                try {
                                                    window.displayUserAnimeNotes();
                                                    console.log('✅ window.displayUserAnimeNotes appelée avec succès');
                                                    return;
                                                } catch (e) {
                                                    console.error('❌ Erreur lors de l\'appel de window.displayUserAnimeNotes:', e);
                                                }
                                            } else {
                                                console.warn(`⚠️ displayUserAnimeNotes non disponible (tentative ${attempt + 1}/10), réessai dans 200ms...`);
                                                setTimeout(() => tryDisplayNotes(attempt + 1), 200);
                                            }
                                        };
                                        
                                        tryDisplayNotes();
                                    }, 300);
                                } else {
                                    // Si createStarBadges n'a pas fonctionné, essayer quand même displayUserAnimeNotes après un délai
                                    setTimeout(() => {
                                        const containersAfter = document.querySelectorAll('[id^="star-containers"]');
                                        if (containersAfter.length > 0) {
                                            if (typeof displayUserAnimeNotes === 'function') {
                                                displayUserAnimeNotes();
                                            } else if (typeof window.displayUserAnimeNotes === 'function') {
                                                window.displayUserAnimeNotes();
                                            }
                                        }
                                    }, 500);
                                }
                                });
                            }, 300);
                        }
                        
                        // Réinitialiser le gestionnaire de déconnexion quand on affiche les paramètres
                        if (tabName === 'settings') {
                            setTimeout(() => {
                                if (typeof window.setupLogoutHandler === 'function') {
                                    window.setupLogoutHandler();
                                }
                            }, 100);
                        }
                    });
                });
                } else {
                    console.error('❌ Aucun onglet .profile-tab trouvé dans le DOM');
                    return false;
                }
                
                console.log('✅ Initialisation des onglets terminée');
                return true;
            }
            
            // Essayer d'initialiser immédiatement
            if (!initializeProfileTabs()) {
                // Si ça ne fonctionne pas, réessayer après un délai
                console.log('🔄 Réessai après délai...');
                setTimeout(() => {
                    if (!initializeProfileTabs()) {
                        console.error('❌ Impossible d\'initialiser les onglets après délai');
                        // Dernière tentative après un délai plus long
                        setTimeout(() => {
                            initializeProfileTabs();
                        }, 1000);
                    }
                }, 500);
            }
            
            // Également écouter DOMContentLoaded au cas où
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('📄 DOMContentLoaded déclenché, vérification des onglets...');
                    setTimeout(initializeProfileTabs, 100);
                });
            } else {
                // Si le DOM est déjà chargé, réessayer après un court délai
                setTimeout(() => {
                    console.log('🔄 Vérification supplémentaire des onglets...');
                    initializeProfileTabs();
                }, 200);
            }
            } catch (error) {
                console.error('❌ Erreur lors de l\'initialisation des onglets:', error);
                // Réessayer après un délai
                setTimeout(() => {
                    try {
                        initializeProfileTabs();
                    } catch (e) {
                        console.error('❌ Erreur lors de la réinitialisation des onglets:', e);
                    }
                }, 1000);
            }

            console.log('✅ Fin de window.onload');
        };

        // Gestionnaire de connexion Google
        function handleCredentialResponse(response) {
            const credential = parseJwt(response.credential);
            if (credential) {
                // Charger les données existantes
                const profileData = localStorage.getItem('profile_' + credential.email);
                let savedProfile = null;
                if (profileData) {
                    try {
                        savedProfile = JSON.parse(profileData);
                    } catch (e) {
                        console.error('Erreur lors du chargement du profil:', e);
                    }
                }
                
                // Préparer les données utilisateur
                const user = {
                    name: credential.name || credential.given_name + ' ' + credential.family_name,
                    email: credential.email,
                    picture: credential.picture,
                    originalAvatar: savedProfile?.originalAvatar || credential.picture,
                    customAvatar: savedProfile?.customAvatar || null,
                    theme: savedProfile?.theme || 'dark',
                    language: savedProfile?.language || 'fr',
                    lastLogin: new Date().toISOString()
                };

                // Sauvegarder les données dans localStorage
                localStorage.setItem('profile_' + user.email, JSON.stringify(user));

                // Rediriger vers le profil
                localStorage.setItem('user', JSON.stringify(user));
                window.location.href = '/profil.html';
            }
        }

        // Décoder le token JWT
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('')
                    .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
                    .join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Erreur de décodage du token:', error);
                return null;
            }
        }

        // Fonction de validation du pseudo
        function validateUsername(username) {
            const errors = [];
            
            // Vérifier la longueur minimale
            if (username.length < 3) {
                errors.push('Le pseudo doit contenir au moins 3 caractères');
            }
            
            // Vérifier la longueur maximale
            if (username.length > 20) {
                errors.push('Le pseudo ne peut pas dépasser 20 caractères');
            }
            
            // Vérifier les caractères autorisés (lettres, chiffres, tirets, underscores)
            const validCharsRegex = /^[a-zA-Z0-9_-]+$/;
            if (!validCharsRegex.test(username)) {
                errors.push('Le pseudo ne peut contenir que des lettres, chiffres, tirets et underscores');
            }
            
            // Liste complète de mots interdits (mots violents, offensants, administratifs, etc.)
            const forbiddenWords = [
                // Mots administratifs
                'admin', 'administrator', 'moderator', 'mod', 'root', 'system', 'support',
                // Mots violents/offensants
                'kill', 'death', 'murder', 'violence', 'hate', 'war', 'bomb', 'terror',
                'suicide', 'rape', 'assault', 'abuse', 'torture', 'slaughter',
                // Insultes et mots offensants
                'fuck', 'shit', 'damn', 'bitch', 'asshole', 'bastard', 'whore', 'slut',
                'nigger', 'nigga', 'nword', 'n1gger', 'n1gga', 'n1gg3r', 'nigg3r', 'n1gg3r',
                'faggot', 'retard', 'idiot', 'stupid', 'moron',
                // Contenu sexuel explicite
                'sex', 'porn', 'xxx', 'nude', 'naked', 'pussy', 'dick', 'cock', 'penis', 'vagina',
                // Mots racistes/discriminatoires
                'nazi', 'hitler', 'kkk', 'racist', 'fascist',
                // Autres mots interdits
                'test', 'null', 'undefined', 'delete', 'remove', 'ban', 'banned',
                'spam', 'scam', 'fraud', 'hack', 'hacker', 'crack', 'pirate'
            ];
            
            // Normaliser le pseudo pour la vérification (minuscules, sans caractères spéciaux)
            const usernameLower = username.toLowerCase().replace(/[^a-z0-9]/g, '');
            const usernameOriginal = username.toLowerCase();
            
            // Vérifier les mots interdits exacts
            for (const word of forbiddenWords) {
                const wordLower = word.toLowerCase();
                // Vérifier si le mot est présent tel quel (dans le pseudo normalisé ou original)
                if (usernameLower.includes(wordLower) || usernameOriginal.includes(wordLower)) {
                    errors.push('Ce pseudo contient des mots interdits');
                    break;
                }
            }
            
            // Vérifier spécifiquement les tentatives de contournement de "nigger" avec "nword"
            const nwordPatterns = [
                /n[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?0-9]*w[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?0-9]*o[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?0-9]*r[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?0-9]*d/gi,
                /n[0-9]*w[0-9]*o[0-9]*r[0-9]*d/gi,
                /^nword$/gi,
                /nword/gi
            ];
            
            for (const pattern of nwordPatterns) {
                if (pattern.test(username)) {
                    errors.push('Ce pseudo contient des mots interdits');
                    break;
                }
            }
            
            // Vérifier les variations avec caractères spéciaux (ex: f*ck, sh!t, etc.)
            const variations = [
                { pattern: /f[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*u[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*c[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*k/gi, word: 'fuck' },
                { pattern: /s[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*h[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*i[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*t/gi, word: 'shit' },
                { pattern: /b[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*i[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*t[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*c[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*h/gi, word: 'bitch' },
                { pattern: /a[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*s[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*s[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*h[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*o[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*l[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*e/gi, word: 'asshole' }
            ];
            
            for (const variation of variations) {
                if (variation.pattern.test(username)) {
                    errors.push('Ce pseudo contient des variations de mots interdits');
                    break;
                }
            }
            
            // Vérifier les tentatives de contournement avec des chiffres (ex: f4ck, sh1t)
            const numberReplacements = [
                { pattern: /f[0-9]*u[0-9]*c[0-9]*k/gi, word: 'fuck' },
                { pattern: /s[0-9]*h[0-9]*i[0-9]*t/gi, word: 'shit' },
                { pattern: /b[0-9]*i[0-9]*t[0-9]*c[0-9]*h/gi, word: 'bitch' },
                { pattern: /a[0-9]*s[0-9]*s[0-9]*h[0-9]*o[0-9]*l[0-9]*e/gi, word: 'asshole' }
            ];
            
            for (const replacement of numberReplacements) {
                if (replacement.pattern.test(username)) {
                    errors.push('Ce pseudo contient des tentatives de contournement de mots interdits');
                    break;
                }
            }
            
            // Vérifier l'unicité du pseudo
            const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            const existingAccount = accounts.find(acc => acc.username === username && acc.email !== user.email);
            if (existingAccount) {
                errors.push('Ce pseudo est déjà pris');
            }
            
            return {
                valid: errors.length === 0,
                errors: errors
            };
        }
        
        // Fonction pour vérifier le cooldown de 30 jours
        // TEMPORAIREMENT DÉSACTIVÉ POUR LES TESTS - REMETTRE LE COOLDOWN QUAND DEMANDÉ
        function canChangeUsername() {
            // TEMPORAIRE : Toujours permettre le changement pour les tests
            return { canChange: true, daysRemaining: 0 };
            
            /* CODE ORIGINAL À REMETTRE :
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            if (!user || !user.email) return { canChange: true, daysRemaining: 0 };
            
            const lastUsernameChange = localStorage.getItem('lastUsernameChange_' + user.email);
            if (!lastUsernameChange) return { canChange: true, daysRemaining: 0 };
            
            const lastChangeDate = new Date(lastUsernameChange);
            const now = new Date();
            const diffTime = now - lastChangeDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const daysRemaining = 30 - diffDays;
            
            return {
                canChange: diffDays >= 30,
                daysRemaining: daysRemaining > 0 ? daysRemaining : 0
            };
            */
        }
        
        // Fonction pour attacher le gestionnaire d'événement au bouton de modification de l'avatar
        function attachAvatarEditHandler() {
            const editAvatarBtn = document.getElementById('edit-avatar-btn');
            console.log('🔍 Recherche du bouton edit-avatar-btn:', editAvatarBtn);
            if (editAvatarBtn) {
                // Supprimer l'ancien attribut pour permettre la réattachement si nécessaire
                if (editAvatarBtn.hasAttribute('data-listener-attached')) {
                    console.log('⚠️ Le gestionnaire est déjà attaché, suppression de l\'ancien...');
                    // Créer un nouveau bouton pour supprimer tous les anciens gestionnaires
                    const newBtn = editAvatarBtn.cloneNode(true);
                    editAvatarBtn.parentNode.replaceChild(newBtn, editAvatarBtn);
                    const freshBtn = document.getElementById('edit-avatar-btn');
                    freshBtn.setAttribute('data-listener-attached', 'true');
                    freshBtn.addEventListener('click', window.handleAvatarEditClick);
                    console.log('✅ Nouveau gestionnaire attaché au bouton cloné');
                    return true;
                }
                editAvatarBtn.setAttribute('data-listener-attached', 'true');
                editAvatarBtn.addEventListener('click', window.handleAvatarEditClick);
                console.log('✅ Gestionnaire d\'événement attaché au bouton edit-avatar-btn');
                return true;
            }
            console.warn('❌ Bouton edit-avatar-btn non trouvé dans le DOM');
            return false;
        }
        
        // La fonction handleAvatarEditClick est déjà définie avant window.onload, pas besoin de la redéfinir ici
        
        // Essayer d'attacher le gestionnaire immédiatement
        console.log('🔧 Tentative d\'attachement du gestionnaire avatar...');
        if (!attachAvatarEditHandler()) {
            // Si le bouton n'est pas encore disponible, réessayer après un délai
            console.warn('⚠️ Bouton edit-avatar-btn non trouvé, réessai dans 500ms...');
            setTimeout(() => {
                console.log('🔧 Nouvelle tentative d\'attachement (500ms)...');
                if (!attachAvatarEditHandler()) {
                    console.warn('⚠️ Bouton edit-avatar-btn toujours non trouvé après 500ms, réessai dans 1s...');
                    setTimeout(() => {
                        console.log('🔧 Nouvelle tentative d\'attachement (1s)...');
                        attachAvatarEditHandler();
                    }, 1000);
                }
            }, 500);
        }
        
        // Test direct du bouton après un délai pour vérifier qu'il existe
        setTimeout(() => {
            const testBtn = document.getElementById('edit-avatar-btn');
            console.log('🧪 Test du bouton edit-avatar-btn:', testBtn);
            if (testBtn) {
                console.log('✅ Bouton trouvé dans le DOM');
                console.log('📋 Attributs du bouton:', {
                    id: testBtn.id,
                    hasListener: testBtn.hasAttribute('data-listener-attached'),
                    onclick: testBtn.onclick,
                    classList: Array.from(testBtn.classList)
                });
                // Tester si le clic fonctionne
                testBtn.addEventListener('click', function(e) {
                    console.log('🎯 CLIC DÉTECTÉ DIRECTEMENT SUR LE BOUTON!');
                }, { once: true });
            } else {
                console.error('❌ Bouton edit-avatar-btn NON TROUVÉ dans le DOM');
            }
        }, 2000);
        
        // Gérer l'édition du nom d'utilisateur
        let originalUsername = '';
        const usernameInput = document.getElementById('username-display');
        const usernameEditBtn = document.getElementById('username-edit-btn');
        const usernameCancelBtn = document.getElementById('username-cancel-btn');
        const usernameStatus = document.getElementById('username-status');
        const usernameCooldown = document.getElementById('username-cooldown');
        
        // Afficher le cooldown au chargement
        function updateCooldownDisplay() {
            const cooldown = canChangeUsername();
            if (cooldown.daysRemaining > 0) {
                var cooldownMsg = (window.t && window.t('profile.pseudo_cooldown_days')) || 'Vous pourrez modifier votre pseudo dans {{n}} jour(s)';
                usernameCooldown.innerHTML = '<i class="fas fa-clock"></i> ' + (cooldownMsg.replace(/\{\{n\}\}/g, cooldown.daysRemaining));
                usernameCooldown.classList.add('active');
                usernameInput.setAttribute('readonly', 'readonly');
            } else {
                usernameCooldown.innerHTML = '<i class="fas fa-info-circle"></i> ' + ((window.t && window.t('profile.pseudo_edit_hint_30days')) || 'Vous pouvez modifier votre pseudo (une fois tous les 30 jours)');
                usernameCooldown.classList.remove('active');
                usernameInput.removeAttribute('readonly');
            }
        }
        
        // Activer le mode édition
        usernameInput.addEventListener('click', function() {
            const cooldown = canChangeUsername();
            if (!cooldown.canChange) {
                return;
            }
            
            if (this.hasAttribute('readonly')) {
                return;
            }
            
            originalUsername = this.value;
            this.removeAttribute('readonly');
            this.style.cursor = 'text';
            usernameEditBtn.style.display = 'flex';
            usernameCancelBtn.style.display = 'flex';
            usernameStatus.textContent = '';
        });
        
        // Validation en temps réel
        usernameInput.addEventListener('input', function() {
            if (this.hasAttribute('readonly')) return;
            
            const username = this.value.trim();
            if (username === originalUsername) {
                usernameStatus.textContent = '';
                return;
            }
            
            const validation = validateUsername(username);
            if (validation.valid) {
                usernameStatus.textContent = '✓ Pseudo disponible';
                usernameStatus.className = 'username-status success';
            } else {
                usernameStatus.textContent = validation.errors[0];
                usernameStatus.className = 'username-status error';
            }
        });
        
        // Sauvegarder le nom d'utilisateur
        usernameEditBtn.addEventListener('click', async function() {
            const username = usernameInput.value.trim();
            const validation = validateUsername(username);
            
            if (!validation.valid) {
                usernameStatus.textContent = validation.errors[0];
                usernameStatus.className = 'username-status error';
                return;
            }
            
            if (username === originalUsername) {
                usernameInput.setAttribute('readonly', 'readonly');
                usernameEditBtn.style.display = 'none';
                usernameCancelBtn.style.display = 'none';
                usernameStatus.textContent = '';
                return;
            }
            
            // Mettre à jour le nom d'utilisateur
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            if (user && user.email) {
                // Mettre à jour dans les comptes
                const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                const accountIndex = accounts.findIndex(acc => acc.email === user.email);
                if (accountIndex !== -1) {
                    accounts[accountIndex].username = username;
                    localStorage.setItem('accounts', JSON.stringify(accounts));
                }
                // Synchroniser vers Firestore (pseudo disponible sur tous les domaines)
                if (window.profileAccountService) {
                    try {
                        await window.profileAccountService.setProfileAccountInfo(user.email, { username });
                    } catch (e) { console.error('Firestore pseudo:', e); }
                }
                
                // Mettre à jour l'utilisateur
                user.name = username;
                localStorage.setItem('user', JSON.stringify(user));
                
                // Sauvegarder aussi dans le profil pour la persistance
                const profileData = localStorage.getItem('profile_' + user.email);
                if (profileData) {
                    try {
                        const savedProfile = JSON.parse(profileData);
                        savedProfile.name = username;
                        savedProfile.username = username;
                        localStorage.setItem('profile_' + user.email, JSON.stringify(savedProfile));
                    } catch (e) {
                        console.error('Erreur lors de la sauvegarde du profil:', e);
                    }
                } else {
                    // Créer un nouveau profil si il n'existe pas
                    const newProfile = {
                        name: username,
                        username: username,
                        email: user.email,
                        picture: user.picture || null,
                        theme: user.theme || 'dark',
                        language: user.language || 'fr'
                    };
                    localStorage.setItem('profile_' + user.email, JSON.stringify(newProfile));
                }
                
                // Sauvegarder la date de modification
                localStorage.setItem('lastUsernameChange_' + user.email, new Date().toISOString());
                
                // Mettre à jour l'affichage partout sans rafraîchir
                const usernameDisplayEl = document.getElementById('username-display');
                if (usernameDisplayEl) usernameDisplayEl.value = username;
                const userNameText = document.getElementById('user-name-text');
                if (userNameText) userNameText.textContent = username;
                if (typeof window.updateUserNameDisplay === 'function') {
                    window.updateUserNameDisplay(username, user.email);
                }
                
                // Mettre à jour dans le header (si présent)
                const headerUserName = document.querySelector('.user-name, .username-display');
                if (headerUserName) {
                    headerUserName.textContent = username;
                }
                
                // Mettre à jour dans la navigation (lien profil) - garder juste "Profil"
                const profileLink = document.querySelector('a[href="profil.html"]');
                if (profileLink) {
                    profileLink.textContent = 'Profil';
                }
                
                // Mettre à jour dans les autres éléments qui pourraient afficher le nom
                document.querySelectorAll('[data-username], .username, .user-name').forEach(el => {
                    if (el.id !== 'username-display') {
                        el.textContent = username;
                    }
                });
                
                usernameInput.setAttribute('readonly', 'readonly');
                usernameEditBtn.style.display = 'none';
                usernameCancelBtn.style.display = 'none';
                usernameStatus.textContent = '✓ Pseudo modifié avec succès';
                usernameStatus.className = 'username-status success';
                
                // Mettre à jour le cooldown
                updateCooldownDisplay();
                
                setTimeout(() => {
                    usernameStatus.textContent = '';
                }, 3000);
            }
        });
        
        // Annuler l'édition
        usernameCancelBtn.addEventListener('click', function() {
            usernameInput.value = originalUsername;
            usernameInput.setAttribute('readonly', 'readonly');
            usernameEditBtn.style.display = 'none';
            usernameCancelBtn.style.display = 'none';
            usernameStatus.textContent = '';
        });
        
        // Initialiser l'affichage du cooldown après le chargement de la page
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(() => {
                    updateCooldownDisplay();
                }, 100);
            });
        } else {
            setTimeout(() => {
                updateCooldownDisplay();
            }, 100);
        }

        // Appeler la fonction de configuration du logout après que le DOM soit prêt
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                window.setupLogoutHandler();
            });
        } else {
            // DOM déjà chargé
            window.setupLogoutHandler();
        }

        // Mettre à jour le profil
        function updateProfile(user) {
            const userAvatar = document.getElementById('user-avatar');
            const profileAvatar = document.getElementById('profile-avatar');
            
            if (userAvatar || profileAvatar) {
                const avatarKey = 'avatar_' + user.email;
                let avatarUrl = null;
                
                // Prioriser l'avatar personnalisé (le plus récent)
                if (user.customAvatar) {
                    avatarUrl = user.customAvatar;
                } else if (user.avatar) {
                    avatarUrl = user.avatar;
                } else if (user.originalAvatar) {
                    avatarUrl = user.originalAvatar;
                } else if (user.picture) {
                    avatarUrl = user.picture;
                } else {
                    // En dernier recours, vérifier le localStorage
                    const storedAvatar = localStorage.getItem(avatarKey);
                    if (storedAvatar) {
                        avatarUrl = storedAvatar;
                        // Mettre à jour l'objet user avec l'avatar trouvé
                        user.customAvatar = storedAvatar;
                        user.avatar = storedAvatar;
                    } else {
                        avatarUrl = '';
                    }
                }
                
                // Appliquer l'avatar trouvé
                if (avatarUrl) {
                    if (userAvatar) userAvatar.src = avatarUrl;
                    if (profileAvatar) profileAvatar.src = avatarUrl;
                    
                    // Mettre à jour le localStorage avec l'avatar le plus récent
                    if (user.customAvatar || user.avatar || user.originalAvatar || user.picture) {
                        localStorage.setItem(avatarKey, avatarUrl);
                    }
                }
            }
            
            // Mettre à jour le nom d'utilisateur avec le badge certifié
            if (typeof window.updateUserNameDisplay === 'function') {
                // updateUserNameDisplay est maintenant async, mais on peut l'appeler sans await
                window.updateUserNameDisplay(user.name || user.email, user.email).catch(err => {
                    console.warn('Erreur lors de la mise à jour du badge:', err);
                });
            } else {
                const userNameText = document.getElementById('user-name-text');
                if (userNameText) {
                    userNameText.textContent = user.name || user.email;
                }
            }
            
            // Rediriger vers le profil
            localStorage.setItem('user', JSON.stringify(user));
            window.location.href = '/profil.html';
        }

    // Décoder le token JWT
    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('')
                .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
                .join(''));
            return JSON.parse(jsonPayload);
        } catch (error) {
            console.error('Erreur de décodage du token:', error);
            return null;
        }
    }

        // Variable pour éviter les appels multiples
        let isSyncing = false;
        
        // FONCTION CENTRALISÉE : Charger et synchroniser TOUTES les données utilisateur
        async function syncAndLoadUserData() {
            // Éviter les appels multiples simultanés
            if (isSyncing) {
                return;
            }
            isSyncing = true;
            
            const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
            if (!currentUser || !currentUser.email) {
                isSyncing = false;
                return;
            }
            
            // Utiliser currentUser au lieu de user pour éviter les problèmes de scope
            const user = currentUser;
            
            // 1. Récupérer depuis accounts (source principale pour pseudo, langue, pays)
            const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
            const account = accounts.find(acc => acc.email === user.email);
            if (account) {
                // Synchroniser TOUTES les données du compte
                user.name = account.username || account.name || user.name;
                user.username = account.username || user.username;
                user.language = account.language || user.language;
                user.country = account.country || user.country || account.continent || user.continent;
                user.continent = account.continent || user.continent;
                // Ne PAS écraser l'avatar si user.avatar ou user.customAvatar est déjà défini
                // (pour éviter d'écraser une nouvelle photo qui vient d'être uploadée)
                if (!user.customAvatar && !user.avatar && (account.customAvatar || account.avatar)) {
                    user.avatar = account.customAvatar || account.avatar;
                    user.customAvatar = account.customAvatar || account.avatar;
                }
                // Préserver aussi les autres données importantes
                if (account.minor !== undefined) user.minor = account.minor;
            }
            
            // 2. Récupérer depuis profile_ (source secondaire)
            const profileData = localStorage.getItem('profile_' + user.email);
            if (profileData) {
                try {
                    const savedProfile = JSON.parse(profileData);
                    // Mettre à jour l'utilisateur avec les données sauvegardées (sans écraser ce qui vient de accounts)
                    // Prioriser l'avatar depuis profile_ si pas déjà défini depuis accounts
                    if (!user.customAvatar && !user.avatar) {
                        user.customAvatar = savedProfile.customAvatar || savedProfile.avatar;
                        user.avatar = savedProfile.customAvatar || savedProfile.avatar;
                    }
                    user.originalAvatar = user.originalAvatar || savedProfile.originalAvatar;
                    user.theme = user.theme || savedProfile.theme || 'dark';
                    user.language = user.language || savedProfile.language || user.language || 'fr';
                    user.country = user.country || savedProfile.country || savedProfile.continent || user.continent;
                    user.continent = user.continent || savedProfile.continent || user.continent;
                    user.description = user.description || savedProfile.description;
                    
                    // Récupérer le nom d'utilisateur depuis le profil sauvegardé (si pas déjà défini)
                    if (!user.name && (savedProfile.name || savedProfile.username)) {
                        user.name = savedProfile.name || savedProfile.username;
                        user.username = savedProfile.username || savedProfile.name;
                    }
                } catch (e) {
                    console.error('Erreur lors du chargement du profil:', e);
                }
            }
            
            // 2b. Récupérer la description depuis la clé dédiée si nécessaire
            if (!user.description) {
                const descriptionKey = 'profile_description_' + user.email;
                const storedDescription = localStorage.getItem(descriptionKey);
                if (storedDescription) {
                    user.description = storedDescription;
                }
            }
            
            // 3. Récupérer l'avatar depuis la clé dédiée (priorité sur les autres sources)
            // Ne PAS écraser si user.avatar ou user.customAvatar est déjà défini
            // (pour éviter d'écraser une nouvelle photo qui vient d'être uploadée)
            if (!user.customAvatar && !user.avatar) {
                const avatarKey = 'avatar_' + user.email;
                const storedAvatar = localStorage.getItem(avatarKey);
                if (storedAvatar) {
                    // Prioriser l'avatar depuis localStorage (le plus récent)
                    user.customAvatar = storedAvatar;
                    user.avatar = storedAvatar;
                    console.log('✅ Avatar récupéré depuis localStorage:', storedAvatar.substring(0, 50) + '...');
                } else {
                    console.log('⚠️ Aucun avatar trouvé dans localStorage ni dans user');
                }
            } else {
                console.log('✅ Avatar déjà défini dans user, conservation:', (user.customAvatar || user.avatar).substring(0, 50) + '...');
            }
            
            // 4. Charger le statut de certification depuis Firestore
            let isVerified = false;
            if (window.verificationService && typeof window.verificationService.isUserVerified === 'function') {
                try {
                    isVerified = await window.verificationService.isUserVerified(user.email);
                    user.verified = isVerified;
                    console.log('✅ Statut de certification chargé depuis Firestore:', isVerified);
                    // Mettre à jour aussi localStorage pour compatibilité
                    const verified = JSON.parse(localStorage.getItem('verified_users') || '[]');
                    if (isVerified && !verified.includes(user.email)) {
                        verified.push(user.email);
                        localStorage.setItem('verified_users', JSON.stringify(verified));
                    } else if (!isVerified && verified.includes(user.email)) {
                        const index = verified.indexOf(user.email);
                        if (index > -1) {
                            verified.splice(index, 1);
                            localStorage.setItem('verified_users', JSON.stringify(verified));
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ Erreur lors du chargement du statut de certification depuis Firestore:', error);
                    // Fallback vers localStorage
                    const verified = JSON.parse(localStorage.getItem('verified_users') || '[]');
                    isVerified = verified.includes(user.email);
                    user.verified = isVerified;
                }
            } else {
                // Fallback vers localStorage si Firebase n'est pas disponible
                const verified = JSON.parse(localStorage.getItem('verified_users') || '[]');
                isVerified = verified.includes(user.email);
                user.verified = isVerified;
            }
            
            // 5. Sauvegarder l'objet user complet avec toutes les données synchronisées
            localStorage.setItem('user', JSON.stringify(user));
            
            // 6. AFFICHER toutes les données dans l'interface
            displayUserData(user);
            
            // 7. Mettre à jour le badge IMMÉDIATEMENT avec le statut déjà chargé (sans délai)
            const updateBadgeDisplay = () => {
                const verifiedBadge = document.getElementById('verified-badge');
                if (verifiedBadge) {
                    verifiedBadge.style.display = isVerified ? 'inline-flex' : 'none';
                    console.log('✅ Badge de certification mis à jour IMMÉDIATEMENT:', isVerified ? 'affiché' : 'masqué');
                    return true;
                }
                return false;
            };
            
            // Essayer immédiatement plusieurs fois de suite (sans délai)
            updateBadgeDisplay();
            updateBadgeDisplay();
            updateBadgeDisplay();
            
            // Si pas trouvé, essayer avec des délais très courts
            if (!updateBadgeDisplay()) {
                setTimeout(updateBadgeDisplay, 10);
                setTimeout(updateBadgeDisplay, 25);
                setTimeout(updateBadgeDisplay, 50);
            }
            
            // 8. Appeler aussi updateUserNameDisplay immédiatement (sans délai)
            if (typeof window.updateUserNameDisplay === 'function') {
                const displayName = user.name || user.username || user.email || 'Utilisateur';
                window.updateUserNameDisplay(displayName, user.email).catch(err => {
                    console.warn('Erreur lors de la mise à jour du badge:', err);
                });
            }
            
            // 9. Vérification périodique du badge (au cas où il serait chargé dynamiquement)
            const badgeCheckInterval = setInterval(() => {
                const verifiedBadge = document.getElementById('verified-badge');
                if (verifiedBadge) {
                    const success = updateBadgeDisplay();
                    if (success) {
                        // Si le badge est trouvé et mis à jour, arrêter la vérification périodique après 5 secondes
                        setTimeout(() => clearInterval(badgeCheckInterval), 5000);
                    }
                }
            }, 1000);
            
            // Arrêter la vérification après 10 secondes maximum
            setTimeout(() => clearInterval(badgeCheckInterval), 10000);
            
            // 5b. Forcer la mise à jour de l'avatar après un court délai pour s'assurer que le DOM est prêt
            setTimeout(() => {
                const userAvatar = document.getElementById('user-avatar');
                const profileAvatar = document.getElementById('profile-avatar');
                const avatarUrl = user.customAvatar || user.avatar || user.originalAvatar || user.picture || '';
                if (avatarUrl && (userAvatar || profileAvatar)) {
                    console.log('🔄 Mise à jour forcée de l\'avatar:', avatarUrl.substring(0, 50) + '...');
                    if (userAvatar && userAvatar.src !== avatarUrl) {
                        userAvatar.src = avatarUrl;
                    }
                    if (profileAvatar && profileAvatar.src !== avatarUrl) {
                        profileAvatar.src = avatarUrl;
                    }
                }
            }, 100);
            
            // 6. Recharger la bannière (cache affiché tout de suite dans loadBanner)
            setTimeout(async () => {
                if (typeof loadBanner === 'function') await loadBanner();
            }, 50);
            
            // Réinitialiser le flag après un court délai
            setTimeout(() => {
                isSyncing = false;
            }, 100);
        }
        
        // Fonction pour afficher toutes les données utilisateur dans l'interface
        function displayUserData(user) {
            if (!user || !user.email) return;
            
            // Afficher le pseudo
            const userNameText = document.getElementById('user-name-text');
            const displayName = user.name || user.username || user.email || 'Utilisateur';
            if (userNameText) {
                userNameText.textContent = displayName;
            }
            
            // Afficher le badge certifié IMMÉDIATEMENT (utiliser le statut déjà chargé si disponible)
            const verifiedBadge = document.getElementById('verified-badge');
            if (verifiedBadge) {
                // Utiliser le statut déjà chargé dans user.verified si disponible (le plus rapide)
                if (user.verified !== undefined) {
                    verifiedBadge.style.display = user.verified ? 'inline-flex' : 'none';
                    console.log('✅ Badge affiché IMMÉDIATEMENT avec statut déjà chargé:', user.verified);
                } else {
                    // Sinon, utiliser localStorage immédiatement (sans attendre Firestore)
                    const verifiedUsers = JSON.parse(localStorage.getItem('verified_users') || '[]');
                    const cachedVerified = verifiedUsers.includes(user.email);
                    verifiedBadge.style.display = cachedVerified ? 'inline-flex' : 'none';
                    console.log('✅ Badge affiché IMMÉDIATEMENT depuis cache localStorage:', cachedVerified);
                    
                    // Vérifier Firestore en arrière-plan (sans bloquer) pour mise à jour future
                    if (window.verificationService && typeof window.verificationService.isUserVerified === 'function') {
                        // Ne pas attendre, juste lancer la vérification
                        window.verificationService.isUserVerified(user.email).then(isVerified => {
                            if (isVerified !== cachedVerified) {
                                verifiedBadge.style.display = isVerified ? 'inline-flex' : 'none';
                                console.log('🔄 Badge mis à jour depuis Firestore (arrière-plan):', isVerified);
                            }
                        }).catch(() => {
                            // Ignorer les erreurs, on garde le cache
                        });
                    }
                }
            } else {
                console.warn('⚠️ Badge verified-badge non trouvé dans displayUserData');
            }
            
            // Afficher le pays (traduit selon la langue) — getCountryName si code pays, sinon ancien continent pour compat
            const profileCountryText = document.getElementById('profile-country-text');
            if (profileCountryText) {
                var countryCode = (user.country || '').toString().toLowerCase();
                if (!countryCode && user.continent) {
                    var continentToCountry = { 'europe': 'fr', 'amerique-nord': 'us', 'amerique-sud': 'br', 'afrique': 'other', 'asie': 'jp', 'oceanie': 'au', 'antartique': 'other', 'antarctique': 'other', 'amerique': 'us' };
                    countryCode = continentToCountry[(user.continent || '').toString().toLowerCase().replace(/\s+/g, '-')] || '';
                }
                if (countryCode && typeof window.getCountryName === 'function') {
                    profileCountryText.textContent = window.getCountryName(countryCode);
                } else if (countryCode) {
                    profileCountryText.textContent = countryCode.toUpperCase();
                } else {
                    profileCountryText.textContent = (window.t && window.t('profile.not_set')) || 'Non renseigné';
                }
            }
            
            // Afficher l'avatar (FORCER la mise à jour)
            const userAvatar = document.getElementById('user-avatar');
            const profileAvatar = document.getElementById('profile-avatar');
            const avatarUrl = user.customAvatar || user.avatar || user.originalAvatar || user.picture || '';
            
            if (avatarUrl) {
                console.log('🖼️ Affichage avatar:', avatarUrl.substring(0, 50) + '...');
                
                // Fonction pour charger l'avatar simplement
                function loadAvatar(imgElement, url) {
                    if (!imgElement) return;
                    
                    // Supprimer les anciens gestionnaires d'événements
                    imgElement.onerror = null;
                    imgElement.onload = null;
                    
                    // Définir directement l'URL
                    imgElement.src = url;
                    
                    // Gestionnaire de succès
                    imgElement.onload = function() {
                        console.log('✅ Avatar chargé avec succès');
                    };
                    
                    // Gestionnaire d'erreur (seulement pour logging, onerror dans le HTML gérera le fallback)
                    imgElement.onerror = function() {
                        console.warn('⚠️ Erreur lors du chargement de l\'avatar, le fallback HTML sera utilisé');
                    };
                }
                
                if (userAvatar) {
                    loadAvatar(userAvatar, avatarUrl);
                }
                if (profileAvatar) {
                    loadAvatar(profileAvatar, avatarUrl);
                }
            } else {
                // Si pas d'avatar, ne rien faire (l'image par défaut sera gérée par onerror dans le HTML)
                console.log('⚠️ Pas d\'avatar disponible');
            }
            
            // Afficher la description
            const profileDescriptionText = document.getElementById('profile-description-text');
            const profileDescriptionDisplay = document.getElementById('profile-description-display');
            const profileDescriptionWrapper = document.getElementById('profile-description-wrapper');
            
            // Logs désactivés pour éviter les logs infinis
            // console.log('📝 Chargement description pour:', user.email);
            // console.log('🔍 Éléments description:', {
            //     text: !!profileDescriptionText,
            //     display: !!profileDescriptionDisplay,
            //     wrapper: !!profileDescriptionWrapper
            // });
            
            if (profileDescriptionText) {
                // Charger depuis plusieurs sources
                const descriptionKey = 'profile_description_' + user.email;
                let description = localStorage.getItem(descriptionKey) || user.description || '';
                
                // console.log('📝 Description depuis clé dédiée:', description || 'vide');
                
                // Si pas trouvé, chercher dans profile_
                if (!description || !description.trim()) {
                    const profileData = localStorage.getItem('profile_' + user.email);
                    if (profileData) {
                        try {
                            const savedProfile = JSON.parse(profileData);
                            description = savedProfile.description || '';
                            // console.log('📝 Description depuis profile_:', description || 'vide');
                        } catch (e) {
                            console.error('Erreur parsing profile:', e);
                        }
                    }
                }
                
                if (description && description.trim()) {
                    // console.log('✅ Affichage description:', description);
                    profileDescriptionText.textContent = description;
                    if (profileDescriptionDisplay) {
                        profileDescriptionDisplay.classList.remove('empty');
                    }
                    // Afficher le wrapper si nécessaire
                    if (profileDescriptionWrapper) {
                        profileDescriptionWrapper.style.display = 'block';
                    }
                } else {
                    // console.log('⚠️ Aucune description trouvée');
                    profileDescriptionText.textContent = 'Écrivez votre description ici...';
                    if (profileDescriptionDisplay) {
                        profileDescriptionDisplay.classList.add('empty');
                    }
                    // Afficher le wrapper même si vide
                    if (profileDescriptionWrapper) {
                        profileDescriptionWrapper.style.display = 'block';
                    }
                }
            } else {
                console.warn('⚠️ Élément profile-description-text non trouvé');
            }
            
            // AFFICHER LES INFORMATIONS DU COMPTE dans la section Paramètres
            loadAccountInfo(user);
            
            // Mettre à jour le nom d'utilisateur avec le badge certifié
            if (typeof window.updateUserNameDisplay === 'function') {
                window.updateUserNameDisplay(displayName, user.email);
            }
        }
        
        // Fonction pour charger et afficher les informations du compte
        function loadAccountInfo(user) {
            if (!user || !user.email) {
                console.warn('⚠️ loadAccountInfo: user ou email manquant');
                return;
            }
            
            console.log('📋 Chargement informations du compte pour:', user.email);
            
            // Récupérer depuis accounts (source principale)
            const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
            const account = accounts.find(acc => acc.email === user.email);
            
            console.log('📋 Account trouvé:', !!account, account ? {
                username: account.username,
                language: account.language,
                country: account.country,
                continent: account.continent
            } : 'aucun');
            
            // Nom d'utilisateur
            const usernameDisplay = document.getElementById('username-display');
            if (usernameDisplay) {
                const username = account?.username || user.name || user.username || user.email || '';
                usernameDisplay.value = username;
                // console.log('✅ Username affiché:', username);
            } else {
                console.warn('⚠️ username-display non trouvé');
            }
            
            // Email
            const emailDisplay = document.getElementById('email-display');
            if (emailDisplay) {
                const email = user.email || account?.email || '';
                emailDisplay.value = email;
                // console.log('✅ Email affiché:', email);
            } else {
                console.warn('⚠️ email-display non trouvé');
            }
            
            // Langue
            const languageDisplay = document.getElementById('language-display');
            if (languageDisplay) {
                const languageCode = account?.language || account?.langue || user.language || user.langue || 'fr';
                
                // Convertir le code langue en nom complet
                const langueNames = {
                    'fr': 'Français',
                    'en': 'English',
                    'de': 'Deutsch',
                    'es': 'Español',
                    'it': 'Italiano',
                    'ja': '日本語'
                };
                
                languageDisplay.value = langueNames[languageCode] || (languageCode && languageCode !== 'Non renseigné' ? languageCode : 'Non renseigné');
                // console.log('✅ Langue affichée:', languageDisplay.value);
            } else {
                console.warn('⚠️ language-display non trouvé');
            }
            
            // Pays (affichage traduit via getCountryName)
            const countryDisplay = document.getElementById('country-display');
            if (countryDisplay) {
                var rawC = account?.country || user.country || account?.continent || user.continent || '';
                var codeC = (rawC || '').toString().toLowerCase().replace(/\s+/g, '-');
                if (codeC && codeC.length <= 3) {
                    countryDisplay.value = (typeof window.getCountryName === 'function' ? window.getCountryName(codeC) : codeC.toUpperCase());
                    countryDisplay.dataset.countryCode = codeC;
                } else if (codeC) {
                    var continentToCountry = { 'europe': 'fr', 'amerique-nord': 'us', 'amerique-sud': 'br', 'afrique': 'other', 'asie': 'jp', 'oceanie': 'au', 'antartique': 'other', 'antarctique': 'other', 'amerique': 'us' };
                    var mapped = continentToCountry[codeC];
                    if (mapped) {
                        countryDisplay.value = (typeof window.getCountryName === 'function' ? window.getCountryName(mapped) : mapped.toUpperCase());
                        countryDisplay.dataset.countryCode = mapped;
                    } else {
                        countryDisplay.value = rawC;
                        countryDisplay.dataset.countryCode = codeC;
                    }
                } else {
                    countryDisplay.value = (window.t && window.t('profile.not_set')) || 'Non renseigné';
                    countryDisplay.dataset.countryCode = '';
                }
            } else {
                console.warn('⚠️ country-display non trouvé');
            }
            
            // Date d'inscription (mois traduit selon la langue)
            var joinDateDisplay = document.getElementById('join-date-display');
            if (joinDateDisplay) {
                var joinDate = account?.created_at || account?.createdAt || user.created_at || user.createdAt || user.joined_at || user.joinDate || '';
                var localeForDate = (typeof window.getDateLocale === 'function' ? window.getDateLocale() : 'fr-FR');
                var dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
                if (joinDate) {
                    try {
                        var date = new Date(joinDate);
                        if (!isNaN(date.getTime())) {
                            joinDateDisplay.value = date.toLocaleDateString(localeForDate, dateOptions);
                            joinDateDisplay.dataset.rawDate = joinDate;
                            console.log('✅ Date d\'inscription affichée:', joinDateDisplay.value);
                        } else {
                            throw new Error('Date invalide');
                        }
                    } catch (e) {
                        joinDateDisplay.value = joinDate;
                        joinDateDisplay.dataset.rawDate = '';
                        console.log('✅ Date d\'inscription affichée (raw):', joinDate);
                    }
                } else {
                    var defaultDate = new Date().toISOString();
                    var date = new Date(defaultDate);
                    joinDateDisplay.value = date.toLocaleDateString(localeForDate, dateOptions);
                    joinDateDisplay.dataset.rawDate = defaultDate;
                    console.log('⚠️ Date d\'inscription non trouvée, utilisation date actuelle:', joinDateDisplay.value);
                }
            } else {
                console.warn('⚠️ join-date-display non trouvé');
            }
            
            // console.log('✅ Informations du compte chargées et affichées');
        }
        
        // Variable pour stocker l'ID de l'intervalle
        let imagePersistenceInterval = null;
        
        // Appeler la synchronisation au chargement (après que le DOM soit prêt)
        function initializeProfileData() {
            // Nettoyer l'intervalle existant s'il y en a un
            if (imagePersistenceInterval) {
                clearInterval(imagePersistenceInterval);
                imagePersistenceInterval = null;
            }
            
            syncAndLoadUserData();
            setTimeout(() => { if (typeof loadBanner === 'function') loadBanner(); }, 50);
            
            // MÉCANISME DE PERSISTANCE : DÉSACTIVÉ TEMPORAIREMENT pour éviter les logs infinis
            // Réactivé plus tard si nécessaire avec une meilleure gestion
            /*
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            if (user && user.email) {
                imagePersistenceInterval = setInterval(() => {
                    const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
                    if (!currentUser || !currentUser.email) {
                        clearInterval(imagePersistenceInterval);
                        imagePersistenceInterval = null;
                        return;
                    }
                    // Code de persistance désactivé
                }, 5000);
            }
            */
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initializeProfileData();
                // S'assurer que le gestionnaire de déconnexion est configuré après le chargement
                setTimeout(() => {
                    if (typeof window.setupLogoutHandler === 'function') {
                        window.setupLogoutHandler();
                    }
                }, 500);
            });
        } else {
            // DOM déjà chargé
            initializeProfileData();
            // S'assurer que le gestionnaire de déconnexion est configuré
            setTimeout(() => {
                if (typeof window.setupLogoutHandler === 'function') {
                    window.setupLogoutHandler();
                }
            }, 500);
        }

            // Charger les préférences
            const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
            const themeSelect = document.getElementById('theme-select');
            const languageSelect = document.getElementById('language-select');
            
        if (themeSelect) {
            themeSelect.value = localStorage.getItem('theme') || currentUserForPrefs?.theme || 'dark';
        }
        if (languageSelect) {
            languageSelect.value = localStorage.getItem('language') || currentUserForPrefs?.language || 'fr';
        }
            
            // Gérer les changements de thème
            themeSelect?.addEventListener('change', function() {
                const theme = this.value;
                localStorage.setItem('theme', theme);
                document.body.className = theme;
            });
            
            // Gérer les changements de langue
            languageSelect?.addEventListener('change', function() {
                const language = this.value;
                localStorage.setItem('language', language);
                // Ici, vous pouvez ajouter la logique pour changer la langue
            });

    // Mettre à jour l'avatar si nécessaire
    const currentUserForUpdate = JSON.parse(localStorage.getItem('user') || 'null');
    if (currentUserForUpdate) {
        // Appeler syncAndLoadUserData pour recharger toutes les données
        if (typeof syncAndLoadUserData === 'function') {
            syncAndLoadUserData();
        }
        // Appeler aussi updateProfile pour compatibilité
        if (typeof updateProfile === 'function') {
            updateProfile(currentUserForUpdate);
        }
    }
    </script>
    
    <!-- Définir setupLogoutHandler AVANT window.onload pour qu'elle soit disponible immédiatement -->
    <script>
        // Gérer la déconnexion (unifié) - Fonction globale définie AVANT window.onload
        window.setupLogoutHandler = function() {
            const logoutButtons = document.querySelectorAll('.logout-btn, #logout-btn');
            
            if (logoutButtons.length === 0) {
                // Réessayer après un délai si le bouton n'est pas encore dans le DOM
                setTimeout(() => {
                    window.setupLogoutHandler();
                }, 500);
                return;
            }
            
            logoutButtons.forEach((logoutBtn, index) => {
                // Retirer les anciens listeners pour éviter les doublons
                const newBtn = logoutBtn.cloneNode(true);
                logoutBtn.parentNode.replaceChild(newBtn, logoutBtn);
                
                newBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Afficher un popup de confirmation élégant
                    if (typeof showToast === 'function') {
                        // Créer un popup de confirmation personnalisé avec style moderne
                        const confirmOverlay = document.createElement('div');
                        confirmOverlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); z-index: 10000; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease;';
                        
                        const confirmPopup = document.createElement('div');
                        confirmPopup.style.cssText = 'background: linear-gradient(135deg, rgba(35, 38, 47, 0.98) 0%, rgba(42, 45, 54, 0.98) 100%); border: 2px solid rgba(255, 107, 107, 0.3); border-radius: 24px; padding: 0; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), 0 0 40px rgba(255, 107, 107, 0.2); overflow: hidden; animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative;';
                        
                        // Ajouter une ligne décorative en haut avec effet de brillance
                        const topBar = document.createElement('div');
                        topBar.style.cssText = 'height: 4px; background: linear-gradient(90deg, #ff6b6b 0%, #ee5a6f 50%, #ff6b6b 100%); width: 100%; position: relative; overflow: hidden;';
                        const shineBar = document.createElement('div');
                        shineBar.style.cssText = 'position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent); animation: shine 2s infinite;';
                        topBar.appendChild(shineBar);
                        
                        const popupContent = document.createElement('div');
                        popupContent.style.cssText = 'padding: 2.5rem;';
                        
                        popupContent.innerHTML = `
                            <div style="text-align: center; margin-bottom: 2rem;">
                                <div style="width: 80px; height: 80px; margin: 0 auto 1.5rem; background: linear-gradient(135deg, rgba(255, 107, 107, 0.2) 0%, rgba(238, 90, 111, 0.2) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid rgba(255, 107, 107, 0.3); position: relative; animation: pulseIcon 2s ease-in-out infinite;">
                                    <i class="fas fa-sign-out-alt" style="font-size: 2.5rem; color: #ff6b6b; transform: rotate(-90deg); z-index: 1;"></i>
                                    <div style="position: absolute; width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle, rgba(255, 107, 107, 0.1) 0%, transparent 70%); animation: ripple 2s ease-out infinite;"></div>
                                </div>
                                <h3 style="margin: 0 0 0.75rem 0; color: #f5f6fa; font-size: 1.75rem; font-weight: 700; letter-spacing: -0.5px; background: linear-gradient(135deg, #f5f6fa 0%, #a5b1c2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                                    ${window.t ? window.t('profile.logout_confirm_title') : 'Confirmer la déconnexion'}
                                </h3>
                                <p style="margin: 0; color: #a5b1c2; line-height: 1.6; font-size: 1rem;">
                                    ${window.t ? window.t('profile.logout_confirm_message') : 'Êtes-vous sûr de vouloir vous déconnecter ?'}<br>
                                    <span style="color: #747d8c; font-size: 0.9rem;">${window.t ? window.t('profile.logout_confirm_sub') : 'Vous devrez vous reconnecter pour accéder à votre compte.'}</span>
                                </p>
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: center;">
                                <button id="logout-cancel-btn" style="padding: 0.875rem 2rem; border: 2px solid #2f3542; background: rgba(47, 53, 66, 0.5); color: #a5b1c2; border-radius: 12px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-weight: 600; font-size: 1rem; flex: 1; max-width: 150px; position: relative; overflow: hidden;">
                                    <span style="position: relative; z-index: 1;">${window.t ? window.t('profile.cancel') : 'Annuler'}</span>
                                </button>
                                <button id="logout-confirm-btn" style="padding: 0.875rem 2rem; border: none; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border-radius: 12px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-weight: 600; font-size: 1rem; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); flex: 1; max-width: 150px; position: relative; overflow: hidden;">
                                    <span style="position: relative; z-index: 1;">${window.t ? window.t('profile.logout') : 'Déconnexion'}</span>
                                </button>
                            </div>
                        `;
                        
                        confirmPopup.appendChild(topBar);
                        confirmPopup.appendChild(popupContent);
                        
                        // Ajouter les styles d'animation élégants
                        if (!document.getElementById('logout-popup-styles')) {
                            const style = document.createElement('style');
                            style.id = 'logout-popup-styles';
                            style.textContent = `
                                @keyframes fadeIn {
                                    from { opacity: 0; }
                                    to { opacity: 1; }
                                }
                                @keyframes slideUp {
                                    from { 
                                        opacity: 0;
                                        transform: translateY(30px) scale(0.95);
                                    }
                                    to { 
                                        opacity: 1;
                                        transform: translateY(0) scale(1);
                                    }
                                }
                                @keyframes pulseIcon {
                                    0%, 100% { 
                                        transform: scale(1);
                                        box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.4);
                                    }
                                    50% { 
                                        transform: scale(1.05);
                                        box-shadow: 0 0 0 10px rgba(255, 107, 107, 0);
                                    }
                                }
                                @keyframes ripple {
                                    0% {
                                        transform: scale(0.8);
                                        opacity: 1;
                                    }
                                    100% {
                                        transform: scale(1.4);
                                        opacity: 0;
                                    }
                                }
                                @keyframes shine {
                                    0% { left: -100%; }
                                    100% { left: 100%; }
                                }
                                #logout-cancel-btn::before {
                                    content: '';
                                    position: absolute;
                                    top: 50%;
                                    left: 50%;
                                    width: 0;
                                    height: 0;
                                    border-radius: 50%;
                                    background: rgba(255, 255, 255, 0.1);
                                    transform: translate(-50%, -50%);
                                    transition: width 0.6s, height 0.6s;
                                }
                                #logout-cancel-btn:hover::before {
                                    width: 300px;
                                    height: 300px;
                                }
                                #logout-confirm-btn::before {
                                    content: '';
                                    position: absolute;
                                    top: 50%;
                                    left: 50%;
                                    width: 0;
                                    height: 0;
                                    border-radius: 50%;
                                    background: rgba(255, 255, 255, 0.2);
                                    transform: translate(-50%, -50%);
                                    transition: width 0.6s, height 0.6s;
                                }
                                #logout-confirm-btn:hover::before {
                                    width: 300px;
                                    height: 300px;
                                }
                                #logout-cancel-btn:hover {
                                    background: rgba(47, 53, 66, 0.8) !important;
                                    border-color: #3d4452 !important;
                                    color: #f5f6fa !important;
                                    transform: translateY(-2px);
                                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                                }
                                #logout-confirm-btn:hover {
                                    background: linear-gradient(135deg, #ee5a6f 0%, #ff6b6b 100%) !important;
                                    transform: translateY(-2px);
                                    box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5);
                                }
                                #logout-cancel-btn:active {
                                    transform: translateY(0) scale(0.98);
                                }
                                #logout-confirm-btn:active {
                                    transform: translateY(0) scale(0.98);
                                }
                            `;
                            document.head.appendChild(style);
                        }
                        
                        confirmOverlay.appendChild(confirmPopup);
                        document.body.appendChild(confirmOverlay);
                        
                        // Gérer l'annulation
                        document.getElementById('logout-cancel-btn').addEventListener('click', function() {
                            document.body.removeChild(confirmOverlay);
                        });
                        
                        // Gérer la confirmation
                        document.getElementById('logout-confirm-btn').addEventListener('click', async function() {
                            document.body.removeChild(confirmOverlay);
                            
                            // Arrêter l'intervalle de persistance des images si défini
                            if (typeof window.imagePersistenceInterval !== 'undefined' && window.imagePersistenceInterval) {
                                clearInterval(window.imagePersistenceInterval);
                                window.imagePersistenceInterval = null;
                            }
                            
                            try {
                                // Utiliser la fonction handleLogout de auth.js si disponible
                                if (typeof window.handleLogout === 'function') {
                                    await window.handleLogout();
                                } else {
                                    // Fallback : déconnexion manuelle
                                    try {
                                        const { authService } = await import('/js/firebase-service.js');
                                        await authService.signOut();
                                    } catch (error) {
                                        // Ignorer les erreurs Firebase silencieusement
                                    }
                                    localStorage.removeItem('user');
                                    localStorage.removeItem('isLoggedIn');
                                    localStorage.removeItem('rememberMe');
                                    window.location.href = '/pages/acceuil.html';
                                }
                            } catch (error) {
                                // Nettoyer quand même localStorage
                                localStorage.removeItem('user');
                                localStorage.removeItem('isLoggedIn');
                                localStorage.removeItem('rememberMe');
                                window.location.href = '/pages/acceuil.html';
                            }
                        });
                        
                        // Fermer le popup en cliquant sur l'overlay
                        confirmOverlay.addEventListener('click', function(e) {
                            if (e.target === confirmOverlay) {
                                document.body.removeChild(confirmOverlay);
                            }
                        });
                    } else {
                        // Fallback : utiliser confirm() natif si showToast n'existe pas
                        if (!confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                            return;
                        }
                        
                        // Arrêter l'intervalle de persistance des images si défini
                        if (typeof window.imagePersistenceInterval !== 'undefined' && window.imagePersistenceInterval) {
                            clearInterval(window.imagePersistenceInterval);
                            window.imagePersistenceInterval = null;
                        }
                        
                        try {
                            // Utiliser la fonction handleLogout de auth.js si disponible
                            if (typeof window.handleLogout === 'function') {
                                await window.handleLogout();
                            } else {
                                // Fallback : déconnexion manuelle
                                try {
                                    const { authService } = await import('/js/firebase-service.js');
                                    await authService.signOut();
                                } catch (error) {
                                    // Ignorer les erreurs Firebase silencieusement
                                }
                                localStorage.removeItem('user');
                                localStorage.removeItem('isLoggedIn');
                                localStorage.removeItem('rememberMe');
                                window.location.href = '/pages/acceuil.html';
                            }
                        } catch (error) {
                            // Nettoyer quand même localStorage
                            localStorage.removeItem('user');
                            localStorage.removeItem('isLoggedIn');
                            localStorage.removeItem('rememberMe');
                            window.location.href = '/pages/acceuil.html';
                        }
                    }
                });
            });
        };
    </script>
    
    <script>
      // Gestion de l'en-tête unifié
      // Fonction globale pour vérifier si un utilisateur est certifié (définie avant DOMContentLoaded)
      window.isUserVerified = async function(userEmail) {
          if (!userEmail) return false;
          try {
              // Vérifier d'abord dans Firestore
              if (window.verificationService && typeof window.verificationService.isUserVerified === 'function') {
                  const isVerified = await window.verificationService.isUserVerified(userEmail);
                  console.log('Vérification certification pour', userEmail, ':', isVerified, '(depuis Firestore)');
                  return isVerified;
              }
              
              // Fallback vers localStorage
              const verifiedUsers = JSON.parse(localStorage.getItem('verified_users') || '[]');
              const isVerified = verifiedUsers.includes(userEmail);
              console.log('Vérification certification pour', userEmail, ':', isVerified, 'Liste:', verifiedUsers, '(depuis localStorage)');
              return isVerified;
          } catch (e) {
              console.error('Erreur lors de la vérification de certification:', e);
              // Fallback vers localStorage
              const verifiedUsers = JSON.parse(localStorage.getItem('verified_users') || '[]');
              return verifiedUsers.includes(userEmail);
          }
      };
      
      
      // Fonction globale pour mettre à jour le nom d'utilisateur avec le badge certifié (définie avant DOMContentLoaded)
      window.updateUserNameDisplay = async function(name, userEmail) {
          console.log('updateUserNameDisplay appelé avec:', name, userEmail);
          
          // Fonction helper pour attendre qu'un élément soit disponible dans le DOM
          const waitForElement = (id, maxWait = 10000) => {
              return new Promise((resolve) => {
                  // Vérifier immédiatement
                  const immediateCheck = document.getElementById(id);
                  if (immediateCheck) {
                      console.log(`✅ Élément ${id} trouvé immédiatement`);
                      resolve(immediateCheck);
                      return;
                  }
                  
                  let elapsed = 0;
                  const checkInterval = 200;
                  let observer = null;
                  
                  // Créer un MutationObserver pour détecter les changements dans le DOM
                  if (document.body) {
                      observer = new MutationObserver(() => {
                          const el = document.getElementById(id);
                          if (el) {
                              if (observer) observer.disconnect();
                              console.log(`✅ Élément ${id} trouvé via MutationObserver`);
                              resolve(el);
                          }
                      });
                      
                      observer.observe(document.body, {
                          childList: true,
                          subtree: true,
                          attributes: false
                      });
                  }
                  
                  // Vérifier périodiquement aussi
                  const interval = setInterval(() => {
                      elapsed += checkInterval;
                      const el = document.getElementById(id);
                      if (el) {
                          clearInterval(interval);
                          if (observer) observer.disconnect();
                          console.log(`✅ Élément ${id} trouvé après ${elapsed}ms`);
                          resolve(el);
                      } else if (elapsed >= maxWait) {
                          clearInterval(interval);
                          if (observer) observer.disconnect();
                          console.warn(`⚠️ Élément ${id} non trouvé après ${maxWait}ms`);
                          resolve(null);
                      }
                  }, checkInterval);
              });
          };
          
          // Attendre que les éléments soient disponibles (réduit à 2 secondes max pour plus de rapidité)
          const userNameText = await waitForElement('user-name-text', 2000);
          const verifiedBadge = await waitForElement('verified-badge', 2000);
          
          console.log('userNameText trouvé:', !!userNameText);
          console.log('verifiedBadge trouvé:', !!verifiedBadge);
          
          if (userNameText) {
              userNameText.textContent = name;
          }
          
          if (verifiedBadge) {
              // Utiliser d'abord le cache localStorage pour un affichage immédiat
              const verifiedUsers = JSON.parse(localStorage.getItem('verified_users') || '[]');
              let isVerified = verifiedUsers.includes(userEmail);
              
              // Afficher immédiatement depuis le cache
              verifiedBadge.style.display = isVerified ? 'inline-flex' : 'none';
              console.log('✅ Badge affiché immédiatement depuis cache dans updateUserNameDisplay:', isVerified);
              
              // Vérifier dans Firestore en arrière-plan et mettre à jour si nécessaire (sans await pour ne pas bloquer)
              if (window.verificationService && typeof window.verificationService.isUserVerified === 'function') {
                  window.verificationService.isUserVerified(userEmail).then(firestoreVerified => {
                      if (firestoreVerified !== isVerified) {
                          verifiedBadge.style.display = firestoreVerified ? 'inline-flex' : 'none';
                          console.log('✅ Badge mis à jour depuis Firestore dans updateUserNameDisplay:', firestoreVerified);
                      }
                  }).catch((error) => {
                      console.warn('⚠️ Erreur verificationService, utilisation du cache:', error);
                  });
              } else if (window.isUserVerified && typeof window.isUserVerified === 'function') {
                  window.isUserVerified(userEmail).then(firestoreVerified => {
                      if (firestoreVerified !== isVerified) {
                          verifiedBadge.style.display = firestoreVerified ? 'inline-flex' : 'none';
                          console.log('✅ Badge mis à jour depuis isUserVerified:', firestoreVerified);
                      }
                  }).catch(() => {
                      // Garder l'affichage depuis le cache
                  });
              }
          } else {
              console.warn('⚠️ Badge certifié non trouvé dans le DOM après 5 secondes d\'attente');
              // Essayer une dernière fois après un délai plus long avec plusieurs tentatives
              const retryBadgeUpdate = async (attempt = 1, maxAttempts = 5) => {
                  const badge = document.getElementById('verified-badge');
                  if (badge) {
                      let isVerified = false;
                      if (window.verificationService && typeof window.verificationService.isUserVerified === 'function') {
                          isVerified = await window.verificationService.isUserVerified(userEmail);
                      } else if (window.isUserVerified && typeof window.isUserVerified === 'function') {
                          isVerified = await window.isUserVerified(userEmail);
                      } else {
                          const verifiedUsers = JSON.parse(localStorage.getItem('verified_users') || '[]');
                          isVerified = verifiedUsers.includes(userEmail);
                      }
                      badge.style.display = isVerified ? 'inline-flex' : 'none';
                      console.log('✅ Badge trouvé et mis à jour après délai supplémentaire:', isVerified);
                      return true;
                  } else if (attempt < maxAttempts) {
                      setTimeout(() => retryBadgeUpdate(attempt + 1, maxAttempts), 1000);
                  }
                  return false;
              };
              retryBadgeUpdate();
          }
      };

      document.addEventListener('DOMContentLoaded', function() {
        // Définir la fonction directement ici pour être sûr qu'elle est disponible
        if (typeof window.handleAvatarEditClick !== 'function') {
            // Fonction pour optimiser l'avatar avec qualité maximale (réutilisable)
            function optimizeAvatarQualityForUpload(file, maxSize = 2048, quality = 1.0) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            // Calculer les dimensions optimales en gardant le ratio (avatar carré)
                            if (width > maxSize || height > maxSize) {
                                const ratio = Math.min(maxSize / width, maxSize / height);
                                width = Math.round(width * ratio);
                                height = Math.round(height * ratio);
                            }
                            
                            // S'assurer que les dimensions sont des nombres entiers
                            width = Math.round(width);
                            height = Math.round(height);
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d', { 
                                alpha: true,  // Garder alpha pour les avatars (transparence possible)
                                willReadFrequently: false
                            });
                            
                            // Paramètres de qualité maximale pour le rendu
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';
                            
                            // Support cross-browser
                            ctx.webkitImageSmoothingEnabled = true;
                            ctx.mozImageSmoothingEnabled = true;
                            ctx.msImageSmoothingEnabled = true;
                            
                            // Rendre l'image avec la meilleure qualité possible
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Utiliser PNG pour qualité maximale (sans perte)
                            canvas.toBlob((blob) => {
                                if (blob) {
                                    // Créer un nouveau File avec le nom original
                                    const optimizedFile = new File([blob], file.name, {
                                        type: 'image/png',
                                        lastModified: Date.now()
                                    });
                                    resolve(optimizedFile);
                                } else {
                                    reject(new Error('Erreur lors de la conversion en blob'));
                                }
                            }, 'image/png', quality);
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
            
            window.handleAvatarEditClick = function(e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                console.log('📸 Clic sur le bouton Modifier la photo de profil');
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = async function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const user = JSON.parse(localStorage.getItem('user') || 'null');
                        if (!user || !user.email) {
                            console.error('❌ Utilisateur non trouvé');
                            return;
                        }
                        
                        try {
                            // Optimiser l'avatar avec qualité maximale (2048x2048, qualité 100%)
                            console.log('🎨 Optimisation de l\'avatar avec qualité maximale...');
                            const optimizedFile = await optimizeAvatarQualityForUpload(file, 2048, 1.0);
                            
                            // Afficher l'image optimisée immédiatement pour l'aperçu
                            const reader = new FileReader();
                            reader.onload = function(event) {
                                const userAvatar = document.getElementById('user-avatar');
                                const profileAvatar = document.getElementById('profile-avatar');
                                const previewUrl = event.target.result;
                                
                                // Afficher l'aperçu immédiatement
                                if (userAvatar) userAvatar.src = previewUrl;
                                if (profileAvatar) profileAvatar.src = previewUrl;
                            };
                            reader.readAsDataURL(optimizedFile);
                            
                            // Sauvegarder dans Firebase Storage et Firestore avec le fichier optimisé
                            if (window.avatarService && typeof window.avatarService.saveAvatar === 'function') {
                                try {
                                    console.log('📤 Upload avatar optimisé vers Firebase Storage...');
                                    const avatarUrl = await window.avatarService.saveAvatar(user.email, optimizedFile);
                                    console.log('✅ Avatar sauvegardé dans Firebase:', avatarUrl);
                                    
                                    // Mettre à jour l'affichage avec l'URL Firebase
                                    const userAvatar = document.getElementById('user-avatar');
                                    const profileAvatar = document.getElementById('profile-avatar');
                                    if (userAvatar) userAvatar.src = avatarUrl;
                                    if (profileAvatar) profileAvatar.src = avatarUrl;
                                    
                                    // Mettre à jour l'objet user
                                    user.customAvatar = avatarUrl;
                                    user.avatar = avatarUrl;
                                    localStorage.setItem('user', JSON.stringify(user));
                                    
                                    // IMPORTANT : Mettre à jour accounts AVANT syncAndLoadUserData pour éviter que l'ancienne photo soit rechargée
                                    const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                                    const accountIndex = accounts.findIndex(acc => acc.email === user.email);
                                    if (accountIndex !== -1) {
                                        accounts[accountIndex] = {
                                            ...accounts[accountIndex],
                                            avatar: avatarUrl,
                                            customAvatar: avatarUrl
                                        };
                                        localStorage.setItem('accounts', JSON.stringify(accounts));
                                    }
                                    
                                    // Mettre à jour aussi la clé dédiée avatar_
                                    localStorage.setItem('avatar_' + user.email, avatarUrl);
                                    
                                    // Mettre à jour profile_
                                    const profileKey = 'profile_' + user.email;
                                    const existingProfileData = localStorage.getItem(profileKey);
                                    let existingProfile = {};
                                    if (existingProfileData) {
                                        try {
                                            existingProfile = JSON.parse(existingProfileData);
                                        } catch (e) {
                                            console.error('Erreur parsing profile:', e);
                                        }
                                    }
                                    const updatedProfile = {
                                        ...existingProfile,
                                        customAvatar: avatarUrl,
                                        avatar: avatarUrl,
                                        email: user.email
                                    };
                                    localStorage.setItem(profileKey, JSON.stringify(updatedProfile));
                                    
                                    // Afficher un message de succès
                                    if (typeof showToast === 'function') {
                                        showToast('Succès', 'Avatar mis à jour avec succès !', 'success');
                                    }
                                    
                                    // Ne PAS appeler syncAndLoadUserData() car elle pourrait recharger l'ancienne photo
                                    // L'affichage est déjà mis à jour ci-dessus
                                } catch (error) {
                                    console.error('❌ Erreur lors de la sauvegarde de l\'avatar:', error);
                                    const errorMessage = error.message || error.toString() || '';
                                    
                                    if (error.code === 'storage/unauthorized' || errorMessage.includes('PERMISSION_DENIED')) {
                                        alert('❌ Erreur de permissions Firebase Storage.\n\nVérifiez que :\n1. Les règles Storage sont publiées dans Firebase Console → Storage → Rules\n2. Vous êtes bien connecté avec Firebase Auth\n3. Les règles permettent l\'écriture pour les utilisateurs authentifiés\n\nErreur : ' + errorMessage);
                                    } else {
                                        alert('❌ Erreur lors de l\'upload de l\'avatar.\n\nErreur : ' + errorMessage);
                                    }
                                }
                            } else {
                                console.error('❌ avatarService non disponible');
                                alert('❌ Firebase Storage n\'est pas disponible. Vérifiez que firebase-service.js est chargé.');
                            }
                        } catch (optimizeError) {
                            console.error('❌ Erreur lors de l\'optimisation de l\'avatar:', optimizeError);
                            alert('❌ Erreur lors de l\'optimisation de l\'avatar. Tentative avec le fichier original...');
                            
                            // Fallback : utiliser le fichier original si l'optimisation échoue
                            if (window.avatarService && typeof window.avatarService.saveAvatar === 'function') {
                                try {
                                    const avatarUrl = await window.avatarService.saveAvatar(user.email, file);
                                    const userAvatar = document.getElementById('user-avatar');
                                    const profileAvatar = document.getElementById('profile-avatar');
                                    if (userAvatar) userAvatar.src = avatarUrl;
                                    if (profileAvatar) profileAvatar.src = avatarUrl;
                                    user.customAvatar = avatarUrl;
                                    user.avatar = avatarUrl;
                                    localStorage.setItem('user', JSON.stringify(user));
                                    localStorage.setItem('avatar_' + user.email, avatarUrl);
                                } catch (error) {
                                    console.error('❌ Erreur lors de la sauvegarde avec fichier original:', error);
                                }
                            }
                        }
                    }
                };
                input.click();
            };
            console.log('✅ handleAvatarEditClick définie dans DOMContentLoaded');
        }
        
        // Attacher le gestionnaire d'événement pour le bouton avatar
        if (typeof attachAvatarEditHandler === 'function') {
            attachAvatarEditHandler();
        }
        
        // Utiliser la délégation d'événements pour s'assurer que le bouton fonctionne même s'il est dans un onglet
        document.addEventListener('click', function(e) {
            const target = e.target;
            // Vérifier si le clic est sur le bouton ou sur un élément à l'intérieur (comme l'icône)
            const btn = target.id === 'edit-avatar-btn' ? target : target.closest('#edit-avatar-btn');
            if (btn) {
                console.log('🎯 Clic détecté via délégation d\'événements sur edit-avatar-btn');
                e.preventDefault();
                e.stopPropagation();
                if (typeof window.handleAvatarEditClick === 'function') {
                    console.log('✅ Appel de handleAvatarEditClick...');
                    window.handleAvatarEditClick(e);
                } else {
                    console.error('❌ handleAvatarEditClick n\'est toujours pas une fonction!');
                }
            }
        });
        
        // Test supplémentaire : vérifier que le bouton existe et est cliquable
        // Utiliser window.onload pour s'assurer que tout est chargé
        window.addEventListener('load', function() {
            console.log('🔄 window.onload déclenché, vérification des éléments...');
            
            const testBtn = document.getElementById('edit-avatar-btn');
            if (testBtn) {
                console.log('✅ Bouton edit-avatar-btn trouvé dans window.onload');
                // Forcer l'attachement si ce n'est pas déjà fait
                if (!testBtn.hasAttribute('data-listener-attached')) {
                    console.log('🔧 Attachement forcé du gestionnaire...');
                    if (typeof attachAvatarEditHandler === 'function') {
                        attachAvatarEditHandler();
                    }
                }
            } else {
                console.error('❌ Bouton edit-avatar-btn NON TROUVÉ dans window.onload');
            }
            
            // Vérifier aussi les éléments du badge avec plusieurs méthodes
            let userNameText = document.getElementById('user-name-text');
            let verifiedBadge = document.getElementById('verified-badge');
            
            // Essayer aussi de trouver via querySelector
            if (!userNameText) {
                userNameText = document.querySelector('#user-name-text');
            }
            if (!verifiedBadge) {
                verifiedBadge = document.querySelector('#verified-badge');
            }
            
            // Essayer de trouver via le parent
            const userName = document.getElementById('user-name');
            if (userName && !userNameText) {
                userNameText = userName.querySelector('#user-name-text') || userName.querySelector('span[id="user-name-text"]');
            }
            if (userName && !verifiedBadge) {
                verifiedBadge = userName.querySelector('#verified-badge') || userName.querySelector('span[id="verified-badge"]');
            }
            
            console.log('🔍 Vérification des éléments badge dans window.onload:');
            console.log('  - userNameText:', !!userNameText, userNameText);
            console.log('  - verifiedBadge:', !!verifiedBadge, verifiedBadge);
            console.log('  - user-name parent:', !!userName, userName);
            
            // Si les éléments sont trouvés, forcer la mise à jour du badge
            if (userNameText && verifiedBadge) {
                const user = JSON.parse(localStorage.getItem('user') || 'null');
                if (user && user.email) {
                    console.log('🔄 Forcer la mise à jour du badge pour:', user.email);
                    if (typeof window.updateUserNameDisplay === 'function') {
                        const displayName = user.name || user.username || user.email || 'Utilisateur';
                        window.updateUserNameDisplay(displayName, user.email).catch(err => {
                            console.warn('Erreur lors de la mise à jour forcée du badge:', err);
                        });
                    }
                }
            } else {
                console.error('❌ Éléments badge toujours non trouvés dans window.onload');
                // Essayer de créer les éléments si le parent existe
                if (userName && !verifiedBadge) {
                    console.log('🔧 Tentative de création du badge si nécessaire...');
                    const existingBadge = userName.querySelector('.verified-badge');
                    if (!existingBadge) {
                        const badge = document.createElement('span');
                        badge.id = 'verified-badge';
                        badge.className = 'verified-badge';
                        badge.style.display = 'none';
                        badge.title = 'Compte certifié';
                        badge.innerHTML = '<i class="fas fa-check"></i>';
                        userName.appendChild(badge);
                        console.log('✅ Badge créé dynamiquement');
                    }
                }
            }
        });
        
        // Aussi vérifier dans DOMContentLoaded avec un délai plus long
        setTimeout(() => {
            const userNameText = document.getElementById('user-name-text');
            const verifiedBadge = document.getElementById('verified-badge');
            console.log('🔍 Vérification tardive (3s) des éléments badge:');
            console.log('  - userNameText:', !!userNameText);
            console.log('  - verifiedBadge:', !!verifiedBadge);
            
            if (userNameText && verifiedBadge) {
                const user = JSON.parse(localStorage.getItem('user') || 'null');
                if (user && user.email) {
                    console.log('🔄 Mise à jour tardive du badge pour:', user.email);
                    if (typeof window.updateUserNameDisplay === 'function') {
                        const displayName = user.name || user.username || user.email || 'Utilisateur';
                        window.updateUserNameDisplay(displayName, user.email).catch(err => {
                            console.warn('Erreur lors de la mise à jour tardive du badge:', err);
                        });
                    }
                }
            }
        }, 3000);
        
        // Gestion du sélecteur de recherche
        const searchType = document.getElementById('searchType');
        const searchInput = document.getElementById('searchInput');
        
        if (searchType && searchInput) {
          function updateSearchPlaceholder() {
            var type = searchType.value;
            searchInput.placeholder = (window.t && window.t('search.placeholder.' + type)) || (window.t && window.t('search.placeholder.generic')) || 'Rechercher...';
          }
          searchType.addEventListener('change', updateSearchPlaceholder);
          document.addEventListener('translationsApplied', updateSearchPlaceholder);
          updateSearchPlaceholder();
        }
        
        // Réafficher la date d'inscription avec le mois dans la nouvelle langue
        document.addEventListener('translationsApplied', function() {
          var joinDateDisplay = document.getElementById('join-date-display');
          if (joinDateDisplay && joinDateDisplay.dataset.rawDate) {
            var localeForDate = (typeof window.getDateLocale === 'function' ? window.getDateLocale() : 'fr-FR');
            var d = new Date(joinDateDisplay.dataset.rawDate);
            if (!isNaN(d.getTime())) {
              joinDateDisplay.value = d.toLocaleDateString(localeForDate, { year: 'numeric', month: 'long', day: 'numeric' });
            }
          }
        });
        
        // Vérifier si l'utilisateur est connecté
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        const menuToggle = document.getElementById('menuToggle');
        const navLinks = document.querySelector('.nav-links');
        const logoutBtn = document.getElementById('logout-btn');
        const userAvatar = document.getElementById('user-avatar');
        const profileAvatar = document.getElementById('profile-avatar');
        
        // Gestion du menu mobile
        if (menuToggle && navLinks) {
          menuToggle.addEventListener('click', function() {
            navLinks.classList.toggle('active');
            this.classList.toggle('active');
          });
        }
        
        // Vérification de l'état de connexion
        if (user && user.email) {
          // Utilisateur connecté
          if (logoutBtn) logoutBtn.style.display = 'inline-block';
          
          // Mettre à jour les avatars avec priorité sur l'avatar personnalisé (le plus récent)
          if (userAvatar || profileAvatar) {
            const avatarKey = 'avatar_' + user.email;
            let avatarUrl = null;
            
            // Prioriser l'avatar personnalisé (le plus récent)
            if (user.customAvatar) {
              avatarUrl = user.customAvatar;
            } else if (user.avatar) {
              avatarUrl = user.avatar;
            } else if (user.originalAvatar) {
              avatarUrl = user.originalAvatar;
            } else if (user.picture) {
              avatarUrl = user.picture;
            } else {
              // En dernier recours, vérifier le localStorage
              const storedAvatar = localStorage.getItem(avatarKey);
              if (storedAvatar) {
                avatarUrl = storedAvatar;
                // Mettre à jour l'objet user avec l'avatar trouvé
                user.customAvatar = storedAvatar;
                user.avatar = storedAvatar;
                localStorage.setItem('user', JSON.stringify(user));
              } else {
                avatarUrl = '';
              }
            }
            
            // Appliquer l'avatar trouvé
            if (avatarUrl) {
              if (userAvatar) userAvatar.src = avatarUrl;
              if (profileAvatar) profileAvatar.src = avatarUrl;
              
              // Mettre à jour le localStorage avec l'avatar le plus récent
              if (user.customAvatar || user.avatar || user.originalAvatar || user.picture) {
                localStorage.setItem(avatarKey, avatarUrl);
              }
            }
          }
          
          // Charger le profil sauvegardé pour récupérer le dernier pseudo
          const profileData = localStorage.getItem('profile_' + user.email);
          let displayName = user.name || user.email || 'Utilisateur';
          
          // PRIORITÉ : Récupérer le pseudo depuis les comptes sauvegardés
          const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
          const account = accounts.find(acc => acc.email === user.email);
          if (account && account.username) {
              displayName = account.username;
              console.log('✅ Pseudo récupéré depuis les comptes:', displayName);
          } else if (profileData) {
              try {
                  const savedProfile = JSON.parse(profileData);
                  if (savedProfile.name || savedProfile.username) {
                      displayName = savedProfile.name || savedProfile.username;
                  }
              } catch (e) {
                  console.error('Erreur lors du chargement du profil:', e);
              }
          }
          
          // Mettre à jour aussi dans user pour cohérence
          user.name = displayName;
          localStorage.setItem('user', JSON.stringify(user));
          
          // Mettre à jour le nom d'utilisateur avec le badge certifié
          if (typeof window.updateUserNameDisplay === 'function') {
              // updateUserNameDisplay est maintenant async, mais on peut l'appeler sans await
              window.updateUserNameDisplay(displayName, user.email).catch(err => {
                  console.warn('Erreur lors de la mise à jour du badge:', err);
              });
          } else {
              // Fallback si les fonctions ne sont pas encore définies
              const userNameText = document.getElementById('user-name-text');
              if (userNameText) {
                  userNameText.textContent = displayName;
              }
              // Vérifier le badge même en fallback
              const verifiedBadge = document.getElementById('verified-badge');
              if (verifiedBadge) {
                  // Vérifier dans Firestore si disponible
                  if (window.isUserVerified && typeof window.isUserVerified === 'function') {
                      window.isUserVerified(user.email).then(isVerified => {
                          verifiedBadge.style.display = isVerified ? 'inline-flex' : 'none';
                      }).catch(() => {
                          // Fallback vers localStorage
                          const verifiedUsers = JSON.parse(localStorage.getItem('verified_users') || '[]');
                          verifiedBadge.style.display = verifiedUsers.includes(user.email) ? 'inline-flex' : 'none';
                      });
                  } else {
                      // Fallback vers localStorage
                      const verifiedUsers = JSON.parse(localStorage.getItem('verified_users') || '[]');
                      verifiedBadge.style.display = verifiedUsers.includes(user.email) ? 'inline-flex' : 'none';
                  }
              }
          }
          
          // Forcer la mise à jour du badge après un court délai pour s'assurer qu'il s'affiche
          setTimeout(() => {
              if (typeof window.updateUserNameDisplay === 'function') {
                  window.updateUserNameDisplay(displayName, user.email);
              }
          }, 100);
          
          // Écouter les mises à jour de certification depuis la page admin
          window.addEventListener('verifiedUsersUpdated', function(event) {
              if (event.detail && event.detail.email === user.email) {
                  if (typeof window.updateUserNameDisplay === 'function') {
                      window.updateUserNameDisplay(displayName, user.email);
                  }
              }
          });
          
          // Écouter les changements dans localStorage pour les utilisateurs certifiés
          window.addEventListener('storage', function(event) {
              if (event.key === 'verified_users' && user && user.email) {
                  if (typeof window.updateUserNameDisplay === 'function') {
                      const userNameText = document.getElementById('user-name-text');
                      if (userNameText) {
                          window.updateUserNameDisplay(userNameText.textContent, user.email);
                      }
                  }
              }
          });
          
          // Charger et afficher le pays dans le badge du header (traduit via getCountryName)
          const profileCountryText = document.getElementById('profile-country-text');
          if (profileCountryText) {
              const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
              const account = accounts.find(acc => acc.email === user.email);
              var countryCode = (account?.country || user.country || '').toString().toLowerCase();
              if (!countryCode && (account?.continent || user.continent)) {
                  var continentToCountry = { 'europe': 'fr', 'amerique-nord': 'us', 'amerique-sud': 'br', 'afrique': 'other', 'asie': 'jp', 'oceanie': 'au', 'antartique': 'other', 'antarctique': 'other', 'amerique': 'us' };
                  countryCode = continentToCountry[(account?.continent || user.continent || '').toString().toLowerCase().replace(/\s+/g, '-')] || '';
              }
              if (countryCode && typeof window.getCountryName === 'function') {
                  profileCountryText.textContent = window.getCountryName(countryCode);
              } else if (countryCode) {
                  profileCountryText.textContent = countryCode.toUpperCase();
              } else {
                  profileCountryText.textContent = (window.t && window.t('profile.not_set')) || 'Non renseigné';
              }
          }
          
          // Mettre à jour les informations du compte dans les paramètres
          const usernameDisplay = document.getElementById('username-display');
          const emailDisplay = document.getElementById('email-display');
          const passwordDisplay = document.getElementById('password-display');
          const languageDisplay = document.getElementById('language-display');
          const countryDisplay = document.getElementById('country-display');
          const joinDateDisplay = document.getElementById('join-date-display');
          
          if (usernameDisplay) {
              usernameDisplay.value = displayName;
          }
          
          // Masquer l'email par défaut
          if (emailDisplay) {
              const fullEmail = user.email || 'Non renseigné';
              emailDisplay.dataset.fullEmail = fullEmail;
              // Masquer partiellement l'email (ex: ex***@example.com)
              if (fullEmail !== 'Non renseigné' && fullEmail.includes('@')) {
                  const [localPart, domain] = fullEmail.split('@');
                  const maskedLocal = localPart.length > 2 
                      ? localPart.substring(0, 2) + '***' 
                      : '***';
                  emailDisplay.value = maskedLocal + '@' + domain;
              } else {
                  emailDisplay.value = fullEmail;
              }
          }
          
          // Charger le mot de passe depuis les comptes
          if (passwordDisplay) {
              const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
              const account = accounts.find(acc => acc.email === user.email);
              const passwordToggleBtn = document.getElementById('password-toggle-btn');
              const passwordEditBtn = document.getElementById('password-edit-btn');
              
              if (account && account.password) {
                  // Vérifier si c'est un compte Google
                  if (account.password === 'google_oauth') {
                      passwordDisplay.type = 'text'; // Afficher en texte clair
                      // Utiliser la traduction
                      const tFn = window.t || (window.localization ? (key) => window.localization.get(key) : (key) => key);
                      passwordDisplay.value = tFn('profile.settings.no_password') || 'Aucun mot de passe requis';
                      passwordDisplay.disabled = true;
                      passwordDisplay.dataset.fullPassword = '';
                      // Masquer le bouton d'affichage du mot de passe
                      if (passwordToggleBtn) {
                          passwordToggleBtn.style.display = 'none';
                      }
                      // Masquer le bouton de modification du mot de passe
                      if (passwordEditBtn) {
                          passwordEditBtn.style.display = 'none';
                      }
                  } else {
                      passwordDisplay.type = 'password'; // S'assurer que c'est en mode password
                      passwordDisplay.dataset.fullPassword = account.password;
                      passwordDisplay.value = '••••••••••••';
                      // Afficher les boutons pour les comptes normaux
                      if (passwordToggleBtn) {
                          passwordToggleBtn.style.display = 'flex';
                      }
                      if (passwordEditBtn) {
                          passwordEditBtn.style.display = 'inline-flex';
                      }
                  }
              } else {
                  passwordDisplay.type = 'text'; // Afficher en texte clair
                  passwordDisplay.value = 'Non renseigné';
                  passwordDisplay.disabled = true;
                  passwordDisplay.dataset.fullPassword = '';
                  // Masquer les boutons si pas de mot de passe
                  if (passwordToggleBtn) {
                      passwordToggleBtn.style.display = 'none';
                  }
                  if (passwordEditBtn) {
                      passwordEditBtn.style.display = 'none';
                  }
              }
          }
          
          // Charger la langue depuis les comptes ou le profil
          if (languageDisplay) {
              const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
              const account = accounts.find(acc => acc.email === user.email);
              const userLangue = account?.langue || user.langue || user.language || 'Non renseigné';
              
              // Convertir le code langue en nom complet
              const langueNames = {
                  'fr': 'Français',
                  'en': 'English',
                  'de': 'Deutsch',
                  'es': 'Español',
                  'it': 'Italiano',
                  'ja': '日本語'
              };
              languageDisplay.value = langueNames[userLangue] || (userLangue && userLangue !== 'Non renseigné' ? userLangue : 'Non renseigné');
          }
          
          // Charger le pays depuis les comptes ou le profil (traduit via getCountryName)
          if (countryDisplay) {
              const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
              const account = accounts.find(acc => acc.email === user.email);
              var rawC = account?.country || user.country || account?.continent || user.continent || '';
              var codeC = (rawC || '').toString().toLowerCase().replace(/\s+/g, '-');
              if (codeC && codeC.length <= 3) {
                  countryDisplay.value = (typeof window.getCountryName === 'function' ? window.getCountryName(codeC) : codeC.toUpperCase());
                  countryDisplay.dataset.countryCode = codeC;
              } else if (codeC) {
                  var continentToCountry = { 'europe': 'fr', 'amerique-nord': 'us', 'amerique-sud': 'br', 'afrique': 'other', 'asie': 'jp', 'oceanie': 'au', 'antartique': 'other', 'antarctique': 'other', 'amerique': 'us' };
                  var mapped = continentToCountry[codeC];
                  if (mapped) {
                      countryDisplay.value = (typeof window.getCountryName === 'function' ? window.getCountryName(mapped) : mapped.toUpperCase());
                      countryDisplay.dataset.countryCode = mapped;
                  } else {
                      countryDisplay.value = rawC;
                      countryDisplay.dataset.countryCode = codeC;
                  }
              } else {
                  countryDisplay.value = (window.t && window.t('profile.not_set')) || 'Non renseigné';
                  countryDisplay.dataset.countryCode = '';
              }
          }
          
          if (joinDateDisplay) {
              // Utiliser la date de création du compte ou une date par défaut
              const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
              const account = accounts.find(acc => acc.email === user.email);
              // Gérer created_at et createdAt (camelCase)
              const joinDate = account?.created_at || account?.createdAt || user.created_at || user.createdAt || user.joinDate || user.joined_at || user.lastLogin || new Date().toISOString();
              try {
                  const date = new Date(joinDate);
                  if (!isNaN(date.getTime())) {
                      const formattedDate = date.toLocaleDateString('fr-FR', {
                          year: 'numeric',
                          month: 'long',
                          day: 'numeric'
                      });
                      joinDateDisplay.value = formattedDate;
                  } else {
                      throw new Error('Date invalide');
                  }
              } catch (e) {
                  // Fallback : utiliser la date actuelle
                  const defaultDate = new Date();
                  joinDateDisplay.value = defaultDate.toLocaleDateString('fr-FR', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric'
                  });
              }
          }
          
          // Gestionnaire pour la bannière du profil
          const bannerEditBtn = document.getElementById('edit-banner-btn');
          const bannerEditMenu = document.getElementById('banner-edit-menu');
          const bannerEditOverlay = document.getElementById('banner-edit-overlay');
          const bannerCloseBtn = document.getElementById('banner-close-btn');
          const bannerImageInput = document.getElementById('banner-image-input');
          const bannerVideoInput = document.getElementById('banner-video-input');
          const bannerRemoveBtn = document.getElementById('banner-remove-btn');
          const bannerImage = document.getElementById('banner-image');
          const bannerVideo = document.getElementById('banner-video');
          
          // Fonction pour ouvrir le menu modal
          function openBannerMenu() {
              if (bannerEditMenu) bannerEditMenu.classList.add('active');
              if (bannerEditOverlay) bannerEditOverlay.classList.add('active');
          }
          
          // Fonction pour fermer le menu modal
          function closeBannerMenu() {
              if (bannerEditMenu) bannerEditMenu.classList.remove('active');
              if (bannerEditOverlay) bannerEditOverlay.classList.remove('active');
          }
          
            // Charger et afficher les utilisateurs bloqués
          function loadBlockedUsers() {
              const user = JSON.parse(localStorage.getItem('user') || 'null');
              if (!user || !user.email) return;
              
              const blockedUsers = JSON.parse(localStorage.getItem('blocked_users_' + user.email) || '[]');
              const blockedUsersList = document.getElementById('blocked-users-list');
              const noBlockedUsers = document.getElementById('no-blocked-users');
              
              if (!blockedUsersList || !noBlockedUsers) return;
              
              if (blockedUsers.length === 0) {
                  noBlockedUsers.style.display = 'block';
                  blockedUsersList.style.display = 'none';
              } else {
                  noBlockedUsers.style.display = 'none';
                  blockedUsersList.style.display = 'block';
                  blockedUsersList.innerHTML = '';
                  
                  blockedUsers.forEach(blockedEmail => {
                      // Charger les infos du profil bloqué
                      const profileData = localStorage.getItem('profile_' + blockedEmail);
                      let userName = blockedEmail;
                      let userAvatar = '';
                      
                      if (profileData) {
                          try {
                              const profile = JSON.parse(profileData);
                              userName = profile.name || profile.username || blockedEmail;
                          } catch (e) {
                              console.error('Erreur lors du chargement du profil:', e);
                          }
                      }
                      
                      const avatarKey = 'avatar_' + blockedEmail;
                      const storedAvatar = localStorage.getItem(avatarKey);
                      if (storedAvatar) {
                          userAvatar = storedAvatar;
                      }
                      
                      const blockedUserItem = document.createElement('div');
                      blockedUserItem.className = 'blocked-user-item';
                      blockedUserItem.style.cssText = `
                          display: flex;
                          align-items: center;
                          justify-content: space-between;
                          padding: 1rem;
                          background: rgba(255, 255, 255, 0.05);
                          border: 1px solid rgba(255, 255, 255, 0.1);
                          border-radius: 12px;
                          margin-bottom: 0.75rem;
                          transition: all 0.3s ease;
                      `;
                      
                      blockedUserItem.innerHTML = `
                          <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                              <img src="${userAvatar}" alt="${userName}" style="
                                  width: 45px;
                                  height: 45px;
                                  border-radius: 50%;
                                  object-fit: cover;
                                  border: 2px solid rgba(225, 112, 85, 0.5);
                              " onerror="this.src=''">
                              <div>
                                  <div style="color: #f5f6fa; font-weight: 600; margin-bottom: 0.25rem;">${userName}</div>
                                  <div style="color: #a5b1c2; font-size: 0.85rem;">${blockedEmail}</div>
                              </div>
                          </div>
                          <button class="unblock-user-btn" data-email="${blockedEmail}" style="
                              padding: 0.6rem 1.2rem;
                              background: rgba(0, 184, 148, 0.2);
                              border: 1px solid rgba(0, 184, 148, 0.4);
                              border-radius: 8px;
                              color: #00b894;
                              font-weight: 600;
                              cursor: pointer;
                              transition: all 0.3s ease;
                              font-size: 0.9rem;
                          ">
                              <i class="fas fa-unlock"></i> ${(window.t || (function(k){ return (window.localization && window.localization.get(k)) || k; }))('profile.unblock')}
                          </button>
                      `;
                      
                      blockedUsersList.appendChild(blockedUserItem);
                      
                      // Gestionnaire pour le bouton débloquer
                      const unblockBtn = blockedUserItem.querySelector('.unblock-user-btn');
                      unblockBtn.addEventListener('click', function() {
                          const emailToUnblock = this.dataset.email;
                          showUnblockConfirmation(userName, emailToUnblock, user.email);
                      });
                  });
              }
          }
          
          // Afficher le popup de confirmation de déblocage
          function showUnblockConfirmation(userName, userEmail, currentUserEmail) {
              const popup = document.createElement('div');
              popup.className = 'unblock-popup';
              popup.style.cssText = `
                  position: fixed;
                  top: 0;
                  left: 0;
                  width: 100%;
                  height: 100%;
                  background: rgba(0, 0, 0, 0.8);
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  z-index: 10000;
                  backdrop-filter: blur(5px);
                  animation: fadeIn 0.3s ease;
              `;
              
              popup.innerHTML = `
                  <div class="unblock-popup-content" style="
                      background: linear-gradient(135deg, #1a1a1a 0%, #2d3436 100%);
                      border-radius: 20px;
                      padding: 0;
                      max-width: 450px;
                      width: 90%;
                      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(255, 255, 255, 0.1);
                      border: 1px solid rgba(255, 255, 255, 0.15);
                      animation: slideIn 0.3s ease;
                      overflow: hidden;
                  ">
                      <div style="
                          padding: 30px;
                          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                          background: rgba(255, 255, 255, 0.03);
                          backdrop-filter: blur(10px);
                      ">
                          <h3 style="
                              color: #fff;
                              font-size: 1.4rem;
                              margin: 0;
                              font-weight: 700;
                              display: flex;
                              align-items: center;
                              gap: 10px;
                          ">
                              <span style="font-size: 1.5rem;">🔓</span>
                              ${(window.t || (function(k){ return (window.localization && window.localization.get(k)) || k; }))('profile.unblock_user')}
                          </h3>
                      </div>
                      <div style="padding: 30px;">
                          <p style="
                              color: #a5b1c2;
                              margin-bottom: 25px;
                              font-size: 1rem;
                              line-height: 1.6;
                          ">
                              ${(window.t || (function(k){ return (window.localization && window.localization.get(k)) || k; }))('profile.unblock_confirm')} <strong style="color: #fff;">${userName}</strong> ${(window.t || (function(k){ return (window.localization && window.localization.get(k)) || k; }))('profile.unblock_confirm_end')}
                          </p>
                          <div style="display: flex; gap: 12px;">
                              <button class="unblock-cancel-btn" style="
                                  flex: 1;
                                  padding: 14px 20px;
                                  background: rgba(255, 255, 255, 0.1);
                                  border: 2px solid rgba(255, 255, 255, 0.2);
                                  border-radius: 12px;
                                  color: #fff;
                                  font-weight: 600;
                                  cursor: pointer;
                                  transition: all 0.3s ease;
                                  font-size: 1rem;
                              ">
                                  ${(window.t || (function(k){ return (window.localization && window.localization.get(k)) || k; }))('profile.cancel')}
                              </button>
                              <button class="unblock-confirm-btn" style="
                                  flex: 1;
                                  padding: 14px 20px;
                                  background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
                                  border: none;
                                  border-radius: 12px;
                                  color: white;
                                  font-weight: 600;
                                  cursor: pointer;
                                  transition: all 0.3s ease;
                                  font-size: 1rem;
                                  box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
                              ">
                                  <i class="fas fa-unlock"></i> ${(window.t || (function(k){ return (window.localization && window.localization.get(k)) || k; }))('profile.unblock')}
                              </button>
                          </div>
                      </div>
                  </div>
              `;
              
              document.body.appendChild(popup);
              
              const cancelBtn = popup.querySelector('.unblock-cancel-btn');
              const confirmBtn = popup.querySelector('.unblock-confirm-btn');
              
              const closePopup = () => {
                  popup.style.animation = 'fadeOut 0.3s ease';
                  setTimeout(() => {
                      if (document.body.contains(popup)) {
                          document.body.removeChild(popup);
                      }
                  }, 300);
              };
              
              cancelBtn.addEventListener('click', closePopup);
              confirmBtn.addEventListener('click', () => {
                  // Récupérer la liste actuelle des utilisateurs bloqués
                  const currentBlocked = JSON.parse(localStorage.getItem('blocked_users_' + currentUserEmail) || '[]');
                  const updatedBlocked = currentBlocked.filter(email => email !== userEmail);
                  localStorage.setItem('blocked_users_' + currentUserEmail, JSON.stringify(updatedBlocked));
                  loadBlockedUsers(); // Recharger la liste
                  closePopup();
                  
                  // Afficher une notification
                  showToast(`${userName} a été débloqué`, 'success');
              });
              
              popup.addEventListener('click', (e) => {
                  if (e.target === popup) {
                      closePopup();
                  }
              });
              
              // Fermer avec Escape
              const escapeHandler = (e) => {
                  if (e.key === 'Escape') {
                      closePopup();
                      document.removeEventListener('keydown', escapeHandler);
                  }
              };
              document.addEventListener('keydown', escapeHandler);
              
              // Hover effects
              cancelBtn.addEventListener('mouseenter', () => {
                  cancelBtn.style.background = 'rgba(255, 255, 255, 0.15)';
                  cancelBtn.style.borderColor = 'rgba(255, 255, 255, 0.3)';
              });
              cancelBtn.addEventListener('mouseleave', () => {
                  cancelBtn.style.background = 'rgba(255, 255, 255, 0.1)';
                  cancelBtn.style.borderColor = 'rgba(255, 255, 255, 0.2)';
              });
              
              confirmBtn.addEventListener('mouseenter', () => {
                  confirmBtn.style.background = 'linear-gradient(135deg, #00a085 0%, #008f73 100%)';
                  confirmBtn.style.transform = 'translateY(-2px)';
                  confirmBtn.style.boxShadow = '0 6px 25px rgba(0, 184, 148, 0.4)';
              });
              confirmBtn.addEventListener('mouseleave', () => {
                  confirmBtn.style.background = 'linear-gradient(135deg, #00b894 0%, #00a085 100%)';
                  confirmBtn.style.transform = 'translateY(0)';
                  confirmBtn.style.boxShadow = '0 4px 15px rgba(0, 184, 148, 0.3)';
              });
          }
          
          // Charger la bannière sauvegardée (cache d'abord pour affichage immédiat, puis Firebase)
          async function loadBanner() {
              const user = JSON.parse(localStorage.getItem('user') || 'null');
              if (!user || !user.email) return;
              
              loadBlockedUsers();
              
              const bannerImage = document.getElementById('banner-image');
              const bannerVideo = document.getElementById('banner-video');
              if (!bannerImage || !bannerVideo) {
                  setTimeout(loadBanner, 80);
                  return;
              }
              
              // 1) Afficher tout de suite le cache localStorage (pas de délai)
              let banner = null;
              const cached = localStorage.getItem('profile_banner_' + user.email);
              if (cached) {
                  try {
                      banner = JSON.parse(cached);
                      displayBannerBlock(banner);
                  } catch (e) {}
              }
              
              // 2) En parallèle, charger depuis Firebase et mettre à jour
              if (window.bannerService) {
                  try {
                      const firebaseBanner = await window.bannerService.getBanner(user.email);
                      if (firebaseBanner) {
                          try { localStorage.setItem('profile_banner_' + user.email, JSON.stringify({ type: firebaseBanner.type, url: firebaseBanner.url, volume: firebaseBanner.volume !== undefined ? firebaseBanner.volume : 0 })); } catch (e) {}
                          displayBannerBlock(firebaseBanner);
                      }
                  } catch (err) {
                      console.warn('Bannière Firebase:', err);
                  }
              }
              
              if (!banner && !window.bannerService) {
                  const bannerData = localStorage.getItem('profile_banner_' + user.email);
                  if (bannerData) {
                      try {
                          banner = JSON.parse(bannerData);
                          displayBannerBlock(banner);
                      } catch (e) {}
                  }
              }
          }
          
          function displayBannerBlock(banner) {
              if (!banner) return;
              
              if (banner) {
                  console.log('🎨 Affichage de la bannière:', banner.type, banner.url ? 'URL présente' : 'URL manquante');
                  try {
                      var type = (banner.type || '').toLowerCase();
                      var bannerImgEl = document.getElementById('banner-image');
                      var bannerVidEl = document.getElementById('banner-video');
                      // IMPORTANT : Toujours vider l'ancienne bannière d'abord pour laisser place à la nouvelle
                      if (bannerImgEl) { bannerImgEl.removeAttribute('src'); bannerImgEl.classList.remove('active'); bannerImgEl.onerror = null; bannerImgEl.onload = null; }
                      if (bannerVidEl) { bannerVidEl.pause(); bannerVidEl.removeAttribute('src'); bannerVidEl.currentTime = 0; bannerVidEl.classList.remove('active'); bannerVidEl.onerror = null; bannerVidEl.onloadeddata = null; }
                      var displayUrl = banner.url;
                      if (displayUrl && !displayUrl.startsWith('data:')) displayUrl = displayUrl + (displayUrl.includes('?') ? '&' : '?') + 'v=' + Date.now();
                      if (type === 'image' && banner.url) {
                          if (bannerImgEl) {
                              console.log('🖼️ Affichage image bannière:', banner.url.substring(0, 50) + '...');
                              bannerImgEl.onload = function() { this.classList.add('active'); };
                              bannerImgEl.onerror = function() {
                                  var u = this.src; setTimeout(() => { if (this.src === u && !this.complete) this.src = (banner.url || '') + (banner.url && !banner.url.startsWith('data:') ? (banner.url.includes('?') ? '&' : '?') + 'retry=' + Date.now() : ''); }, 1000);
                              };
                              bannerImgEl.src = displayUrl;
                              bannerImgEl.classList.add('active');
                          }
                      } else if (type === 'video' && banner.url) {
                          console.log('🎥 Affichage vidéo bannière:', banner.url);
                          if (bannerVidEl) {
                              bannerImgEl && bannerImgEl.classList.remove('active');
                              setTimeout(() => {
                                  bannerVidEl.src = displayUrl;
                                  bannerVidEl.load();
                                  bannerVidEl.classList.add('active');
                                  bannerVidEl.play().catch(e => console.error('Erreur lecture vidéo:', e));
                              }, 10);
                              bannerVidEl.onerror = function() {
                                  var u = this.src; setTimeout(() => { if (this.src === u && this.readyState === 0) this.src = displayUrl.split('?')[0] + '?retry=' + Date.now(); }, 1000);
                              };
                              bannerVidEl.onloadeddata = function() { this.classList.add('active'); };
                              bannerVidEl.addEventListener('timeupdate', function() { if (this.currentTime >= 45) this.currentTime = 0; });
                              var savedVolume = banner.volume !== undefined ? banner.volume : 0;
                              bannerVidEl.volume = savedVolume / 100;
                              bannerVidEl.muted = true;
                              var volumeSetting = document.getElementById('banner-volume-setting');
                              var volumeSettingSlider = document.getElementById('banner-volume-setting-slider');
                              var volumeSettingValue = document.getElementById('banner-volume-setting-value');
                              if (volumeSetting) volumeSetting.style.display = 'block';
                              if (volumeSettingSlider) volumeSettingSlider.value = savedVolume;
                              if (volumeSettingValue) volumeSettingValue.textContent = savedVolume + '%';
                              if (typeof updateVolumeIcon === 'function') updateVolumeIcon(savedVolume);
                          }
                      } else {
                          // Masquer le contrôle de volume si ce n'est pas une vidéo
                          const volumeSetting = document.getElementById('banner-volume-setting');
                          if (volumeSetting) volumeSetting.style.display = 'none';
                      }
                  } catch (e) {
                      console.error('Erreur lors du chargement de la bannière:', e);
                  }
              }
              
              // Après le chargement de la bannière, synchroniser toutes les données utilisateur
              if (typeof syncAndLoadUserData === 'function') {
                  syncAndLoadUserData();
              }
          }
          
          // Afficher/masquer le contrôle de volume selon le type de bannière
          function updateVolumeControlVisibility() {
              const volumeControl = document.getElementById('banner-volume-control');
              if (bannerVideo.classList.contains('active')) {
                  if (volumeControl) volumeControl.style.display = 'block';
              } else {
                  if (volumeControl) volumeControl.style.display = 'none';
              }
          }
          
          // Sauvegarder la bannière
          async function saveBanner(type, url, volume = null) {
              const user = JSON.parse(localStorage.getItem('user') || 'null');
              if (!user || !user.email) return;
              
              // Vérifier si l'utilisateur est certifié pour l'upload de vidéo
              if (type === 'video') {
                  try {
                      const isVerified = await window.isUserVerified(user.email);
                      if (!isVerified) {
                          showToast('Erreur', 'Seuls les utilisateurs certifiés peuvent mettre une vidéo dans leur bannière', 'error');
                          return;
                      }
                  } catch (e) {
                      console.error('Erreur lors de la vérification de certification:', e);
                      showToast('Erreur', 'Impossible de vérifier votre statut de certification', 'error');
                      return;
                  }
              }
              
              try {
                  // Récupérer les données existantes pour préserver le volume
                  let existingVolume = 0;
                  if (window.bannerService) {
                      // Essayer de charger depuis Firebase
                      const existingBanner = await window.bannerService.getBanner(user.email);
                      if (existingBanner) {
                          existingVolume = existingBanner.volume || 0;
                      }
                  } else {
                      // Fallback vers localStorage
                      const existingData = localStorage.getItem('profile_banner_' + user.email);
                      if (existingData) {
                          try {
                              const existing = JSON.parse(existingData);
                              existingVolume = existing.volume !== undefined ? existing.volume : 0;
                          } catch (e) {
                              existingVolume = 0;
                          }
                      }
                  }
                  
                  const finalVolume = volume !== null ? volume : existingVolume;
                  
                  // Si c'est un File (upload), utiliser Firebase Storage
                  if (url instanceof File) {
                      console.log('📤 Sauvegarde bannière File:', { type, fileName: url.name, size: url.size });
                      
                      // Fonction helper pour compresser une image avec qualité maximale
                      const compressImage = (file, maxWidth = 3840, maxHeight = 2160, quality = 1.0) => {
                          return new Promise((resolve, reject) => {
                              const reader = new FileReader();
                              reader.onload = function(e) {
                                  const img = new Image();
                                  img.onload = function() {
                                      const canvas = document.createElement('canvas');
                                      let width = img.width;
                                      let height = img.height;
                                      
                                      // Redimensionner si nécessaire en gardant le ratio
                                      if (width > maxWidth || height > maxHeight) {
                                          const ratio = Math.min(maxWidth / width, maxHeight / height);
                                          width = Math.round(width * ratio);
                                          height = Math.round(height * ratio);
                                      }
                                      
                                      // S'assurer que les dimensions sont des nombres entiers
                                      width = Math.round(width);
                                      height = Math.round(height);
                                      
                                      canvas.width = width;
                                      canvas.height = height;
                                      
                                      const ctx = canvas.getContext('2d', { 
                                          alpha: false,
                                          willReadFrequently: false
                                      });
                                      
                                      // Paramètres de qualité maximale
                                      ctx.imageSmoothingEnabled = true;
                                      ctx.imageSmoothingQuality = 'high';
                                      ctx.webkitImageSmoothingEnabled = true;
                                      ctx.mozImageSmoothingEnabled = true;
                                      ctx.msImageSmoothingEnabled = true;
                                      
                                      ctx.drawImage(img, 0, 0, width, height);
                                      
                                      // Utiliser PNG pour qualité maximale si qualité = 1.0, sinon JPEG haute qualité
                                      const mimeType = quality >= 1.0 ? 'image/png' : 'image/jpeg';
                                      const compressedDataUrl = canvas.toDataURL(mimeType, quality);
                                      resolve(compressedDataUrl);
                                  };
                                  img.onerror = reject;
                                  img.src = e.target.result;
                              };
                              reader.onerror = reject;
                              reader.readAsDataURL(file);
                          });
                      };
                      
                      // Firebase Storage est maintenant le seul moyen de sauvegarder les bannières
                      // localStorage n'est utilisé que comme cache de lecture (fallback)
                      
                      // Essayer Firebase Storage d'abord (maintenant que CORS est configuré)
                      if (window.bannerService) {
                          try {
                              // Ajouter un timeout (vidéos = 90s, images = 15s)
                              const uploadPromise = window.bannerService.saveBanner(user.email, type, url, finalVolume);
                              const timeoutMs = type === 'video' ? 90000 : 15000;
                              const timeoutPromise = new Promise((_, reject) => 
                                  setTimeout(() => reject(new Error('TIMEOUT: Upload trop long, vérifiez votre connexion')), timeoutMs)
                              );
                              
                              const bannerData = await Promise.race([uploadPromise, timeoutPromise]);
                              console.log('✅ Bannière sauvegardée dans Firebase:', bannerData);
                              // Mettre en cache dans localStorage pour la page profil public
                              if (bannerData && user && user.email) {
                                  try {
                                      localStorage.setItem('profile_banner_' + user.email, JSON.stringify({
                                          type: bannerData.type,
                                          url: bannerData.url,
                                          volume: bannerData.volume !== undefined ? bannerData.volume : 0
                                      }));
                                  } catch (e) {}
                              }
                              // Recharger la bannière après sauvegarde
                              setTimeout(() => {
                                  if (typeof loadBanner === 'function') {
                                      loadBanner();
                                  }
                              }, 500);
                          } catch (error) {
                              // Vérifier si c'est une erreur CORS, timeout ou autre
                              const errorMessage = error.message || error.toString() || '';
                              const isCorsError = error.isCorsError || 
                                                errorMessage.includes('CORS') || 
                                                errorMessage.includes('CORS_ERROR') ||
                                                errorMessage.includes('TIMEOUT') ||
                                                error.code === 'storage/unauthorized' || 
                                                errorMessage.includes('preflight') ||
                                                errorMessage.includes('blocked') ||
                                                errorMessage.includes('Access-Control') ||
                                                errorMessage.includes('ERR_FAILED');
                              
                              console.error('❌ Erreur lors de la sauvegarde dans Firebase Storage:', error);
                              
                              // Ne PAS utiliser localStorage comme fallback - Firebase Storage est requis
                              const isPermissionError = error.code === 'storage/unauthorized' || 
                                                       error.code === 'permission-denied' ||
                                                       errorMessage.includes('PERMISSION_DENIED') ||
                                                       errorMessage.includes('does not have permission');
                              
                              if (isPermissionError) {
                                  alert('❌ Erreur de permissions Firebase Storage.\n\nVérifiez que :\n1. Les règles Storage sont publiées dans Firebase Console → Storage → Rules\n2. Vous êtes bien connecté avec Firebase Auth (pas seulement localStorage)\n3. Les règles permettent l\'écriture pour les utilisateurs authentifiés\n\nErreur : ' + errorMessage);
                              } else if (isCorsError) {
                                  alert('❌ Erreur CORS lors de l\'upload vers Firebase Storage.\n\nVérifiez que CORS est bien configuré avec la commande :\ngsutil cors set cors.json gs://mangawatch-98ed0.firebasestorage.app\n\nErreur : ' + errorMessage);
                              } else {
                                  alert('❌ Erreur lors de l\'upload vers Firebase Storage.\n\nErreur : ' + errorMessage + '\n\nVérifiez votre connexion et la configuration Firebase.');
                              }
                          }
                      } else {
                          // bannerService non disponible - Firebase Storage est requis
                          console.error('❌ bannerService non disponible. Firebase Storage est requis pour sauvegarder les bannières.');
                          alert('❌ Firebase Storage n\'est pas disponible.\n\nVérifiez que :\n1. Firebase Storage est bien activé\n2. Le fichier firebase-service.js est chargé correctement\n3. Les règles de sécurité sont configurées');
                      }
                  } else {
                      // C'est une URL (déjà uploadée ou URL externe)
                      console.log('📤 Sauvegarde bannière URL:', { type, url });
                      if (window.bannerService) {
                          try {
                              const bannerData = await window.bannerService.saveBanner(user.email, type, url, finalVolume);
                              console.log('✅ Bannière sauvegardée dans Firebase:', bannerData);
                              // Mettre en cache dans localStorage pour la page profil public
                              if (bannerData && user && user.email) {
                                  try {
                                      localStorage.setItem('profile_banner_' + user.email, JSON.stringify({
                                          type: bannerData.type,
                                          url: bannerData.url,
                                          volume: bannerData.volume !== undefined ? bannerData.volume : 0
                                      }));
                                  } catch (e) {}
                              }
                              // Recharger la bannière après sauvegarde
                              setTimeout(() => {
                                  if (typeof loadBanner === 'function') {
                                      loadBanner();
                                  }
                              }, 500);
                          } catch (error) {
                              console.error('❌ Erreur lors de la sauvegarde dans Firebase Storage:', error);
                              const errorMessage = error.message || error.toString() || '';
                              
                              // Ne PAS utiliser localStorage comme fallback - Firebase Storage est requis
                              if (error.code === 'storage/unauthorized') {
                                  alert('❌ Erreur d\'autorisation Firebase Storage.\n\nVérifiez que les règles de sécurité sont configurées dans Firebase Console → Storage → Rules.\n\nErreur : ' + errorMessage);
                              } else {
                                  alert('❌ Erreur lors de l\'upload vers Firebase Storage.\n\nErreur : ' + errorMessage + '\n\nVérifiez votre connexion et la configuration Firebase.');
                              }
                          }
                      } else {
                          // bannerService non disponible - Firebase Storage est requis
                          console.error('❌ bannerService non disponible. Firebase Storage est requis pour sauvegarder les bannières.');
                          alert('❌ Firebase Storage n\'est pas disponible.\n\nVérifiez que :\n1. Firebase Storage est bien activé\n2. Le fichier firebase-service.js est chargé correctement\n3. Les règles de sécurité sont configurées');
                      }
                  }
              } catch (error) {
                  console.error('❌ Erreur lors de la sauvegarde de la bannière:', error);
                  const errorMessage = error.message || error.toString() || '';
                  
                  // Ne PAS utiliser localStorage comme fallback - Firebase Storage est requis
                  alert('❌ Erreur lors de la sauvegarde de la bannière.\n\nErreur : ' + errorMessage + '\n\nVérifiez votre connexion et la configuration Firebase Storage.');
              }
          }
          
          // Ouvrir le menu d'édition depuis le bouton dans les préférences
          if (bannerEditBtn) {
              bannerEditBtn.addEventListener('click', function(e) {
                  e.preventDefault();
                  openBannerMenu();
                  updateVolumeControlVisibility();
                  
                  // Charger le volume actuel si c'est une vidéo
                  if (bannerVideo.classList.contains('active')) {
                      const user = JSON.parse(localStorage.getItem('user') || 'null');
                      if (user && user.email) {
                          const bannerData = localStorage.getItem('profile_banner_' + user.email);
                          if (bannerData) {
                              try {
                                  const banner = JSON.parse(bannerData);
                                  const volumeSlider = document.getElementById('banner-volume-slider');
                                  const volumeValue = document.getElementById('banner-volume-value');
                                  if (volumeSlider && volumeValue) {
                                      const savedVolume = banner.volume !== undefined ? banner.volume : 0;
                                      volumeSlider.value = savedVolume;
                                      volumeValue.textContent = savedVolume + '%';
                                  }
                              } catch (e) {
                                  console.error('Erreur lors du chargement du volume:', e);
                              }
                          }
                      }
                  }
              });
          }
          
          // ========== SYSTÈME D'ABONNEMENTS ==========
          
          // Fonction pour obtenir les abonnements d'un utilisateur
          function getUserFollowings(userEmail) {
              const key = 'user_followings_' + userEmail;
              try {
                  return JSON.parse(localStorage.getItem(key) || '[]');
              } catch (e) {
                  return [];
              }
          }
          
          // Fonction pour obtenir les abonnés d'un utilisateur
          function getUserFollowers(userEmail) {
              const key = 'user_followers_' + userEmail;
              try {
                  return JSON.parse(localStorage.getItem(key) || '[]');
              } catch (e) {
                  return [];
              }
          }
          
          // Fonction pour sauvegarder les abonnements d'un utilisateur
          function saveUserFollowings(userEmail, followings) {
              const key = 'user_followings_' + userEmail;
              localStorage.setItem(key, JSON.stringify(followings));
          }
          
          // Fonction pour sauvegarder les abonnés d'un utilisateur
          function saveUserFollowers(userEmail, followers) {
              const key = 'user_followers_' + userEmail;
              localStorage.setItem(key, JSON.stringify(followers));
          }
          
          // Fonction pour vérifier si l'utilisateur actuel suit un autre utilisateur
          function isFollowing(currentUserEmail, targetUserEmail) {
              const followings = getUserFollowings(currentUserEmail);
              return followings.includes(targetUserEmail);
          }
          
          // Fonction pour s'abonner à un utilisateur
          function followUser(currentUserEmail, targetUserEmail) {
              // Ajouter à la liste des abonnements de l'utilisateur actuel
              const followings = getUserFollowings(currentUserEmail);
              if (!followings.includes(targetUserEmail)) {
                  followings.push(targetUserEmail);
                  saveUserFollowings(currentUserEmail, followings);
              }
              
              // Ajouter à la liste des abonnés de l'utilisateur cible
              const followers = getUserFollowers(targetUserEmail);
              if (!followers.includes(currentUserEmail)) {
                  followers.push(currentUserEmail);
                  saveUserFollowers(targetUserEmail, followers);
              }
          }
          
          // Fonction pour se désabonner d'un utilisateur
          function unfollowUser(currentUserEmail, targetUserEmail) {
              // Retirer de la liste des abonnements de l'utilisateur actuel
              const followings = getUserFollowings(currentUserEmail);
              const index = followings.indexOf(targetUserEmail);
              if (index > -1) {
                  followings.splice(index, 1);
                  saveUserFollowings(currentUserEmail, followings);
              }
              
              // Retirer de la liste des abonnés de l'utilisateur cible
              const followers = getUserFollowers(targetUserEmail);
              const followerIndex = followers.indexOf(currentUserEmail);
              if (followerIndex > -1) {
                  followers.splice(followerIndex, 1);
                  saveUserFollowers(targetUserEmail, followers);
              }
          }
          
          // Fonction pour mettre à jour l'affichage des compteurs et du bouton
          function updateFollowDisplay() {
              const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
              if (!currentUser || !currentUser.email) {
                  // Masquer le bouton si l'utilisateur n'est pas connecté
                  const followBtn = document.getElementById('profile-follow-btn');
                  if (followBtn) followBtn.style.display = 'none';
                  return;
              }
              
              // L'email de l'utilisateur dont on consulte le profil
              // Si on est sur notre propre profil, on utilise l'email de l'utilisateur connecté
              const profileUserEmail = currentUser.email; // Pour le profil personnel
              
              // Obtenir les compteurs
              const followers = getUserFollowers(profileUserEmail);
              const followings = getUserFollowings(profileUserEmail);
              
              // Mettre à jour les compteurs
              const followersCountEl = document.getElementById('followers-count');
              const followingCountEl = document.getElementById('following-count');
              
              if (followersCountEl) {
                  followersCountEl.textContent = followers.length;
              }
              if (followingCountEl) {
                  followingCountEl.textContent = followings.length;
              }
              
              // Le bouton d'abonnement n'est pas affiché sur son propre profil
              const followBtn = document.getElementById('profile-follow-btn');
              if (followBtn) {
                  followBtn.style.display = 'none';
              }
          }
          
          // Initialiser l'affichage des abonnements
          updateFollowDisplay();
          
          // Gérer le clic sur le bouton d'abonnement
          const followBtn = document.getElementById('profile-follow-btn');
          if (followBtn) {
              followBtn.addEventListener('click', function() {
                  const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
                  if (!currentUser || !currentUser.email) {
                      alert('Vous devez être connecté pour vous abonner à un utilisateur.');
                      return;
                  }
                  
                  const profileUserEmail = currentUser.email; // Pour le profil personnel, on ne peut pas s'abonner à soi-même
                  
                  // Vérifier si on suit déjà cet utilisateur
                  const isCurrentlyFollowing = isFollowing(currentUser.email, profileUserEmail);
                  
                  if (isCurrentlyFollowing) {
                      unfollowUser(currentUser.email, profileUserEmail);
                      followBtn.classList.remove('following');
                      followBtn.innerHTML = '<i class="fas fa-user-plus"></i><span id="follow-btn-text">' + (window._profileT ? window._profileT('profile.subscribe') : 'S\'abonner') + '</span>';
                  } else {
                      followUser(currentUser.email, profileUserEmail);
                      followBtn.classList.add('following');
                      followBtn.innerHTML = '<i class="fas fa-user-check"></i><span id="follow-btn-text">' + (window._profileT ? window._profileT('profile.subscribed') : 'Abonné') + '</span>';
                  }
                  
                  // Mettre à jour l'affichage
                  updateFollowDisplay();
              });
          }
          
          // Fonction pour obtenir le paramètre de confidentialité
          function getHideFollowsSetting(userEmail) {
              const key = 'hide_follows_' + userEmail;
              return localStorage.getItem(key) === 'true';
          }
          
          // Fonction pour sauvegarder le paramètre de confidentialité
          function saveHideFollowsSetting(userEmail, hide) {
              const key = 'hide_follows_' + userEmail;
              localStorage.setItem(key, hide ? 'true' : 'false');
          }
          
          // Fonction pour obtenir les informations d'un utilisateur depuis son email
          function getUserInfoFromEmail(email) {
              const profileData = localStorage.getItem('profile_' + email);
              if (profileData) {
                  try {
                      return JSON.parse(profileData);
                  } catch (e) {
                      return null;
                  }
              }
              return null;
          }
          
          // Fonction pour ouvrir le popup des abonnés/abonnements
          function openFollowModal(type, userEmail) {
              const modal = document.getElementById('follow-modal');
              const overlay = document.getElementById('follow-modal-overlay');
              const title = document.getElementById('follow-modal-title');
              const content = document.getElementById('follow-modal-content');
              
              if (!modal || !overlay || !title || !content) return;
              
              const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
              const isOwnProfile = currentUser && currentUser.email === userEmail;
              const hideFollows = getHideFollowsSetting(userEmail);
              
              var _profileT = (function(){ return (typeof window.t === 'function' && window.t) || (function(k){ return (window.localization && window.localization.get(k)) || k; }); })();
              // Vérifier la confidentialité (seulement pour les autres utilisateurs)
              if (!isOwnProfile && hideFollows) {
                  title.textContent = type === 'followers' ? _profileT('profile.followers_modal_title') : _profileT('profile.following_modal_title');
                  content.innerHTML = '<div class="follow-list-empty"><i class="fas fa-lock"></i><p>' + (type === 'followers' ? _profileT('profile.follows_hidden_followers') : _profileT('profile.follows_hidden_following')) + '</p></div>';
                  modal.classList.add('active');
                  overlay.classList.add('active');
                  return;
              }
              
              let list = [];
              if (type === 'followers') {
                  list = getUserFollowers(userEmail);
                  title.textContent = _profileT('profile.followers_modal_title');
              } else {
                  list = getUserFollowings(userEmail);
                  title.textContent = _profileT('profile.following_modal_title');
              }
              
              if (list.length === 0) {
                  content.innerHTML = '<div class="follow-list-empty"><i class="fas fa-user-slash"></i><p>' + (type === 'followers' ? _profileT('profile.no_followers') : _profileT('profile.no_following')) + '</p></div>';
              } else {
                  const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
                  const isOwnProfile = currentUser && currentUser.email === userEmail;
                  
                  content.innerHTML = list.map(email => {
                      const userInfo = getUserInfoFromEmail(email);
                      const userName = userInfo?.name || userInfo?.username || email.split('@')[0];
                      const avatarKey = 'avatar_' + email;
                      const avatar = localStorage.getItem(avatarKey) || userInfo?.picture || userInfo?.customAvatar || '';
                      
                      // Vérifier si l'utilisateur actuel suit cet utilisateur
                      const isCurrentlyFollowing = currentUser && currentUser.email && isFollowing(currentUser.email, email);
                      const isOwnProfileItem = currentUser && currentUser.email === email;
                      
                      // Afficher le bouton seulement si ce n'est pas son propre profil et si on consulte son propre profil
                      // OU si on consulte le profil d'un autre utilisateur (pour voir les abonnés/abonnements)
                      let actionButton = '';
                      if (!isOwnProfileItem && currentUser && currentUser.email) {
                          // Si on consulte son propre profil, on peut s'abonner/se désabonner aux utilisateurs dans la liste
                          // Si on consulte le profil d'un autre, on peut s'abonner/se désabonner aux utilisateurs dans la liste
                          if (isCurrentlyFollowing) {
                              var subLabel = (typeof _profileT === 'function' && _profileT('profile.subscribed')) || 'Abonné';
                              actionButton = `
                                  <div class="follow-list-item-action">
                                      <button class="follow-list-item-btn following" data-email="${email}" onclick="event.stopPropagation(); handleFollowToggle('${email}')">
                                          <i class="fas fa-user-check"></i> ` + subLabel + `
                                      </button>
                                  </div>
                              `;
                          } else {
                              var subLabel2 = (typeof _profileT === 'function' && _profileT('profile.subscribe')) || 'S\'abonner';
                              actionButton = `
                                  <div class="follow-list-item-action">
                                      <button class="follow-list-item-btn follow" data-email="${email}" onclick="event.stopPropagation(); handleFollowToggle('${email}')">
                                          <i class="fas fa-user-plus"></i> ` + subLabel2 + `
                                      </button>
                                  </div>
                              `;
                          }
                      }
                      
                      return `
                          <div class="follow-list-item">
                              <img src="${avatar}" alt="${userName}" class="follow-list-item-avatar" onclick="window.location.href='user-profile.html?user=${encodeURIComponent(email)}'" onerror="this.src=''">
                              <div class="follow-list-item-info" onclick="window.location.href='user-profile.html?user=${encodeURIComponent(email)}'">
                                  <div class="follow-list-item-name">${userName}</div>
                                  <div class="follow-list-item-email">${email}</div>
                              </div>
                              ${actionButton}
                          </div>
                      `;
                  }).join('');
              }
              
              modal.classList.add('active');
              overlay.classList.add('active');
          }
          
          // Fonction pour fermer le popup
          function closeFollowModal() {
              const modal = document.getElementById('follow-modal');
              const overlay = document.getElementById('follow-modal-overlay');
              if (modal) modal.classList.remove('active');
              if (overlay) overlay.classList.remove('active');
          }
          
          // Gérer les clics sur les compteurs pour afficher les listes
          const followersStat = document.getElementById('followers-stat');
          const followingStat = document.getElementById('following-stat');
          
          if (followersStat) {
              followersStat.addEventListener('click', function() {
                  const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
                  if (!currentUser || !currentUser.email) return;
                  openFollowModal('followers', currentUser.email);
              });
          }
          
          if (followingStat) {
              followingStat.addEventListener('click', function() {
                  const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
                  if (!currentUser || !currentUser.email) return;
                  openFollowModal('following', currentUser.email);
              });
          }
          
          // Gérer la fermeture du popup
          const followModalClose = document.getElementById('follow-modal-close');
          const followModalOverlay = document.getElementById('follow-modal-overlay');
          
          if (followModalClose) {
              followModalClose.addEventListener('click', closeFollowModal);
          }
          
          if (followModalOverlay) {
              followModalOverlay.addEventListener('click', closeFollowModal);
          }
          
          // Fonction pour gérer l'abonnement/désabonnement depuis le popup
          window.handleFollowToggle = function(targetEmail) {
              const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
              if (!currentUser || !currentUser.email) {
                  alert('Vous devez être connecté pour vous abonner à un utilisateur.');
                  return;
              }
              
              const isCurrentlyFollowing = isFollowing(currentUser.email, targetEmail);
              const button = document.querySelector(`.follow-list-item-btn[data-email="${targetEmail}"]`);
              
              if (isCurrentlyFollowing) {
                  unfollowUser(currentUser.email, targetEmail);
                  if (button) {
                      button.className = 'follow-list-item-btn follow';
                      button.innerHTML = '<i class="fas fa-user-plus"></i> ' + (window._profileT ? window._profileT('profile.subscribe') : 'S\'abonner');
                  }
              } else {
                  followUser(currentUser.email, targetEmail);
                  if (button) {
                      button.className = 'follow-list-item-btn following';
                      button.innerHTML = '<i class="fas fa-user-check"></i> ' + (window._profileT ? window._profileT('profile.subscribed') : 'Abonné');
                  }
              }
              
              // Mettre à jour les compteurs dans le header
              updateFollowDisplay();
              
              // Ne pas recharger la liste immédiatement
              // L'utilisateur reste visible avec le bouton mis à jour
              // La liste sera mise à jour lors de la prochaine ouverture du popup
          };
          
          // Gérer l'option de confidentialité dans les paramètres
          const hideFollowsCheckbox = document.getElementById('hide-follows-checkbox');
          if (hideFollowsCheckbox) {
              // Charger l'état actuel
              const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
              if (currentUser && currentUser.email) {
                  hideFollowsCheckbox.checked = getHideFollowsSetting(currentUser.email);
                  // Synchroniser vers Firebase pour que le profil public respecte le réglage (au cas où il n'était que en localStorage)
                  function syncHideFollowsToFirebase() {
                      if (window.profileSettingsService && currentUser && currentUser.email && hideFollowsCheckbox.checked) {
                          window.profileSettingsService.setHideFollows(currentUser.email, true).catch(() => {});
                      }
                  }
                  if (hideFollowsCheckbox.checked && window.profileSettingsService) {
                      window.profileSettingsService.setHideFollows(currentUser.email, true).catch(() => {});
                  } else if (hideFollowsCheckbox.checked) {
                      // Module Firebase pas encore chargé : réessayer après 300 ms et 1 s
                      setTimeout(syncHideFollowsToFirebase, 300);
                      setTimeout(syncHideFollowsToFirebase, 1000);
                  }
              }
              
              // Sauvegarder lors du changement (localStorage + Firebase pour que le profil public respecte le réglage)
              hideFollowsCheckbox.addEventListener('change', function() {
                  const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
                  if (currentUser && currentUser.email) {
                      saveHideFollowsSetting(currentUser.email, this.checked);
                      if (window.profileSettingsService) {
                          window.profileSettingsService.setHideFollows(currentUser.email, this.checked).catch(() => {});
                      }
                  }
              });
          }
          
          // Fonction pour mettre à jour le volume
          function updateBannerVolume(volume) {
              // Sauvegarder l'état de lecture avant de modifier le volume
              const wasPlaying = !bannerVideo.paused;
              
              bannerVideo.volume = volume / 100;
              bannerVideo.muted = volume === 0;
              
              // S'assurer que la vidéo continue de jouer si elle jouait avant
              if (wasPlaying || volume > 0) {
                  if (bannerVideo.paused) {
                      bannerVideo.play().catch(e => {
                          console.log('Erreur de lecture vidéo:', e);
                          // Si l'autoplay échoue, essayer avec muted temporairement puis activer le son
                          if (volume > 0) {
                              bannerVideo.muted = true;
                              bannerVideo.play().then(() => {
                                  // Attendre un peu avant de réactiver le son
                                  setTimeout(() => {
                                      bannerVideo.muted = false;
                                      bannerVideo.volume = volume / 100;
                                  }, 100);
                              }).catch(err => {
                                  console.log('Erreur de lecture vidéo avec muted:', err);
                              });
                          }
                      });
                  }
              }
              
              // Mettre à jour l'icône du bouton mute
              updateVolumeIcon(volume);
              
              // Sauvegarder le volume
              const user = JSON.parse(localStorage.getItem('user') || 'null');
              if (user && user.email) {
                  const bannerData = localStorage.getItem('profile_banner_' + user.email);
                  if (bannerData) {
                      try {
                          const banner = JSON.parse(bannerData);
                          banner.volume = volume;
                          localStorage.setItem('profile_banner_' + user.email, JSON.stringify(banner));
                      } catch (e) {
                          console.error('Erreur lors de la sauvegarde du volume:', e);
                      }
                  }
              }
          }
          
          // Fonction pour mettre à jour l'icône du volume (settings + modal)
          function updateVolumeIcon(volume) {
              var icons = ['volume-mute-btn', 'banner-volume-mute-btn'];
              icons.forEach(function(id) {
                  var btn = document.getElementById(id);
                  if (!btn) return;
                  var icon = btn.querySelector('i');
                  if (volume === 0) {
                      icon.className = 'fas fa-volume-mute';
                      btn.title = 'Activer le son';
                  } else if (volume < 50) {
                      icon.className = 'fas fa-volume-down';
                      btn.title = 'Couper le son';
                  } else {
                      icon.className = 'fas fa-volume-up';
                      btn.title = 'Couper le son';
                  }
              });
          }
          
          // Gestionnaire pour le contrôle de volume dans le menu modal
          const volumeSlider = document.getElementById('banner-volume-slider');
          const volumeValue = document.getElementById('banner-volume-value');
          
          if (volumeSlider && volumeValue) {
              volumeSlider.addEventListener('input', function() {
                  const volume = parseInt(this.value);
                  volumeValue.textContent = volume + '%';
                  updateBannerVolume(volume);
                  
                  // Mettre à jour aussi le slider dans les paramètres
                  const volumeSettingSlider = document.getElementById('banner-volume-setting-slider');
                  const volumeSettingValue = document.getElementById('banner-volume-setting-value');
                  if (volumeSettingSlider) volumeSettingSlider.value = volume;
                  if (volumeSettingValue) volumeSettingValue.textContent = volume + '%';
                  updateVolumeIcon(volume);
              });
          }
          
          // Gestionnaire pour le contrôle de volume dans les paramètres
          const volumeSettingSlider = document.getElementById('banner-volume-setting-slider');
          const volumeSettingValue = document.getElementById('banner-volume-setting-value');
          const volumeMuteBtn = document.getElementById('volume-mute-btn');
          
          if (volumeSettingSlider && volumeSettingValue) {
              volumeSettingSlider.addEventListener('input', function() {
                  const volume = parseInt(this.value);
                  volumeSettingValue.textContent = volume + '%';
                  updateBannerVolume(volume);
                  
                  // Mettre à jour aussi le slider dans le menu modal
                  if (volumeSlider) volumeSlider.value = volume;
                  if (volumeValue) volumeValue.textContent = volume + '%';
              });
          }
          
          function handleMuteToggle() {
              var currentVolume = (volumeSlider ? parseInt(volumeSlider.value) : 0) || (volumeSettingSlider ? parseInt(volumeSettingSlider.value) : 0);
              if (currentVolume === 0) {
                  var newVolume = 50;
                  if (volumeSettingSlider) volumeSettingSlider.value = newVolume;
                  if (volumeSettingValue) volumeSettingValue.textContent = newVolume + '%';
                  if (volumeSlider) volumeSlider.value = newVolume;
                  if (volumeValue) volumeValue.textContent = newVolume + '%';
                  updateBannerVolume(newVolume);
                  updateVolumeIcon(newVolume);
              } else {
                  if (volumeSettingSlider) volumeSettingSlider.value = 0;
                  if (volumeSettingValue) volumeSettingValue.textContent = '0%';
                  if (volumeSlider) volumeSlider.value = 0;
                  if (volumeValue) volumeValue.textContent = '0%';
                  updateBannerVolume(0);
                  updateVolumeIcon(0);
              }
          }
          if (volumeMuteBtn) volumeMuteBtn.addEventListener('click', handleMuteToggle);
          var bannerVolumeMuteBtn = document.getElementById('banner-volume-mute-btn');
          if (bannerVolumeMuteBtn) bannerVolumeMuteBtn.addEventListener('click', handleMuteToggle);
          
          // Fermer le menu en cliquant sur l'overlay
          if (bannerEditOverlay) {
              bannerEditOverlay.addEventListener('click', function() {
                  closeBannerMenu();
              });
          }
          
          // Fermer le menu avec le bouton fermer
          if (bannerCloseBtn) {
              bannerCloseBtn.addEventListener('click', function() {
                  closeBannerMenu();
              });
          }
          
          // Fonction pour optimiser la qualité de l'image avec qualité maximale
          function optimizeImageQuality(file, maxWidth, maxHeight, quality) {
              return new Promise((resolve) => {
                  const reader = new FileReader();
                  reader.onload = function(e) {
                      const img = new Image();
                      img.onload = function() {
                          const canvas = document.createElement('canvas');
                          let width = img.width;
                          let height = img.height;
                          
                          // Calculer les dimensions optimales en gardant le ratio
                          // Permettre jusqu'à 4K pour une qualité maximale
                          if (width > maxWidth || height > maxHeight) {
                              const ratio = Math.min(maxWidth / width, maxHeight / height);
                              width = Math.round(width * ratio);
                              height = Math.round(height * ratio);
                          }
                          
                          // S'assurer que les dimensions sont des nombres entiers
                          width = Math.round(width);
                          height = Math.round(height);
                          
                          canvas.width = width;
                          canvas.height = height;
                          
                          const ctx = canvas.getContext('2d', { 
                              alpha: false,  // Pas besoin d'alpha pour JPEG
                              willReadFrequently: false
                          });
                          
                          // Paramètres de qualité maximale pour le rendu
                          ctx.imageSmoothingEnabled = true;
                          ctx.imageSmoothingQuality = 'high';
                          
                          // Désactiver l'interpolation de sous-pixels pour un rendu plus net
                          ctx.webkitImageSmoothingEnabled = true;
                          ctx.mozImageSmoothingEnabled = true;
                          ctx.msImageSmoothingEnabled = true;
                          
                          // Rendre l'image avec la meilleure qualité possible
                          ctx.drawImage(img, 0, 0, width, height);
                          
                          // Utiliser PNG pour qualité maximale si qualité = 1.0, sinon JPEG
                          const mimeType = quality >= 1.0 ? 'image/png' : 'image/jpeg';
                          const optimizedDataUrl = canvas.toDataURL(mimeType, quality);
                          resolve(optimizedDataUrl);
                      };
                      img.src = e.target.result;
                  };
                  reader.readAsDataURL(file);
              });
          }
          
          // Gestionnaire pour le choix d'image
          if (bannerImageInput) {
              bannerImageInput.addEventListener('change', function(e) {
                  const file = e.target.files[0];
                  if (file) {
                      // Optimiser l'image avec une qualité maximale (4K max, qualité 100%)
                      optimizeImageQuality(file, 3840, 2160, 1.0).then(imageUrl => {
                          // Arrêter complètement la vidéo si elle était en cours
                          if (bannerVideo) {
                              bannerVideo.pause();
                              bannerVideo.removeAttribute('src');
                              bannerVideo.currentTime = 0;
                              bannerVideo.classList.remove('active');
                          }
                          
                          // Afficher l'image optimisée immédiatement
                          if (bannerImage) {
                              bannerImage.src = imageUrl;
                              bannerImage.classList.add('active');
                          }
                          
                          // IMPORTANT : Sauvegarder le File directement pour Firebase Storage
                          // On garde l'image optimisée pour l'affichage, mais on sauvegarde le File original
                          if (typeof saveBanner === 'function') {
                              saveBanner('image', file);
                          } else {
                              console.error('❌ saveBanner n\'est pas définie !');
                          }
                          
                          // Masquer le contrôle de volume dans les paramètres
                          const volumeSetting = document.getElementById('banner-volume-setting');
                          if (volumeSetting) volumeSetting.style.display = 'none';
                          
                          closeBannerMenu();
                          if (typeof showToast === 'function') {
                              showToast('Succès', 'Bannière image ajoutée avec succès !', 'success');
                          }
                      });
                      
                      // Réinitialiser l'input pour permettre de sélectionner le même fichier à nouveau
                      this.value = '';
                  }
              });
          } else {
              console.warn('⚠️ bannerImageInput non trouvé');
          }
          
          // Fonction pour mettre à jour la visibilité de l'input vidéo selon le statut de certification
          async function updateVideoInputVisibility() {
              const user = JSON.parse(localStorage.getItem('user') || 'null');
              if (!user || !user.email) return;
              
              const bannerVideoInput = document.getElementById('banner-video-input');
              const bannerVideoLabel = bannerVideoInput ? bannerVideoInput.previousElementSibling : null;
              
              if (bannerVideoInput) {
                  try {
                      const isVerified = await window.isUserVerified(user.email);
                      if (!isVerified) {
                          // Utilisateur non certifié : masquer/désactiver l'input vidéo
                          if (bannerVideoInput) {
                              bannerVideoInput.style.display = 'none';
                              bannerVideoInput.disabled = true;
                          }
                          if (bannerVideoLabel && bannerVideoLabel.tagName === 'LABEL') {
                              bannerVideoLabel.style.display = 'none';
                          }
                      } else {
                          // Utilisateur certifié : afficher/activer l'input vidéo
                          if (bannerVideoInput) {
                              bannerVideoInput.style.display = 'block';
                              bannerVideoInput.disabled = false;
                          }
                          if (bannerVideoLabel && bannerVideoLabel.tagName === 'LABEL') {
                              bannerVideoLabel.style.display = 'block';
                          }
                      }
                  } catch (e) {
                      console.error('Erreur lors de la vérification de certification:', e);
                      // En cas d'erreur, désactiver par défaut
                      if (bannerVideoInput) {
                          bannerVideoInput.style.display = 'none';
                          bannerVideoInput.disabled = true;
                      }
                      if (bannerVideoLabel && bannerVideoLabel.tagName === 'LABEL') {
                          bannerVideoLabel.style.display = 'none';
                      }
                  }
              }
          }
          
          // Mettre à jour la visibilité de l'input vidéo au chargement
          updateVideoInputVisibility();
          
          // Gestionnaire pour le choix de vidéo
          if (bannerVideoInput) {
              bannerVideoInput.addEventListener('change', async function(e) {
                  const file = e.target.files[0];
                  if (file) {
                      // Vérifier si l'utilisateur est certifié avant d'autoriser l'upload
                      const user = JSON.parse(localStorage.getItem('user') || 'null');
                      if (user && user.email) {
                          try {
                              const isVerified = await window.isUserVerified(user.email);
                              if (!isVerified) {
                                  showToast('Erreur', 'Seuls les utilisateurs certifiés peuvent mettre une vidéo dans leur bannière', 'error');
                                  this.value = '';
                                  return;
                              }
                          } catch (e) {
                              console.error('Erreur lors de la vérification de certification:', e);
                              showToast('Erreur', 'Impossible de vérifier votre statut de certification', 'error');
                              this.value = '';
                              return;
                          }
                      }
                      
                      // Vérifier la taille du fichier (max 150MB pour vidéos haute qualité)
                      if (file.size > 150 * 1024 * 1024) {
                          showToast('Erreur', 'La vidéo ne doit pas dépasser 150MB', 'error');
                          this.value = '';
                          return;
                      }
                      
                          // IMPORTANT : Sauvegarder le File directement pour Firebase, pas la data URL
                      // On garde FileReader pour l'affichage immédiat, mais on sauvegarde le File
                      const reader = new FileReader();
                      reader.onload = function(event) {
                          const videoUrl = event.target.result;
                          if (bannerVideo) {
                              bannerVideo.src = videoUrl;
                              bannerVideo.classList.add('active');
                          }
                          if (bannerImage) {
                              bannerImage.removeAttribute('src');
                              bannerImage.classList.remove('active');
                          }
                          // Sauvegarder le File directement (Firebase Storage) au lieu de la data URL
                          if (typeof saveBanner === 'function') {
                              saveBanner('video', file, 0); // Passer le File, pas la data URL
                          } else {
                              console.error('❌ saveBanner n\'est pas définie !');
                          }
                          updateVolumeControlVisibility();
                          
                          // Limiter la vidéo à 45 secondes pour optimiser les performances
                          bannerVideo.addEventListener('loadedmetadata', function() {
                              // Si la vidéo dépasse 45 secondes, on la limite
                              if (bannerVideo.duration > 45) {
                                  // La vidéo sera coupée à 45 secondes grâce à l'event listener timeupdate
                              }
                          }, { once: true });
                          
                          // Event listener pour limiter la vidéo à 45 secondes
                          bannerVideo.addEventListener('timeupdate', function() {
                              if (bannerVideo.currentTime >= 45) {
                                  bannerVideo.currentTime = 0;
                              }
                          });
                          
                          // Réinitialiser les sliders de volume
                          if (volumeSlider && volumeValue) {
                              volumeSlider.value = 0;
                              volumeValue.textContent = '0%';
                          }
                          const volumeSettingSlider = document.getElementById('banner-volume-setting-slider');
                          const volumeSettingValue = document.getElementById('banner-volume-setting-value');
                          if (volumeSettingSlider && volumeSettingValue) {
                              volumeSettingSlider.value = 0;
                              volumeSettingValue.textContent = '0%';
                          }
                          
                          // Afficher le contrôle de volume dans les paramètres
                          const volumeSetting = document.getElementById('banner-volume-setting');
                          if (volumeSetting) volumeSetting.style.display = 'block';
                          
                          // Appliquer le volume (muted car volume = 0)
                          bannerVideo.volume = 0;
                          bannerVideo.muted = true;
                          
                          // Démarrer la lecture de la vidéo
                          bannerVideo.play().catch(e => {
                              console.log('Erreur de lecture vidéo:', e);
                          });
                          
                          closeBannerMenu();
                          showToast('Succès', 'Bannière vidéo ajoutée avec succès !', 'success');
                      };
                      reader.readAsDataURL(file);
                      
                      // Réinitialiser l'input pour permettre de sélectionner le même fichier à nouveau
                      this.value = '';
                  }
              });
          }
          
          // Gestionnaire pour supprimer la bannière
          if (bannerRemoveBtn) {
              bannerRemoveBtn.addEventListener('click', async function() {
                  const user = JSON.parse(localStorage.getItem('user') || 'null');
                  if (!user || !user.email) return;
                  
                  // Supprimer de Firebase Storage et Firestore
                  if (window.bannerService && typeof window.bannerService.deleteBanner === 'function') {
                      try {
                          await window.bannerService.deleteBanner(user.email);
                          console.log('✅ Bannière supprimée de Firebase');
                      } catch (error) {
                          console.error('❌ Erreur lors de la suppression de Firebase:', error);
                          // Continuer quand même pour supprimer l'affichage local
                      }
                  }
                  
                  // Supprimer de localStorage
                  localStorage.removeItem('profile_banner_' + user.email);
                  
                  // Mettre à jour l'affichage
                  bannerImage.classList.remove('active');
                  bannerImage.removeAttribute('src');
                  
                  // Arrêter complètement la vidéo
                  if (bannerVideo) {
                      bannerVideo.pause();
                      bannerVideo.removeAttribute('src');
                      bannerVideo.currentTime = 0;
                      bannerVideo.classList.remove('active');
                  }
                  
                  // Masquer le contrôle de volume dans les paramètres
                  const volumeSetting = document.getElementById('banner-volume-setting');
                  if (volumeSetting) volumeSetting.style.display = 'none';
                  
                  closeBannerMenu();
                  showToast('Succès', 'Bannière supprimée avec succès !', 'success');
              });
          }
          
          // Fonction pour charger tout le contenu du profil
          function loadAllProfileContent() {
              // Charger la bannière
              loadBanner();
              
              // S'assurer que le nom est affiché
              const userNameText = document.getElementById('user-name-text');
              if (userNameText && (!userNameText.textContent || userNameText.textContent.trim() === '')) {
                  const user = JSON.parse(localStorage.getItem('user') || 'null');
                  if (user) {
                      const profileData = localStorage.getItem('profile_' + user.email);
                      let displayName = user.name || user.email || 'Utilisateur';
                      if (profileData) {
                          try {
                              const savedProfile = JSON.parse(profileData);
                              if (savedProfile.name || savedProfile.username) {
                                  displayName = savedProfile.name || savedProfile.username;
                              }
                          } catch (e) {
                              console.error('Erreur lors du chargement du profil:', e);
                          }
                      }
                      userNameText.textContent = displayName;
                      
                      // Mettre à jour le badge certifié
                      const verifiedBadge = document.getElementById('verified-badge');
                      if (verifiedBadge) {
                          // Vérifier dans Firestore si disponible
                          if (window.isUserVerified && typeof window.isUserVerified === 'function') {
                              window.isUserVerified(user.email).then(isVerified => {
                                  verifiedBadge.style.display = isVerified ? 'inline-flex' : 'none';
                              // Mettre à jour la visibilité de l'input vidéo après vérification
                              updateVideoInputVisibility();
                              }).catch(() => {
                                  // Fallback vers localStorage
                                  const verifiedUsers = JSON.parse(localStorage.getItem('verified_users') || '[]');
                                  verifiedBadge.style.display = verifiedUsers.includes(user.email) ? 'inline-flex' : 'none';
                                  // Mettre à jour la visibilité de l'input vidéo
                                  updateVideoInputVisibility();
                              });
                          } else {
                              // Fallback vers localStorage
                              const verifiedUsers = JSON.parse(localStorage.getItem('verified_users') || '[]');
                              verifiedBadge.style.display = verifiedUsers.includes(user.email) ? 'inline-flex' : 'none';
                              // Mettre à jour la visibilité de l'input vidéo
                              updateVideoInputVisibility();
                          }
                      }
                  }
              }
              
              // S'assurer que le pays est affiché
              const profileCountryText = document.getElementById('profile-country-text');
              if (profileCountryText && (!profileCountryText.textContent || profileCountryText.textContent === 'Non renseigné')) {
                  const user = JSON.parse(localStorage.getItem('user') || 'null');
                  if (user) {
                      const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                      const account = accounts.find(acc => acc.email === user.email);
                      var countryCode = (account?.country || user.country || '').toString().toLowerCase();
                      if (!countryCode && (account?.continent || user.continent)) {
                          var continentToCountry = { 'europe': 'fr', 'amerique-nord': 'us', 'amerique-sud': 'br', 'afrique': 'other', 'asie': 'jp', 'oceanie': 'au', 'antartique': 'other', 'antarctique': 'other', 'amerique': 'us' };
                          countryCode = continentToCountry[(account?.continent || user.continent || '').toString().toLowerCase().replace(/\s+/g, '-')] || '';
                      }
                      if (countryCode && typeof window.getCountryName === 'function') {
                          profileCountryText.textContent = window.getCountryName(countryCode);
                      } else if (countryCode) {
                          profileCountryText.textContent = countryCode.toUpperCase();
                      }
                  }
              }
          }
          
          // Charger tout le contenu du profil au chargement de la page
          loadAllProfileContent();
          
          // Recharger aussi après un court délai pour s'assurer que tout est chargé
          setTimeout(() => {
              loadAllProfileContent();
          }, 100);
          
          // Gestionnaire pour le bouton de révélation de l'email
          const emailRevealBtn = document.getElementById('email-reveal-btn');
          if (emailRevealBtn && emailDisplay) {
              let emailRevealed = false;
              emailRevealBtn.addEventListener('click', function() {
                  const fullEmail = emailDisplay.dataset.fullEmail || '';
                  if (fullEmail && fullEmail !== 'Non renseigné') {
                      if (emailRevealed) {
                          // Masquer l'email
                          const [localPart, domain] = fullEmail.split('@');
                          const maskedLocal = localPart.length > 2 
                              ? localPart.substring(0, 2) + '***' 
                              : '***';
                          emailDisplay.value = maskedLocal + '@' + domain;
                          emailDisplay.classList.add('email-masked');
                          emailRevealBtn.innerHTML = '<i class="fas fa-eye"></i>';
                          emailRevealBtn.title = "Afficher l'email";
                          emailRevealed = false;
                      } else {
                          // Révéler l'email
                          emailDisplay.value = fullEmail;
                          emailDisplay.classList.remove('email-masked');
                          emailRevealBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                          emailRevealBtn.title = "Masquer l'email";
                          emailRevealed = true;
                      }
                  }
              });
          }
          
          // Gestionnaire pour le bouton de révélation du mot de passe
          const passwordToggleBtn = document.getElementById('password-toggle-btn');
          if (passwordToggleBtn && passwordDisplay) {
              let passwordRevealed = false;
              passwordToggleBtn.addEventListener('click', function() {
                  const fullPassword = passwordDisplay.dataset.fullPassword || '';
                  const currentValue = passwordDisplay.value || '';
                  // Obtenir la traduction pour vérifier si c'est un compte Google
                  const tFn = window.t || (window.localization ? (key) => window.localization.get(key) : (key) => key);
                  const noPasswordText = tFn('profile.settings.no_password') || 'Aucun mot de passe requis';
                  // Ne pas révéler si c'est un compte Google ou si pas de mot de passe valide
                  if (fullPassword && 
                      fullPassword !== 'Non renseigné' && 
                      fullPassword !== '' && 
                      currentValue !== noPasswordText &&
                      currentValue !== 'Compte Google (pas de mot de passe)') {
                      if (passwordRevealed) {
                          // Masquer le mot de passe
                          passwordDisplay.type = 'password';
                          passwordDisplay.value = '••••••••••••';
                          passwordToggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
                          passwordToggleBtn.title = (window.t && window.t('profile.show_password')) || "Afficher le mot de passe";
                          passwordRevealed = false;
                      } else {
                          // Révéler le mot de passe
                          passwordDisplay.type = 'text';
                          passwordDisplay.value = fullPassword;
                          passwordToggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                          passwordToggleBtn.title = (window.t && window.t('profile.hide_password')) || "Masquer le mot de passe";
                          passwordRevealed = true;
                      }
                  }
              });
          }
          
          // Gestionnaire pour l'édition de l'email
          const emailEditBtn = document.getElementById('email-edit-btn');
          const emailEditActions = document.getElementById('email-edit-actions');
          const emailSaveBtn = document.getElementById('email-save-btn');
          const emailCancelBtn = document.getElementById('email-cancel-btn');
          
          if (emailEditBtn && emailDisplay) {
              let originalEmail = '';
              emailEditBtn.addEventListener('click', function() {
                  originalEmail = emailDisplay.dataset.fullEmail || emailDisplay.value;
                  emailDisplay.removeAttribute('readonly');
                  emailDisplay.classList.remove('email-masked');
                  emailDisplay.value = originalEmail;
                  emailEditBtn.style.display = 'none';
                  if (emailEditActions) emailEditActions.style.display = 'flex';
              });
              
              if (emailSaveBtn) {
                  emailSaveBtn.addEventListener('click', function() {
                      const newEmail = emailDisplay.value.trim();
                      if (!newEmail || !newEmail.includes('@')) {
                          showToast('Erreur', 'Veuillez entrer une adresse email valide', 'error');
                          return;
                      }
                      
                      // Mettre à jour dans les comptes
                      const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                      const accountIndex = accounts.findIndex(acc => acc.email === user.email);
                      if (accountIndex !== -1) {
                          accounts[accountIndex].email = newEmail;
                          localStorage.setItem('accounts', JSON.stringify(accounts));
                      }
                      
                      // Mettre à jour l'utilisateur
                      user.email = newEmail;
                      localStorage.setItem('user', JSON.stringify(user));
                      
                      // Mettre à jour l'affichage
                      emailDisplay.dataset.fullEmail = newEmail;
                      emailDisplay.setAttribute('readonly', 'readonly');
                      emailDisplay.classList.add('email-masked');
                      const [localPart, domain] = newEmail.split('@');
                      const maskedLocal = localPart.length > 2 ? localPart.substring(0, 2) + '***' : '***';
                      emailDisplay.value = maskedLocal + '@' + domain;
                      emailEditBtn.style.display = 'flex';
                      if (emailEditActions) emailEditActions.style.display = 'none';
                      
                      showToast('Succès', 'Email modifié avec succès !', 'success');
                  });
              }
              
              if (emailCancelBtn) {
                  emailCancelBtn.addEventListener('click', function() {
                      emailDisplay.value = originalEmail;
                      emailDisplay.setAttribute('readonly', 'readonly');
                      emailDisplay.classList.add('email-masked');
                      const [localPart, domain] = originalEmail.split('@');
                      const maskedLocal = localPart.length > 2 ? localPart.substring(0, 2) + '***' : '***';
                      emailDisplay.value = maskedLocal + '@' + domain;
                      emailEditBtn.style.display = 'flex';
                      if (emailEditActions) emailEditActions.style.display = 'none';
                  });
              }
          }
          
          // Gestionnaire pour l'édition de la langue
          const languageEditBtn = document.getElementById('language-edit-btn');
          const languageEditActions = document.getElementById('language-edit-actions');
          const languageSaveBtn = document.getElementById('language-save-btn');
          const languageCancelBtn = document.getElementById('language-cancel-btn');
          const languageSelectEdit = document.getElementById('language-select-edit');
          
          if (languageEditBtn && languageDisplay) {
              let originalLanguage = '';
              languageEditBtn.addEventListener('click', function() {
                  originalLanguage = languageDisplay.value;
                  // Trouver le code langue correspondant
                  const langueCodes = {
                      'Français': 'fr',
                      'English': 'en',
                      'Deutsch': 'de',
                      'Español': 'es',
                      'Italiano': 'it',
                      '日本語': 'ja'
                  };
                  const currentCode = Object.keys(langueCodes).find(key => key === originalLanguage);
                  if (languageSelectEdit && currentCode) {
                      languageSelectEdit.value = langueCodes[currentCode] || langueCodes[originalLanguage] || 'fr';
                  }
                  languageEditBtn.style.display = 'none';
                  if (languageEditActions) languageEditActions.style.display = 'flex';
              });
              
              if (languageSaveBtn && languageSelectEdit) {
                  languageSaveBtn.addEventListener('click', function() {
                      const newLangueCode = languageSelectEdit.value;
                      const langueNames = {
                          'fr': 'Français',
                          'en': 'English',
                          'de': 'Deutsch',
                          'es': 'Español',
                          'it': 'Italiano',
                          'ja': '日本語'
                      };
                      const newLangueName = langueNames[newLangueCode] || 'Français';
                      
                      // Mettre à jour dans les comptes
                      const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                      const accountIndex = accounts.findIndex(acc => acc.email === user.email);
                      if (accountIndex !== -1) {
                          accounts[accountIndex].langue = newLangueCode;
                          localStorage.setItem('accounts', JSON.stringify(accounts));
                      }
                      
                      // Mettre à jour l'utilisateur
                      user.langue = newLangueCode;
                      user.language = newLangueCode;
                      localStorage.setItem('user', JSON.stringify(user));
                      
                      // IMPORTANT: Mettre à jour la clé utilisée par le système de localisation
                      localStorage.setItem('mangaWatchLanguage', newLangueCode);
                      
                      // Mettre à jour le système de localisation si disponible
                      if (window.localization) {
                          window.localization.setLanguage(newLangueCode);
                      } else if (window.changeLanguage) {
                          window.changeLanguage(newLangueCode);
                      }
                      
                      // Mettre à jour l'affichage
                      languageDisplay.value = newLangueName;
                      languageEditBtn.style.display = 'flex';
                      if (languageEditActions) languageEditActions.style.display = 'none';
                      
                      showToast('Succès', 'Langue modifiée avec succès !', 'success');
                      
                      // Recharger la page pour appliquer les traductions
                      setTimeout(() => {
                          window.location.reload();
                      }, 500);
                  });
              }
              
              if (languageCancelBtn) {
                  languageCancelBtn.addEventListener('click', function() {
                      languageDisplay.value = originalLanguage;
                      languageEditBtn.style.display = 'flex';
                      if (languageEditActions) languageEditActions.style.display = 'none';
                  });
              }
          }
          
          // Gestionnaire pour l'édition du pays
          const countryEditBtn = document.getElementById('country-edit-btn');
          const countryEditActions = document.getElementById('country-edit-actions');
          const countrySaveBtn = document.getElementById('country-save-btn');
          const countryCancelBtn = document.getElementById('country-cancel-btn');
          const countrySelectEdit = document.getElementById('country-select-edit');
          
          if (countryEditBtn && countryDisplay) {
              let originalCountry = '';
              countryEditBtn.addEventListener('click', function() {
                  originalCountry = countryDisplay.value;
                  var currentCode = countryDisplay.dataset.countryCode || 'fr';
                  var countrySearchEl = document.getElementById('country-select-edit-search');
                  if (countrySearchEl) { countrySearchEl.value = ''; }
                  if (countrySelectEdit) {
                      countrySelectEdit.value = currentCode;
                      if (!countrySelectEdit.options.length || countrySelectEdit.options.length <= 1) {
                          if (window.COUNTRY_LIST) {
                              countrySelectEdit.innerHTML = '';
                              var lang = (localStorage.getItem('mangaWatchLanguage') || 'fr').toLowerCase();
                              window.COUNTRY_LIST.forEach(function(c) {
                                  countrySelectEdit.appendChild(new Option(c[lang] || c.fr, c.code));
                              });
                          }
                      }
                      var opts = countrySelectEdit.querySelectorAll('option');
                      opts.forEach(function(opt) { opt.style.display = ''; });
                  }
                  countryEditBtn.style.display = 'none';
                  if (countryEditActions) countryEditActions.style.display = 'flex';
              });
              
              if (countrySaveBtn && countrySelectEdit) {
                  countrySaveBtn.addEventListener('click', async function() {
                      const newCountryCode = countrySelectEdit.value;
                      var newCountryName = (typeof window.getCountryName === 'function' ? window.getCountryName(newCountryCode) : newCountryCode.toUpperCase());
                      
                      const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                      const accountIndex = accounts.findIndex(acc => acc.email === user.email);
                      if (accountIndex !== -1) {
                          accounts[accountIndex].country = newCountryCode;
                          localStorage.setItem('accounts', JSON.stringify(accounts));
                      }
                      // Synchroniser vers Firestore (pays disponible sur tous les domaines)
                      if (window.profileAccountService) {
                          try {
                              await window.profileAccountService.setProfileAccountInfo(user.email, { country: newCountryCode });
                          } catch (e) { console.error('Firestore pays:', e); }
                      }
                      
                      user.country = newCountryCode;
                      localStorage.setItem('user', JSON.stringify(user));
                      
                      countryDisplay.value = newCountryName;
                      countryDisplay.dataset.countryCode = newCountryCode;
                      countryEditBtn.style.display = 'flex';
                      if (countryEditActions) countryEditActions.style.display = 'none';
                      
                      const profileCountryText = document.getElementById('profile-country-text');
                      if (profileCountryText) {
                          profileCountryText.textContent = newCountryName;
                      }
                      
                      showToast((window.t && window.t('profile.success')) || 'Succès', (window.t && window.t('profile.country_modified_success')) || 'Pays modifié avec succès !', 'success');
                  });
              }
              
              if (countryCancelBtn) {
                  countryCancelBtn.addEventListener('click', function() {
                      countryDisplay.value = originalCountry;
                      countryEditBtn.style.display = 'flex';
                      if (countryEditActions) countryEditActions.style.display = 'none';
                  });
              }
          }
          
          if (countrySelectEdit && window.COUNTRY_LIST && (!countrySelectEdit.options.length || countrySelectEdit.options.length <= 1)) {
              var lang = (localStorage.getItem('mangaWatchLanguage') || 'fr').toLowerCase();
              countrySelectEdit.innerHTML = '<option value="" disabled data-i18n="auth.choose_country">Choisissez votre pays</option>';
              window.COUNTRY_LIST.forEach(function(c) {
                  countrySelectEdit.appendChild(new Option(c[lang] || c.fr, c.code));
              });
          }
          var countrySearchInput = document.getElementById('country-select-edit-search');
          if (countrySearchInput && countrySelectEdit) {
              countrySearchInput.addEventListener('input', function() {
                  var q = (this.value || '').toLowerCase().trim();
                  var opts = countrySelectEdit.querySelectorAll('option');
                  opts.forEach(function(opt) {
                      if (opt.value === '') { opt.style.display = ''; return; }
                      opt.style.display = (opt.textContent || '').toLowerCase().indexOf(q) >= 0 ? '' : 'none';
                  });
              });
          }
          
          // Gestionnaire pour l'édition de la description du profil
          const profileDescriptionWrapper = document.getElementById('profile-description-wrapper');
          const profileDescriptionEditBtn = document.getElementById('profile-description-edit-btn');
          const profileDescriptionDisplay = document.getElementById('profile-description-display');
          const profileDescriptionEdit = document.getElementById('profile-description-edit');
          const profileDescriptionTextarea = document.getElementById('profile-description-textarea');
          const profileDescriptionSaveBtn = document.getElementById('profile-description-save-btn');
          const profileDescriptionCancelBtn = document.getElementById('profile-description-cancel-btn');
          const profileDescriptionText = document.getElementById('profile-description-text');
          const profileDescriptionCharCount = document.getElementById('profile-description-char-count');
          
          // Charger et afficher la description du profil
          if (profileDescriptionText && profileDescriptionTextarea && profileDescriptionWrapper) {
              const savedDescription = localStorage.getItem('profile_description_' + user.email);
              if (savedDescription && savedDescription.trim() !== '') {
                  // Afficher la description si elle n'est pas vide
                  profileDescriptionText.textContent = savedDescription;
                  profileDescriptionTextarea.value = savedDescription;
                  profileDescriptionWrapper.style.display = 'block';
                  // Retirer la classe empty si elle existe
                  if (profileDescriptionDisplay) {
                      profileDescriptionDisplay.classList.remove('empty');
                  }
              } else {
                  // Afficher la description même si elle est vide, mais avec plus de transparence
                  profileDescriptionText.textContent = 'Écrivez votre description ici...';
                  profileDescriptionTextarea.value = '';
                  profileDescriptionWrapper.style.display = 'block';
                  // Ajouter la classe empty pour plus de transparence
                  if (profileDescriptionDisplay) {
                      profileDescriptionDisplay.classList.add('empty');
                  }
              }
              
              // Mettre à jour le compteur de caractères
              if (profileDescriptionCharCount) {
                  const currentLength = profileDescriptionTextarea.value.length;
                  profileDescriptionCharCount.textContent = currentLength + ' / 80';
                  if (currentLength >= 70) {
                      profileDescriptionCharCount.classList.add('error');
                      profileDescriptionCharCount.classList.remove('warning');
                  } else if (currentLength >= 60) {
                      profileDescriptionCharCount.classList.add('warning');
                      profileDescriptionCharCount.classList.remove('error');
                  } else {
                      profileDescriptionCharCount.classList.remove('warning', 'error');
                  }
              }
          }
          
          if (profileDescriptionEditBtn) {
              profileDescriptionEditBtn.addEventListener('click', function() {
                  // Afficher le wrapper si on est en mode édition
                  if (profileDescriptionWrapper) {
                      profileDescriptionWrapper.style.display = 'block';
                  }
                  if (profileDescriptionDisplay) profileDescriptionDisplay.style.display = 'none';
                  if (profileDescriptionEdit) {
                      profileDescriptionEdit.style.display = 'flex';
                      if (profileDescriptionTextarea) {
                          profileDescriptionTextarea.focus();
                          // Mettre le curseur à la fin du texte
                          const length = profileDescriptionTextarea.value.length;
                          profileDescriptionTextarea.setSelectionRange(length, length);
                      }
                  }
              });
          }
          
          // Gestionnaire pour le compteur de caractères
          if (profileDescriptionTextarea && profileDescriptionCharCount) {
              profileDescriptionTextarea.addEventListener('input', function() {
                  const currentLength = this.value.length;
                  profileDescriptionCharCount.textContent = currentLength + ' / 80';
                  
                  if (currentLength >= 70) {
                      profileDescriptionCharCount.classList.add('error');
                      profileDescriptionCharCount.classList.remove('warning');
                  } else if (currentLength >= 60) {
                      profileDescriptionCharCount.classList.add('warning');
                      profileDescriptionCharCount.classList.remove('error');
                  } else {
                      profileDescriptionCharCount.classList.remove('warning', 'error');
                  }
              });
          }
          
          // Fonction pour sauvegarder automatiquement la description
          function saveDescriptionAutomatically() {
              if (!profileDescriptionTextarea || !profileDescriptionText) return;
              
              const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
              if (!currentUser || !currentUser.email) return;
              
              const newDescription = profileDescriptionTextarea.value.trim();
              
              // Sauvegarder dans la clé dédiée
              localStorage.setItem('profile_description_' + currentUser.email, newDescription);
              
              // Sauvegarder aussi dans user
              currentUser.description = newDescription;
              localStorage.setItem('user', JSON.stringify(currentUser));
              
              // Sauvegarder dans profile_
              const profileKey = 'profile_' + currentUser.email;
              const existingProfileData = localStorage.getItem(profileKey);
              let existingProfile = {};
              if (existingProfileData) {
                  try {
                      existingProfile = JSON.parse(existingProfileData);
                  } catch (e) {
                      console.error('Erreur parsing profile:', e);
                  }
              }
              existingProfile.description = newDescription;
              existingProfile.email = currentUser.email;
              localStorage.setItem(profileKey, JSON.stringify(existingProfile));
              
              // Sauvegarder dans accounts aussi
              const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
              const accountIndex = accounts.findIndex(acc => acc.email === currentUser.email);
              if (accountIndex !== -1) {
                  accounts[accountIndex].description = newDescription;
                  localStorage.setItem('accounts', JSON.stringify(accounts));
              }
              
              // Mettre à jour l'affichage
              if (newDescription && newDescription !== '') {
                  profileDescriptionText.textContent = newDescription;
                  // Retirer la classe empty si elle existe
                  if (profileDescriptionDisplay) {
                      profileDescriptionDisplay.classList.remove('empty');
                  }
              } else {
                  profileDescriptionText.textContent = 'Écrivez votre description ici...';
                  // Ajouter la classe empty pour plus de transparence
                  if (profileDescriptionDisplay) {
                      profileDescriptionDisplay.classList.add('empty');
                  }
              }
              
              // Masquer l'éditeur et afficher la description
              if (profileDescriptionEdit) profileDescriptionEdit.style.display = 'none';
              if (profileDescriptionDisplay) profileDescriptionDisplay.style.display = 'flex';
              
              showToast('Succès', 'Description enregistrée automatiquement !', 'success');
          }
          
          // Sauvegarder automatiquement quand on sort du champ (blur)
          if (profileDescriptionTextarea) {
              profileDescriptionTextarea.addEventListener('blur', function() {
                  saveDescriptionAutomatically();
              });
              
              // Sauvegarder aussi avec la touche Escape
              profileDescriptionTextarea.addEventListener('keydown', function(e) {
                  if (e.key === 'Escape') {
                      saveDescriptionAutomatically();
                  }
              });
          }
          
          // Gestionnaire pour l'édition du mot de passe
          const passwordEditBtn = document.getElementById('password-edit-btn');
          const passwordEditActions = document.getElementById('password-edit-actions');
          const passwordSaveBtn = document.getElementById('password-save-btn');
          const passwordCancelBtn = document.getElementById('password-cancel-btn');
          const passwordNewInput = document.getElementById('password-new-input');
          const passwordConfirmInput = document.getElementById('password-confirm-input');
          
          if (passwordEditBtn) {
              passwordEditBtn.addEventListener('click', function() {
                  passwordEditBtn.style.display = 'none';
                  if (passwordEditActions) passwordEditActions.style.display = 'block';
                  if (passwordNewInput) passwordNewInput.value = '';
                  if (passwordConfirmInput) passwordConfirmInput.value = '';
              });
              
              if (passwordSaveBtn) {
                  passwordSaveBtn.addEventListener('click', function() {
                      const newPassword = passwordNewInput ? passwordNewInput.value : '';
                      const confirmPassword = passwordConfirmInput ? passwordConfirmInput.value : '';
                      
                      if (!newPassword || newPassword.length < 8) {
                          showToast('Erreur', 'Le mot de passe doit contenir au moins 8 caractères', 'error');
                          return;
                      }
                      
                      if (newPassword !== confirmPassword) {
                          showToast('Erreur', 'Les mots de passe ne correspondent pas', 'error');
                          return;
                      }
                      
                      // Mettre à jour dans les comptes
                      const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                      const accountIndex = accounts.findIndex(acc => acc.email === user.email);
                      if (accountIndex !== -1) {
                          accounts[accountIndex].password = newPassword;
                          localStorage.setItem('accounts', JSON.stringify(accounts));
                      }
                      
                      // Mettre à jour l'affichage
                      if (passwordDisplay) {
                          passwordDisplay.dataset.fullPassword = newPassword;
                          passwordDisplay.value = '••••••••••••';
                      }
                      passwordEditBtn.style.display = 'block';
                      if (passwordEditActions) passwordEditActions.style.display = 'none';
                      if (passwordNewInput) passwordNewInput.value = '';
                      if (passwordConfirmInput) passwordConfirmInput.value = '';
                      
                      showToast('Succès', 'Mot de passe modifié avec succès !', 'success');
                  });
              }
              
              if (passwordCancelBtn) {
                  passwordCancelBtn.addEventListener('click', function() {
                      passwordEditBtn.style.display = 'block';
                      if (passwordEditActions) passwordEditActions.style.display = 'none';
                      if (passwordNewInput) passwordNewInput.value = '';
                      if (passwordConfirmInput) passwordConfirmInput.value = '';
                  });
              }
          }
        } else {
          // Rediriger vers la page de connexion si non connecté
          window.location.href = 'acceuil.html';
        }
        
        // Gestionnaire de déconnexion
        if (logoutBtn) {
          logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('user');
            window.location.href = 'acceuil.html';
          });
        }
        
        // Gestionnaire de recherche
        const searchForm = document.getElementById('searchForm');
        if (searchForm) {
          searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const query = document.getElementById('searchInput').value.trim();
            if (query) {
              // Rediriger vers la page de recherche avec le terme de recherche
              window.location.href = `manga-database.html?search=${encodeURIComponent(query)}`;
            }
          });
        }
        
        // Gestion de la modification de l'avatar (déjà géré par edit-avatar-btn)
      });
      
      // Gestionnaire de réponse Google Sign-In
      function handleCredentialResponse(response) {
        const responsePayload = parseJwt(response.credential);
        
        const user = {
          name: responsePayload.name,
          email: responsePayload.email,
          picture: responsePayload.picture,
          token: response.credential
        };
        
        localStorage.setItem('user', JSON.stringify(user));
        window.location.reload();
      }
      
      // Décoder le token JWT
      function parseJwt(token) {
        try {
          const base64Url = token.split('.')[1];
          const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          }).join(''));
          return JSON.parse(jsonPayload);
        } catch (e) {
          console.error('Erreur lors du décodage du token JWT:', e);
          return null;
        }
      }
    </script>
    <!-- Synchronisation locale du profil -->
    <script src="/js/profile-sync.js"></script>
    <script src="/js/fake-users-generator.js"></script>
    <script src="/js/minorContentFilter.js"></script>
    <script src="/js/profile-anime-cards.js?v=2.0" onerror="console.error('❌ ERREUR DE CHARGEMENT DU SCRIPT profile-anime-cards.js');"></script>
    <script src="/js/search.js"></script>
    <script>
        // Vérifier immédiatement si le script s'est chargé
        console.log('🔍 Vérification IMMÉDIATE après chargement du script...');
        console.log('🔍 createStarBadges disponible:', typeof window.createStarBadges);
        console.log('🔍 displayUserAnimeNotes disponible:', typeof window.displayUserAnimeNotes);
        
        // Attendre que le script profile-anime-cards.js soit chargé
        window.addEventListener('load', function() {
            console.log('📦 Scripts chargés, vérification des fonctions...');
            console.log('🔍 createStarBadges disponible:', typeof window.createStarBadges);
            console.log('🔍 displayUserAnimeNotes disponible:', typeof window.displayUserAnimeNotes);
            
            // Exposer les fonctions globalement si elles ne le sont pas déjà
            if (typeof createStarBadges === 'undefined' && typeof window.createStarBadges === 'function') {
                window.createStarBadges = window.createStarBadges;
            }
            if (typeof displayUserAnimeNotes === 'undefined' && typeof window.displayUserAnimeNotes === 'function') {
                window.displayUserAnimeNotes = window.displayUserAnimeNotes;
            }
        });
        
        // Appelle la mise à jour des paginations après affichage des cartes
        document.addEventListener('DOMContentLoaded', function() {
            // Si la fonction existe (définie dans profile-anime-cards.js), on l'appelle
            if (typeof updateAllStarPaginations === "function") {
                setTimeout(updateAllStarPaginations, 100);
            }
        });
    </script>
    <!-- script.js désactivé - ancien système de recherche qui créait des résultats en décalé (Death Note) -->
    <!-- <script src="/js/script.js"></script> -->
    <script src="../js/hamburger-menu.js"></script>
    <!-- Système de messagerie -->
    <script src="/js/messaging.js" type="module"></script>
    <script src="/js/auth.js" type="module"></script>
    
    <!-- Appel direct pour tester le bouton de déconnexion -->
    <script>
        // Attendre que tout soit chargé et appeler setupLogoutHandler
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (typeof window.setupLogoutHandler === 'function') {
                    window.setupLogoutHandler();
                }
            }, 1000);
        });
    </script>
    <script>
        // Fonction de test pour vérifier que l'email n'apparaît plus
        window.testProfileEmail = function() {
            const userEmailElement = document.getElementById('user-email');
            const userNameElement = document.getElementById('user-name');
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            
            console.log('=== Test Profil Email ===');
            console.log('Élément email trouvé:', !!userEmailElement);
            console.log('Élément nom trouvé:', !!userNameElement);
            console.log('Nom affiché:', userNameElement ? userNameElement.textContent : 'Non trouvé');
            console.log('Utilisateur connecté:', !!user);
            
            if (user) {
                console.log('Données utilisateur:', {
                    name: user.name,
                    email: user.email
                });
            }
        };

    </script>
    <script>
        // Ajout : Animation d'affichage/masquage des genres pour le bouton "Trier par genre" du profil
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('toggleGenresBtn-profile');
            const genreCards = document.getElementById('genreCards-profile');
            const toggleIcon = document.getElementById('toggleGenresIcon-profile');
            if (toggleBtn && genreCards) {
                // Initial state: grille masquée, hauteur 0, margin 0
                genreCards.style.display = 'flex';
                genreCards.style.flexWrap = 'wrap';
                genreCards.style.gap = '8px';
                genreCards.style.overflow = 'hidden';
                genreCards.style.maxHeight = '0';
                genreCards.style.marginBottom = '0';
                genreCards.style.transition = 'max-height 0.35s cubic-bezier(.4,2,.6,1), margin-bottom 0.35s cubic-bezier(.4,2,.6,1)';
                let genresOpen = false;
                toggleBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    genresOpen = !genresOpen;
                    if (genresOpen) {
                        genreCards.style.maxHeight = '120px'; // Ajuste selon le nombre de genres
                        genreCards.style.marginBottom = '32px';
                        if (toggleIcon) toggleIcon.style.transform = 'rotate(180deg)';
                    } else {
                        genreCards.style.maxHeight = '0';
                        genreCards.style.marginBottom = '0';
                        if (toggleIcon) toggleIcon.style.transform = 'rotate(0deg)';
                    }
                });
                toggleBtn.style.cursor = 'pointer';
            }
        });
    </script>
    
    <!-- Footer unifié MangaWatch -->
    <footer class="footer-unified">
        <div class="footer-container">
            <!-- Copyright à gauche -->
            <div class="footer-copyright-text">
                <span class="footer-copyright" data-i18n="footer.copyright">&copy;</span>2025
                <span data-i18n="footer.all_rights_reserved">Tous droits réservés</span> &bull; <span class="footer-brand">MangaWatch</span>
                <a href="https://www.msf.fr/donner-palestine" target="_blank" rel="noopener" title="Faire un don pour la Palestine - Médecins Sans Frontières" class="palestine-flag-link" style="margin-left: 15px; display: inline-block;">
                    <svg width="32" height="22" viewBox="0 0 32 22" class="palestine-flag" style="border-radius: 3px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4); transition: transform 0.2s ease; cursor: pointer;">
                        <!-- Triangle rouge à gauche -->
                        <polygon points="0,0 0,22 11,11" fill="#E4312b"/>
                        <!-- Bande noire en haut -->
                        <rect x="11" y="0" width="21" height="7.33" fill="#000000"/>
                        <!-- Bande blanche au milieu -->
                        <rect x="11" y="7.33" width="21" height="7.34" fill="#FFFFFF"/>
                        <!-- Bande verte en bas -->
                        <rect x="11" y="14.67" width="21" height="7.33" fill="#149954"/>
                    </svg>
                </a>
            </div>
            
            <!-- Réseaux sociaux au centre -->
            <div class="footer-social-links">
                <a href="https://discord.gg/aG8fYmC9" target="_blank" rel="noopener" class="footer-social-icon">
                    <i class="fab fa-discord"></i>
                </a>
                <a href="https://instagram.com/mangawatchofficial" target="_blank" rel="noopener" class="footer-social-icon">
                    <i class="fab fa-instagram"></i>
                </a>
                <a href="https://tiktok.com/@mangawatchofficial" target="_blank" rel="noopener" class="footer-social-icon">
                    <i class="fab fa-tiktok"></i>
                </a>
                <a href="#help-ticket" class="footer-social-icon footer-help-link" title="Aide - Signaler un problème" data-help-ticket><i class="fas fa-circle-question"></i></a>
            </div>
            
            <!-- Pseudos à droite -->
            <div class="footer-authors">
                Made by <a href="user-profile.html?pseudo=katty-perry" class="footer-brand" style="color:inherit;text-decoration:none;">matazziz</a>
            </div>
        </div>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (window.localization && typeof window.localization.applyLanguage === 'function') {
                window.localization.applyLanguage();
            }
            // Réafficher le badge pays dans la nouvelle langue après changement de langue
            document.addEventListener('translationsApplied', function() {
                var profileCountryText = document.getElementById('profile-country-text');
                if (!profileCountryText) return;
                var user = JSON.parse(localStorage.getItem('user') || 'null');
                var accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                var account = user && user.email ? accounts.find(function(acc) { return acc.email === user.email; }) : null;
                var countryCode = (account && account.country) || (user && user.country) || '';
                if (!countryCode && ((account && account.continent) || (user && user.continent))) {
                    var continentToCountry = { 'europe': 'fr', 'amerique-nord': 'us', 'amerique-sud': 'br', 'afrique': 'other', 'asie': 'jp', 'oceanie': 'au', 'antartique': 'other', 'antarctique': 'other', 'amerique': 'us' };
                    countryCode = continentToCountry[((account && account.continent) || (user && user.continent) || '').toString().toLowerCase().replace(/\s+/g, '-')] || '';
                }
                if (countryCode && typeof window.getCountryName === 'function') {
                    profileCountryText.textContent = window.getCountryName(countryCode);
                } else if (countryCode) {
                    profileCountryText.textContent = countryCode.toUpperCase();
                } else {
                    profileCountryText.textContent = (window.t && window.t('profile.not_set')) || 'Non renseigné';
                }
            });
            // Traduire les synopsis des cartes profil une fois qu'elles sont rendues (chargement asynchrone)
            setTimeout(function() {
                if (typeof window.translateSynopses === 'function') {
                    var lang = localStorage.getItem('mangaWatchLanguage') || 'fr';
                    window.translateSynopses(lang);
                }
            }, 1800);
        });
    </script>
    <script src="/js/help-ticket.js"></script>
</body>
</html>
